<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.92.2" />
<link rel="canonical" type="text/html" href="/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>ESA Restlight | ESA Restlight</title>
<meta name="description" content="ESA Restlight is a lightweight and rest-oriented web framework, which supports annotations of SpringMVC and JAX-RS.
">
<meta property="og:title" content="ESA Restlight" />
<meta property="og:description" content="ESA Restlight is a lightweight and rest-oriented web framework, which supports annotations of SpringMVC and JAX-RS.
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/" /><meta property="og:site_name" content="ESA Restlight" />

<meta itemprop="name" content="ESA Restlight">
<meta itemprop="description" content="ESA Restlight is a lightweight and rest-oriented web framework, which supports annotations of SpringMVC and JAX-RS.
"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ESA Restlight"/>
<meta name="twitter:description" content="ESA Restlight is a lightweight and rest-oriented web framework, which supports annotations of SpringMVC and JAX-RS.
"/>




<link rel="preload" href="/scss/main.min.d6e0d5abc6f6a3c1d53dbb7d3961f4afa416f54a6cd0393408d9a241c4e351fa.css" as="style">
<link href="/scss/main.min.d6e0d5abc6f6a3c1d53dbb7d3961f4afa416f54a6cd0393408d9a241c4e351fa.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg id="layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 180 180" style="enable-background:new 0 0 180 180"><style>.st0{fill-rule:evenodd;clip-rule:evenodd;fill:#fff}.st1{opacity:.6;fill-rule:evenodd;clip-rule:evenodd;fill:#fff;enable-background:new}.st2{opacity:.3;fill-rule:evenodd;clip-rule:evenodd;fill:#fff;enable-background:new}</style><g><path class="st0" d="M127.6 95.9c-11-2.2-23.9-3.5-37.7-3.5-13.9.0-26.8 1.2-37.7 3.5 11 2.2 23.9 3.5 37.7 3.5S116.7 98 127.6 95.9zM135.8 97.8c-12.7 3.2-28.6 5.2-45.9 5.2s-33.3-2-45.9-5.2c-2.1.5-4.1 1.1-5.9 1.7-6.5 2.2-11.6 4.7-14.9 7.3-3.3 2.6-4.4 4.9-4.4 6.8s1.1 4.2 4.4 6.8 8.4 5.2 14.9 7.3c13.1 4.3 31.5 7 51.8 7s38.7-2.7 51.8-7c6.5-2.2 11.6-4.7 14.9-7.3s4.4-4.9 4.4-6.8-1.1-4.2-4.4-6.8-8.4-5.2-14.9-7.3C139.9 98.9 137.9 98.3 135.8 97.8z"/><path class="st1" d="M120.9 59.2C111.5 57.7 101 57 89.8 57c-11.1.0-21.7.9-31.1 2.2 9.4 1.5 19.9 2.2 31.1 2.2C101 61.5 111.5 60.7 120.9 59.2zm10 1.8c-11.8 2.6-25.9 4.1-41 4.1-15.2.0-29.2-1.5-41-4.1-3.9.9-7.5 1.9-10.9 3-6.5 2.2-11.6 4.7-14.9 7.3-3.3 2.6-4.4 4.9-4.4 6.8s1.1 4.2 4.4 6.8c3.3 2.6 8.4 5.2 14.9 7.3 13.1 4.3 31.5 7 51.8 7s38.7-2.7 51.8-7c6.5-2.2 11.6-4.7 14.9-7.3s4.4-4.9 4.4-6.8-1.1-4.2-4.4-6.8-8.4-5.2-14.9-7.3C138.4 63 134.8 62 130.9 61z"/><path class="st2" d="M161.1 40.3c0 1.9-1.1 4.2-4.4 6.8-3.3 2.6-8.4 5.2-14.9 7.3-13.1 4.3-31.5 7-51.8 7s-38.7-2.7-51.8-7c-6.5-2.2-11.6-4.7-14.9-7.3s-4.4-4.9-4.4-6.8 1.1-4.2 4.4-6.8 8.4-5.2 14.9-7.3c13.1-4.3 31.5-7 51.8-7s38.7 2.7 51.8 7c6.5 2.2 11.6 4.7 14.9 7.3S161.1 38.5 161.1 40.3z"/></g></svg></span><span class="font-weight-bold">ESA Restlight</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/docs/" ><i class='fas fa-book pr-2'></i><span>Docs</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/blog/" ><i class='fas fa-rss pr-2'></i><span>Blog</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://github.com/esastack/esa-restlight" target="_blank" ><i class='fab fa-github pr-2'></i><span>Github</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://www.esastack.io" target="_blank" ><span>ESA Stack</span></a>
			</li>
			





			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">ESA Restlight</h1>
<div class="lead">ESA Restlight is a lightweight and rest-oriented web framework, which supports annotations of SpringMVC and JAX-RS.</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-0d7696d24c78e212b3f7477df55bfbb6">Getting Started</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-31bc0d9a3f9c6fcad90863cf851f2a50">Architecture</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-d9df2e2df52b49baaf72778cdddd7560">线程模型</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-e0fe7cf949afe48d034911e871e97660">Restlight Starter</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-c6aa8ed6af6ef375dd529ead4f9cca8c">Thread-Scheduling</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-72cde9e9f6520682a45a68478c63e442">Filter</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-abe1b969b7c2a7e5316ed26baa01b5e8">拦截器</a></li>


    
  
    
    
	
<li>4.4: <a href="#pg-c228fb93ca30d57dd5fa1784526870b6">异常处理</a></li>


    
  
    
    
	
<li>4.5: <a href="#pg-02fe6ae2e2cb1bd391a8d1f94b6f074f">参数解析</a></li>


    
  
    
    
	
<li>4.6: <a href="#pg-b829d4ec0f73cadb35480000a7c4610b">ArgumentResolverAdvice</a></li>


    
  
    
    
	
<li>4.7: <a href="#pg-6e3e405efde7e8a1cc12b5ecf9ad744a">返回值解析</a></li>


    
  
    
    
	
<li>4.8: <a href="#pg-51a9f99bcae2f8ac7e16471cc1779bac">ReturnValueResolverAdvice</a></li>


    
  
    
    
	
<li>4.9: <a href="#pg-73e10d9bdafbed062d04a7ae327d2229">序列化</a></li>


    
  
    
    
	
<li>4.10: <a href="#pg-f98524641db12d9f69bc3a63ee6f4649">请求参数聚合</a></li>


    
  
    
    
	
<li>4.11: <a href="#pg-15adb1f15406c89ddc0f504afb67714b">URL参数聚合</a></li>


    
  
    
    
	
<li>4.12: <a href="#pg-8491f86999f6b7591eee11761502c1a0">Context Path</a></li>


    
  
    
    
	
<li>4.13: <a href="#pg-2d62b7aa8e1eca9bf6a0801bc5f14074">Aware扩展</a></li>


    
  
    
    
	
<li>4.14: <a href="#pg-96c4371ff98f8a260892c1b9f27ee09b">路由缓存</a></li>


    
  
    
    
	
<li>4.15: <a href="#pg-4b2ddfd87c9683a4228d4a7f607fad08">快速失败</a></li>


    
  
    
    
	
<li>4.16: <a href="#pg-00806bebd264f4ab6a8752deb8fde3f3">Mock测试</a></li>


    
  
    
    
	
<li>4.17: <a href="#pg-8bbf607bf55ab234484ca9e6f4ca15c4">辅助配置</a></li>


    
  
    
    
	
<li>4.18: <a href="#pg-b2dc3803615c85a9c04d46f40ac36997">配置一览</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-ade7eba81490dc10670fdec8495f5aa2">扩展能力</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-565e90f031add052259807c8bd2afe76">新建连接数限制</a></li>


    
  
    
    
	
<li>5.2: <a href="#pg-2c62ed94d1fc1376101e882daea64604">CPU Load保护</a></li>


    
  
    
    
	
<li>5.3: <a href="#pg-7d39489b3769120a91d18d02e839cd61">Access Log</a></li>


    
  
    
    
	
<li>5.4: <a href="#pg-263ce0837051e5d3ff7c6fa617a3b818">跨域</a></li>


    
  
    
    
	
<li>5.5: <a href="#pg-7e5633cdbac5b3f1ddc6d0ffd2b54aef">文件及表单参数解析</a></li>


    
  
    
    
	
<li>5.6: <a href="#pg-30b8e819f78dc39f2d491e31f4e40af8">签名认证</a></li>


    
  
    
    
	
<li>5.7: <a href="#pg-d942ecd2ec2d2eb4b01636561f9861b7">XSS过滤</a></li>


    
  
    
    
	
<li>5.8: <a href="#pg-5244fafd526f119d0232178cd1dbc931">IP白名单</a></li>


    
  
    
    
	
<li>5.9: <a href="#pg-ef42401d76c218bc23a80a78d7b6f80a">数据校验</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-a6ade1feee01c58451c20389bf1bcf06">Spring Boot Actuator支持</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-627f660f98fff1e8f313a11640ecedd7">Restlight Endpoint扩展</a></li>


    
  
    
    
	
<li>6.2: <a href="#pg-ace0d32cd342464828692279735398cb">自定义Endpoint</a></li>


    
  
    
    
	
<li>6.3: <a href="#pg-6529bcb6d5f02db7dbd50c08714ba8fd">使用独立端口</a></li>


    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-059954cb572a468efbd896cacfc5535a">Spring MVC 支持</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-b5c4403c41b916a6a8fec933ee64a2be">Spring MVC 注解支持</a></li>


    
  
    
    
	
<li>7.2: <a href="#pg-b82730f3e0626640346a00cd35e672dd">ExceptionHandler支持</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-51578747ba64e4682c4eb004e2455bcb">JAX-RS 支持</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.1: <a href="#pg-1f76cd6f9a69602d8084fa71cdc12d89">JAX-RS 注解支持</a></li>


    
  

    </ul>
    
  
    
    
	
<li>9: <a href="#pg-8974072c9131f7cb3574b326a1775aa7">Restlight Server</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>9.1: <a href="#pg-5c20dfad36c9a3e32cf52bbfeabc4b7c">Quick Start</a></li>


    
  
    
    
	
<li>9.2: <a href="#pg-59e9b53c0526b840ef96ad105b9938d6">术语</a></li>


    
  
    
    
	
<li>9.3: <a href="#pg-da94c7033d9aed7cdc97d0c04a53642a">请求处理</a></li>


    
  

    </ul>
    
  
    
    
	
<li>10: <a href="#pg-2fba84197e93865c2b955be1ea5d578d">Restlight Core</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.1: <a href="#pg-ff50837446697282f95741f162ffbb69">配合 JAX-RS标准</a></li>


    
  
    
    
	
<li>10.2: <a href="#pg-931ecc71f9fd4e756da8447114ff66c6">配合 SpringMVC标准</a></li>


    
  

    </ul>
    
  
    
    
	
<li>11: <a href="#pg-ee5784dcfab2e0323bad9468055e1922">Restlight for Spring</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>11.1: <a href="#pg-799b06429c88ee149a863c616483aa23">Quick Start</a></li>


    
  

    </ul>
    
  
    
    
	
<li>12: <a href="#pg-1ec1d9d90a306bd6c3db563eb4b68466">全链路异步</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>12.1: <a href="#pg-8286989c9c6f7a25228e264e138b0adf">Restlight 异步保证</a></li>


    
  
    
    
	
<li>12.2: <a href="#pg-90151b09924b0376f5d61f29b762a7fb">CompletableFuture使用注意</a></li>


    
  

    </ul>
    
  
    
    
	
<li>13: <a href="#pg-5e5b9f61f0f7f7fb8ed94c8171f3d4c3">使用注意</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>13.1: <a href="#pg-613abba4559bbdeed69f0ef4359da516">Controller 语义不能重复</a></li>


    
  
    
    
	
<li>13.2: <a href="#pg-284e4996350ddb637239358989d135ad">大文件上传</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      <h2 id="why-restlight">Why Restlight?</h2>
<p>In microservices, it is generally expected that service is a lightweight application, and the Spring-Web framework we often use is really a good framework that allows us to develop a variety of applications easily, but it is too bloated for applications in microservices, which just need a rest supports and do not need the session, ModelAndview, JSP and so on&hellip; Restlight aims to serve as a web framework that helps users to build a high performance and lightweight microservice.</p>
<h2 id="what-kind-of-web-application-is-restlight-suitable-for">What kind of web application is Restlight suitable for?</h2>
<ul>
<li>Rest application</li>
<li>High-performance requirements</li>
<li>Middleware</li>
<li>HTTP proxy</li>
<li>Any application that needs HTTP services</li>
</ul>
<h2 id="what-kind-of-web-application-is-restlight-not-suitable-for">What kind of web application is Restlight not suitable for?</h2>
<ul>
<li>All in one application</li>
<li>Servlet requirements: Restlight does not support servlet standards</li>
</ul>
<h2 id="env-requirements">Env Requirements</h2>
<table>
<thead>
<tr>
<th>Name</th>
<th>Version</th>
</tr>
</thead>
<tbody>
<tr>
<td>Java</td>
<td>JDK8+</td>
</tr>
<tr>
<td>Spring Boot</td>
<td>2.1.0.RELEASE+</td>
</tr>
<tr>
<td>Netty</td>
<td>4.1.52.Final+</td>
</tr>
<tr>
<td>Tcnative</td>
<td>2.0.34.Final+ and matches with Netty</td>
</tr>
</tbody>
</table>
<h2 id="features">Features</h2>
<ul>
<li>Annotations of SpringMVC and JAX-RS supports</li>
<li>High performance</li>
<li>Reactive：<code>CompletableFuture</code>、<code>ListenableFuture(Guava)</code>.</li>
<li>Threading-model: Flexible scheduling between IO EventLoopGroup and Biz Schedulers.</li>
<li>Http1/Http2/H2c/Https</li>
<li>HAProxy</li>
<li>Filter</li>
<li>Interceptor</li>
<li>JSR-303: hibernate-validator</li>
<li>Self-protection: Connection creation limit, Cpu Load protection</li>
<li>more &hellip;</li>
</ul>
<h2 id="release-notes">Release Notes</h2>
<p><a href="https://github.com/esastack/esa-restlight/releases">Releases</a></p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0d7696d24c78e212b3f7477df55bfbb6">1 - Getting Started</h1>
    <div class="lead">It&rsquo;s very easy to get started with <code>Restlight</code>!</div>
	<p>Create a Spring Boot application and add dependency</p>
<blockquote>
<p><strong>Note：<code>netty</code> 4.1.56.Final and <code>tcnative</code> 2.0.35.Final are directly dependent on.</strong></p>
</blockquote>
<blockquote>
<p><strong>Note: Please make sure the version of <code>tcnative</code> matches the version of <code>netty</code>.</strong></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-starter<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${mvn.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><p>Write your Controller</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RestController</span>
<span style="color:#5c35cc;font-weight:bold">@SpringBootApplication</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RestlightDemoApplication</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/hello&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">hello</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Hello Restlight!&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">main</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">SpringApplication</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">run</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RestlightDemoApplication</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>Run your application and then you would see something like</p>
<pre tabindex="0"><code>Started Restlight server in 1265 millis on 0.0.0.0:8080
</code></pre><p>curl http://localhost:8080/hello</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-31bc0d9a3f9c6fcad90863cf851f2a50">2 - Architecture</h1>
    
	<h2 id="设计原则">设计原则</h2>
<ul>
<li>高兼容性</li>
<li>极致性能</li>
<li>全链路异步</li>
<li>易用</li>
<li>可扩展</li>
</ul>
<h2 id="功能架构">功能架构</h2>
<p><strong>分层架构设计</strong></p>
<p><img src="../../img/architecture.png" alt="Architecture"></p>
<p>架构图中<code>ESA HttpServer</code>, <code>Restlight Server</code>, <code>Restlight Core</code>, <code>Restlight for Spring</code>, <code>Restlight Starter</code>几个模块均可作为一个独立的模块使用， 满足不同场景下的需求。</p>
<h3 id="esa-httpserver">ESA HttpServer</h3>
<p>基于<code>Netty</code> 实现的一个简易的<a href="https://github.com/esastack/esa-httpserver">HttpServer</a>， 支持Http1.1/Http2以及Https等</p>
<h3 id="restlight-server">Restlight Server</h3>
<p>在<code>ESA HttpServer</code>基础之上封装了</p>
<ul>
<li>引入业务线程池</li>
<li><code>Filter</code></li>
<li>请求路由（根据url, method, header等条件将请求路由到对应的Handler）</li>
<li>基于<code>CompletableFuture</code>的响应式编程支持</li>
<li>线程调度</li>
<li>&hellip;</li>
</ul>
<h4 id="对应启动入口类esarestlightserverrestlite">对应启动入口类<code>esa.restlight.server.Restlite</code></h4>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    适合各类框架，中间件等基础组建中启动或期望使用代码显示启动HttpServer的场景

</div>

<h3 id="restlight-core">Restlight Core</h3>
<p>在<code>Restlight Server</code>之上， 扩展支持了<code>Controller</code>方式（在<code>Controller</code>类中通过诸如<code>@RequestMappng</code>等注解的方式构造请求处理逻辑）完成业务逻辑以及诸多常用功能</p>
<ul>
<li><code>HandlerInterceptor</code>: 拦截器</li>
<li><code>ExceptionHandler</code>: 全局异常处理器</li>
<li><code>BeanValidation</code>: 参数校验</li>
<li><code>ArgumentResolver</code>: 参数解析扩展</li>
<li><code>ReturnValueResolver</code>: 返回值解析扩展</li>
<li><code>RequestSerializer</code>: 请求序列化器（通常负责反序列化Body内容）</li>
<li><code>ResposneSerializer</code>: 响应序列化器（通常负责序列化响应对象到Body）</li>
<li>内置<code>Jackson</code>, <code>Fastjson</code>, <code>Gson</code>, <code>ProtoBuf</code>序列化支持</li>
<li>&hellip;</li>
</ul>
<h4 id="对应启动入口类esarestlightcorerestlight">对应启动入口类<code>esa.restlight.core.Restlight</code></h4>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    适合各类框架，中间件等基础组建中启动或期望使用代码显示启动HttpServer的场景

</div>

<h3 id="restlight-springmvc--restlight-jax-rs">Restlight SpringMVC &amp; Restlight JAX-RS</h3>
<ul>
<li>
<p><code>Restlight SpringMVC</code>对<code>SpringMVC</code>中的注解使用习惯的<code>Restlight Core</code>的扩展实现（<code>@RequestMapping</code>, <code>@RequestParam</code>等）。</p>
</li>
<li>
<p><code>Restlight JAX-RS</code>对<code>JAX-RS</code>中的注解使用习惯的<code>Restlight Core</code>的扩展实现（<code>@Path</code>, <code>@GET</code>, <code>@QueryParam</code>等）。</p>
</li>
</ul>
<h3 id="restlight-for-spring">Restlight for Spring</h3>
<p>在<code>Restlight Core</code>基础上支持在<code>Spring</code>场景下通过<code>ApplicationContext</code>容器自动配置各种内容（<code>RestlightOptions</code>, 从容器中自动配置<code>Filter</code>, <code>Controller</code>, <code>ControllerAdvice</code>等）</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    适合<code>Spring Boot</code>场景

</div>

<h3 id="restlight-starter">Restlight Starter</h3>
<p>在<code>Restlight for Spring</code>基础上支持在<code>Spring Boot</code>场景的自动配置</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    适合<code>Spring Boot</code>场景

</div>

<h3 id="restlight-actuator">Restlight Actuator</h3>
<p>在<code>Restlight Starter</code>基础上支持在<code>Spring Boot Actuator</code>原生各种<code>Endpoint</code>s支持以及<code>Restlight</code>独有的<code>Endpoint</code>s。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    适合<code>Spring Boot Actuator</code>场景

</div>


</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d9df2e2df52b49baaf72778cdddd7560">3 - 线程模型</h1>
    
	<p><img src="../../img/threading_model.png" alt="ThreadingModel"></p>
<p><code>Restlight</code>由于是使用<code>Netty</code>作为底层HttpServer的实现，因此图中沿用了部分<code>EventLoop</code>的概念，线程模型由了<code>Acceptor</code>，<code>IO EventLoopGroup</code>（IO线程池）以及<code>Biz ThreadPool</code>（业务线程池）组成。</p>
<ul>
<li><code>Acceptor</code>： 由1个线程组成的线程池， 负责监听本地端口并分发IO 事件。</li>
<li><code>IO EventLoopGroup</code>： 由多个线程组成，负责读写IO数据(对应图中的<code>read()</code>和<code>write()</code>)以及HTTP协议的编解码和分发到业务线程池的工作。</li>
<li><code>Biz Scheduler</code>：负责执行真正的业务逻辑（大多为Controller中的业务处理，拦截器等）。</li>
<li><code>Custom Scheduler</code>: 自定义线程池</li>
</ul>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    通过第三个线程池<code>Biz Scheduler</code>的加入完成IO操作与实际业务操作的异步（同时可通过Restlight的线程调度功能随意调度）

</div>


</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e0fe7cf949afe48d034911e871e97660">4 - Restlight Starter</h1>
    <div class="lead"><code>Restlight Starter</code>在<code>Restlight Spring</code> 基础上封装的<code>Spring Boot Starter</code>提供基于<code>Spring Boot</code>的自动配置</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-c6aa8ed6af6ef375dd529ead4f9cca8c">4.1 - Thread-Scheduling</h1>
    
	<p><img src="../../../img/threading_model.png" alt="ThreadingModel"></p>
<p>线程调度允许用户根据需要随意制定<code>Controller</code>在<code>IO</code>线程上执行还是在<code>Biz</code>线程上执行还是在自定义线程上运行。</p>
<h2 id="使用scheduled注解进行线程调度">使用<code>@Scheduled</code>注解进行线程调度</h2>
<p>eg.</p>
<p>在<code>IO</code>线程上执行</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Scheduled</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Schedulers</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">IO</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">io</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ....
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>在<code>BIz</code>线程上执行</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// 在业务线程池中执行
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Scheduled</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Schedulers</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">BIZ</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/bar&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">biz</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ....
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>不加注解默认Scheduler上执行</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/baz&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">bizBatching</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ....
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="自定义scheduler">自定义<code>Scheduler</code></h2>
<p>将<code>Scheduler</code>实现注入<code>Spring</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Scheduler</span> <span style="color:#000">scheduler</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Schedulers</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">fromExecutor</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Executors</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">newCachedThreadPool</span><span style="color:#ce5c00;font-weight:bold">());</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>在自定义<code>Scheduler</code>上执行</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// 在业务线程池中执行
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Scheduled</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ....
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    <ul>
<li>自定义<code>Scheduler</code>时请勿使用<code>IO</code>, <code>BIZ</code>, <code>Restlight</code>等作为name（作为<code>Restlight</code>中<code>Scheduler</code>的保留字)</li>
<li>定义线程池建议使用<code>RestlightThreadFactory</code>以获得更高的性能</li>
</ul>


</div>



<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    基于<code>ThreadPoolExecutor</code>类型自定义<code>Scheduler</code>时， 不管是否设置<code>RejectExecutionHandler</code>，<code>Restlight</code>都会覆盖<code>ThreadPoolExecutor</code>中的<code>RejectExecutionHandler</code>， 即不允许用户自定义实现<code>RejectExecutionHandler</code>实现拒绝策略（因为<code>Restlight</code>需要保证每个请求都能被正确的完成，否则可能会导致链接等资源无法被释放等问题）， 相反如果自定义实现<code>Scheduler</code>时请保证每个请求都被正确的完成。

</div>

<h2 id="配置">配置</h2>
<p>所有配置均以<code>restlight.server.scheduling</code>开头</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>默认</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>default-scheduler</td>
<td>BIZ</td>
<td>在不加<code>@Scheduled</code>注解时采用的Scheduler</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-72cde9e9f6520682a45a68478c63e442">4.2 - Filter</h1>
    
	<h2 id="基本使用">基本使用</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Filter</span> <span style="color:#000">addHeaderFilter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Filter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Void</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">doFilter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">FilterChain</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setHeader</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">doFilter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>上面的例子将会给所有到来的请求都加上一个固定的Header。</p>
<h2 id="异步filter">异步<code>Filter</code></h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Filter</span> <span style="color:#000">filter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Filter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Void</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">doFilter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">FilterChain</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">runAsync</span><span style="color:#ce5c00;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#8f5902;font-style:italic">// do something...
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#ce5c00;font-weight:bold">}).</span><span style="color:#c4a000">thenCompose</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#8f5902;font-style:italic">// invoke next filter
</span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">doFilter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#ce5c00;font-weight:bold">});</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>上面的例子演示了在<code>doFilter(xxx)</code>中进行异步操作，并在该操作完成后回调<code>FilterChain</code>继续执行后续操作。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    上面演示的异步只是开了一个新的线程， 实际场景中可使用<code>Netty</code>等实现更优雅的异步方式。

</div>

<h2 id="终止filter的执行">终止<code>Filter</code>的执行</h2>
<p>当不期望执行后续的<code>Filter</code>时可返回一个<code>CompletableFuture.completedFuture(null)</code>实例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Override</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Void</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">doFilter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">FilterChain</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">completedFuture</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    <ul>
<li><code>doFilter(xxx)</code>请勿返回<code>null</code></li>
<li>所有方法都将会在IO线程上调用，尽量不要阻塞， 否则将对性能会有较大的影响。</li>
</ul>


</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-abe1b969b7c2a7e5316ed26baa01b5e8">4.3 - 拦截器</h1>
    
	<p><code>Restlight</code>支持多种拦截器，适用于不同性能/功能场景</p>
<ul>
<li>RouteInterceptor</li>
<li>MappingInterceptor</li>
<li>HandlerInterceptor</li>
<li>InterceptorFactory</li>
</ul>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    实现对应的拦截器接口并注入Spring即可

</div>



<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    在Interceptor#preHandle0()和Interceptor#postHandle0()中直接通过throw抛出的异常将不会被
异常处理器处理，如果需要被正常处理，请使用CompletableFuture.completeExceptionally()封装异常

</div>

<h2 id="拦截器定位">拦截器定位</h2>
<p>面向<code>Controller/Route</code>， 同时支持按需匹配的拦截器</p>
<ol>
<li><strong>面向<code>Controller/Route</code></strong>: 拦截器一定能让用户根据需求选择匹配到哪个<code>Controller</code>接口</li>
<li><strong>按需匹配</strong>： 支持按照<code>AsyncRequest</code>条件让用户灵活决定拦截器的匹配规则</li>
</ol>
<h2 id="internalinterceptor"><code>InternalInterceptor</code></h2>
<p>核心拦截器实现， 封装了拦截器核心行为</p>
<ul>
<li>
<p><code>CompletableFuture&lt;Boolean&gt; preHandle0(AsyncRequest, AsyncResponse, Object)</code></p>
<p><code>Controller</code>执行前执行。返回布尔值表示是否允许当前请求继续往下执行。</p>
</li>
<li>
<p><code>CompletableFuture&lt;Void&gt; postHandle0(AsyncRequest, AsyncResponse, Object)</code></p>
<p><code>Controller</code>刚执行完之后执行</p>
</li>
<li>
<p><code>CompletableFuture&lt;Void&gt; afterCompletion0(AsyncRequest, AsyncResponse, Exception)</code></p>
<p>请求行完之后执行</p>
</li>
<li>
<p><code>int getOrder()</code></p>
<p>返回当前拦截器的优先级（默认为最低优先级），我们保证<code>getOrder</code>返回值决定拦截器的执行顺序，但是不支持使用<code>@Order(int)</code>注解情况下的顺序（虽然有时候看似顺序和<code>@Order</code>一致，但那只是巧合）。</p>
</li>
</ul>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <ul>
<li>框架在真正执行拦截器调用的时候只会调用上述方法(而不是<code>preHandle(xxx)</code>, <code>postHandle(xxx)</code>, <code>afterCompletion(xxx)</code>)</li>
<li>请勿直接使用此接口，此接口仅仅是拦截器的核心实现类</li>
</ul>


</div>

<h2 id="拦截器匹配">拦截器匹配</h2>
<p><strong>初始化阶段</strong>： 初始化阶段为每一个<code>Controller</code>确定所有可能匹配到当前<code>Controller</code>的拦截器列表（包含可能匹配以及一定会匹配到当前<code>Controller</code>的拦截器）。</p>
<p><strong>运行时阶段</strong>： 一个请求<code>AsyncRequest</code>到来时将通过将<code>AsyncRequest</code>作为参数传递到拦截器做路由判定， 决定是否匹配。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    通过初始化与运行时两个阶段的匹配行为扩展满足用户多样性匹配需求， 用户既可以直接将拦截器绑定到固定的<code>Controller</code>也可以让拦截器随心所欲的根据请求去选择匹配。

</div>

<h3 id="affinity亲和性"><code>Affinity</code>亲和性</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">Affinity</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Current component is always attaching with the target subject.
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ATTACHED</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Current component has a high affinity with the target subject this is the highest value.
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">HIGHEST</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Current component has no affinity with the target subject.
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">DETACHED</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Gets the affinity value.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @return affinity.
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">affinity</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>用于表达拦截器与<code>Controller/Route</code>之间的亲和性</p>
<ul>
<li><code>affinity()</code>小于0表示拦截器<strong>不可能</strong>与<code>Controller</code>匹配</li>
<li><code>affinity()</code>等于0表示拦截器<strong>一定</strong>会与<code>Controller</code>匹配</li>
<li><code>affinity()</code>大于0表示拦截器<strong>可能</strong>会与<code>Controller</code>匹配， 并且值越小匹配可能性越高（因此1为最高可能性）， 相反值越大匹配可能性越小， 同时匹配的开销越大（用于拦截器匹配性能优化）。</li>
</ul>
<h3 id="interceptorpredicate"><code>InterceptorPredicate</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">InterceptorPredicate</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">RequestPredicate</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">InterceptorPredicate</span> <span style="color:#000">ALWAYS</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">Boolean</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">TRUE</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RequestPredicate</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Predicate</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">AsyncRequest</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ignore this
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">mayAmbiguousWith</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestPredicate</span> <span style="color:#000">another</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>test(AsyncRequest)</code>方法用于对每个请求的匹配。可以满足根据<code>AsyncRequest</code>运行时的任意条件的匹配（而不仅仅是局限于<code>URL</code>匹配）</p>
<h2 id="interceptor"><code>Interceptor</code></h2>
<p><code>Interceptor</code>接口为同时拥有<code>Affinity</code>（<code>Controller/Route</code>匹配）以及<code>InterceptorPredicate</code>（请求<code>AsyncRequest</code>匹配）的接口</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">Interceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">InternalInterceptor</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Affinity</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Gets the predicate of current interceptor. determines whether current interceptor should be matched to a {@link
</span><span style="color:#8f5902;font-style:italic">     * esa.httpserver.core.AsyncRequest}.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @return predicate, or {@code null} if {@link #affinity()} return&#39;s a negative value.
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">InterceptorPredicate</span> <span style="color:#000">predicate</span><span style="color:#ce5c00;font-weight:bold">();</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Default to highest affinity.
</span><span style="color:#8f5902;font-style:italic">     * &lt;p&gt;
</span><span style="color:#8f5902;font-style:italic">     * Whether a {@link Interceptor} should be matched to a {@link esa.restlight.server.route.Route} is depends on it.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @return affinity
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">affinity</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>由于<code>int affinity()</code>根据不同的<code>Controller/Route</code>可能得出不同的结果， 因此需要使用<code>InterceptorFactory</code>进行创建</p>
<p>eg.</p>
<p>实现一个拦截器， 拦截所有GET接口（仅包含GET）且Header中包含<code>X-Foo</code>请求头的请求</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">InterceptorFactory</span> <span style="color:#000">interceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">route</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Interceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Boolean</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">preHandle0</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                     <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                     <span style="color:#000">Object</span> <span style="color:#000">handler</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">completedFuture</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>


        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">InterceptorPredicate</span> <span style="color:#000">predicate</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">containsHeader</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;X-Foo&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">affinity</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#000">HttpMethod</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">route</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">mapping</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">method</span><span style="color:#ce5c00;font-weight:bold">();</span>
            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">length</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">HttpMethod</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">GET</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ATTACHED</span><span style="color:#ce5c00;font-weight:bold">;</span>
            <span style="color:#ce5c00;font-weight:bold">}</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">DETACHED</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    运行时仅在<code>request.containsHeader(&quot;X-Foo&quot;)</code>上做匹配， 性能损耗极低。

</div>

<h2 id="routeinterceptor"><code>RouteInterceptor</code></h2>
<p>只绑定到固定的<code>Controller/Route</code>的拦截器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RouteInterceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">InternalInterceptor</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Gets the affinity value between current interceptor and the given {@link Route}.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param ctx   context
</span><span style="color:#8f5902;font-style:italic">     * @param route route to match
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @return affinity value.
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">match</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">DeployContext</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">RestlightOptions</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Route</span> <span style="color:#000">route</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    运行时无性能损耗， 用于需要将拦截器固定的绑定到<code>Controller</code>的场景， 这里的<code>boolean match(xx)</code>方法返回的<code>true</code>和<code>false</code>实际上相当于<code>Affinity</code>接口返回<code>Affinity.ATTACHED</code>以及<code>Affinity.DETACHED</code>（即只有一定匹配和一定不匹配）

</div>

<p>eg.
实现一个拦截器， 拦截所有GET请求（仅包含GET）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">RouteInterceptor</span> <span style="color:#000">interceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RouteInterceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Boolean</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">preHandle0</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                     <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                     <span style="color:#000">Object</span> <span style="color:#000">handler</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">completedFuture</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">match</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">DeployContext</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">RestlightOptions</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Route</span> <span style="color:#000">route</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#000">HttpMethod</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">route</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">mapping</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">method</span><span style="color:#ce5c00;font-weight:bold">();</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">length</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">HttpMethod</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">GET</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="mappinginterceptor"><code>MappingInterceptor</code></h2>
<p>绑定到所有<code>Controller/Route</code>， 并匹配请求的拦截器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">MappingInterceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">InternalInterceptor</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">InterceptorPredicate</span> <span style="color:#ce5c00;font-weight:bold">{</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>相当于<code>affinity()</code>固定返回<code>Affinity.ATTACHED</code></p>
<p>eg.</p>
<p>实现一个拦截器， 拦截所有Header中包含<code>X-Foo</code>请求头的请求</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">MappingInterceptor</span> <span style="color:#000">interceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">MappingInterceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Boolean</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">preHandle0</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                     <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                     <span style="color:#000">Object</span> <span style="color:#000">handler</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">completedFuture</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">test</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">containsHeader</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;X-Foo&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="handlerinterceptor"><code>HandlerInterceptor</code></h2>
<p>支持基于<code>URI</code>匹配的拦截器接口</p>
<ul>
<li><code>includes()</code>: 指定拦截器作用范围的Path， 默认作用于所有请求。</li>
<li><code>excludes()</code>: 指定拦截器排除的Path（优先级高于<code>includes</code>）默认为空。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">HandlerInterceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">InternalInterceptor</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#000">String</span> <span style="color:#000">PATTERN_FOR_ALL</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/**&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">includes</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">excludes</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    涉及到正则匹配， 会有较大性能损失， 且仅支持URI匹配。

</div>

<p>eg.</p>
<p>实现一个拦截器， 拦截除<code>/foo/bar</code>意外所有<code>/foo/</code>开头的请求</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HandlerInterceptor</span> <span style="color:#000">interceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">HandlerInterceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Boolean</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">preHandle0</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                     <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                     <span style="color:#000">Object</span> <span style="color:#000">handler</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">completedFuture</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">includes</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;/foo/**&#34;</span><span style="color:#ce5c00;font-weight:bold">};</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">excludes</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;/foo/bar&#34;</span><span style="color:#ce5c00;font-weight:bold">};</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="interceptorfactory"><code>InterceptorFactory</code></h2>
<p>拦截器工厂类， 用于为每一个<code>Controller/Route</code>生成一个<code>Interceptor</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">InterceptorFactory</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Create an instance of {@link Interceptor} for given target handler before starting Restlight server..
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param ctx deploy context
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param route target route.
</span><span style="color:#8f5902;font-style:italic">     * @return interceptor
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">Optional</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Interceptor</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">create</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">DeployContext</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">RestlightOptions</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Route</span> <span style="color:#000">route</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c228fb93ca30d57dd5fa1784526870b6">4.4 - 异常处理</h1>
    
	<h2 id="spring-mvc异常处理">Spring MVC异常处理</h2>
<p><a href="../../springmvc_support/">Restlight for Spring MVC</a>支持使用Spring MVC中的<code>@ExceptionHandler</code>, <code>@ControllerAdvice</code>等注解，并且对此能力进行了增强
参考<a href="../../springmvc_support/exception_handler">ExceptionHandler支持</a></p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    仅在项目引入了<code>restlight-springmvc-provider</code>依赖的情况下使用（默认引入）

</div>

<h2 id="exceptionresolver"><code>ExceptionResolver</code></h2>
<p>eg.</p>
<p>处理<code>RuntimeException</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Component</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">GlobalExceptionResolver</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">ExceptionResolver</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">RuntimeException</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    
    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Void</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">handleException</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                   <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                   <span style="color:#000">RuntimeException</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// handle exception here
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">completedFuture</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    处理不同异常类型实现不同的<code>ExceptionResolver&lt;T extends Throwable&gt;</code>

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-02fe6ae2e2cb1bd391a8d1f94b6f074f">4.5 - 参数解析</h1>
    <div class="lead">参数解析指将从请求中解析出<code>Controller</code>参数值的过程（包含反序列化）</div>
	<p>典型的有</p>
<ul>
<li><code>@RequestParam</code></li>
<li><code>@RequestHeader</code></li>
<li><code>@RequestBody</code></li>
<li><code>@PathVariable</code></li>
<li><code>@CookieValue</code></li>
<li><code>@MatrixVariable</code></li>
<li><code>@QueryBean</code></li>
<li><code>AsyncRequest</code></li>
<li><code>AsyncResponse</code></li>
</ul>
<h2 id="接口定义">接口定义</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ArgumentResolver</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 从AsyncRequest中解析出对应参数的值
</span><span style="color:#8f5902;font-style:italic">     * 解析后的Object必须能和Param类型匹配
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">Object</span> <span style="color:#000">resolve</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span><span style="color:#ce5c00;font-weight:bold">;</span>
    
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>框架会在启动的初始化阶段试图为每一个Controller中的每一个参数都找到一个与之匹配的<code>ArgumentResolver</code>用于请求的参数解析。</p>
<h2 id="框架如何确定argumentresolver">框架如何确定<code>ArgumentResolver</code></h2>
<h3 id="argumentresolveradapter"><code>ArgumentResolverAdapter</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ArgumentResolverPredicate</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 判断当前ArgumentResolver是否支持给定Param解析
</span><span style="color:#8f5902;font-style:italic">     * Controller中的每个参数都对应一个Param实例， 
</span><span style="color:#8f5902;font-style:italic">     * 可以通过Param获取注解等各类反射相关的元数据信息
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">);</span>

<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ArgumentResolverAdapter</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ArgumentResolverPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ArgumentResolver</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>初始化逻辑：</p>
<ol>
<li>按照<code>getOrder()</code>方法的返回将Spring容器中所有的<code>ArgumentResolver</code>进行排序</li>
<li>按照排序后的顺序依次调用<code>supports(Param param)</code>方法， 返回<code>true</code>则将其作为该参数的<code>ArgumentResolver</code>， 运行时每次请求都将调用<code>resolve(AsyncRequest request, AsyncResponse response)</code>方法进行参数解析， 并且运行时不会改变。</li>
<li>未找到则启动报错。</li>
</ol>
<p>细心的人可能会发现该设计可能并不能覆盖到以下场景</p>
<ul>
<li>因为<code>resolve(AsyncRequest request, AsyncResponse response)</code>方法参数中并没有传递<code>Param参数</code>， 虽然初始化阶段能根据<code>supports(Param param)</code>方法获取参数元数据信息（获取某个注解， 获取参数类型等等）判断是否支持， 但是如果运行时也需要获取参数的元数据信息（某个注解的值等）的话，此接口则无法满足需求。</li>
<li>假如<code>ArgumentResolver</code>实现中需要做序列化操作， 因此期望获取到Spring容器中的序列化器时，则该接口无法支持（例如<code>@RequestBody</code>的场景）。</li>
</ul>
<p>针对以上问题， 答案是确实无法支持。因为<code>Restlight</code>的设计理念是</p>
<ul>
<li><code>能在初始化阶段解决的问题就在初始化阶段解决</code></li>
</ul>
<p>因此不期望用户以及<code>Restlight</code>的开发人员大量的在运行时去频繁获取一些JVM启动后就不会变动的内容(如： 注解的值)， 甚至针对某些元数据信息使用<code>ConcurrentHashMap</code>进行缓存（看似是为了提高性能的缓存， 实际上初始化就固定了的内容反而增加了并发性能的损耗）。</p>
<p>基于以上原因我们提供了另一个<code>ArgumentResolver</code>的实现方式</p>
<h3 id="argumentresolverfactory"><code>ArgumentResolverFactory</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ArgumentResolverFactory</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ArgumentResolverPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#000">ArgumentResolver</span> <span style="color:#000">createResolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                    <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">HttpRequestSerializer</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">serializers</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>与上面的<code>ArgumentResolver</code>类似</p>
<p>初始化逻辑：</p>
<ol>
<li>按照<code>getOrder()</code>方法的返回将所有的<code>ArgumentResolverFactory</code>进行排序</li>
<li>按照排序后的顺序依次调用<code>supports(Param param)</code>方法， 返回<code>true</code>则将其作为该参数的<code>ArgumentResolverFactory</code>， 同时调用<code>createResolver(Param param, List&lt;? extends HttpRequestSerializer&gt; serializers)</code>方法创建出对应的<code>ArgumentResolver</code></li>
<li>未找到则启动报错。</li>
</ol>
<p>由于初始化时通过<code>createResolver(Param param, List&lt;? extends HttpRequestSerializer&gt; serializers)</code>方法传入了<code>Param</code>以及序列化器， 因此能满足上面的要求。</p>
<p><strong>两种模式的定位</strong></p>
<ul>
<li><code>ArgumentResolver</code>： 适用于参数解析器不依赖方法元数据信息以及序列化的场景。例如： 如果参数上使用了@XXX注解则返回某个固定的值。</li>
<li><code>ArgumentResolverFactory</code>： 适用于参数解析器依赖方法元数据信息以及序列化的场景。例如： <code>@RequestBody</code>， <code>@RequestParameter(name = &quot;foo&quot;)</code>。</li>
</ul>
<h2 id="自定义参数解析器">自定义参数解析器</h2>
<p>将自定义实现的<code>ArgumentResolverAdapter</code>或者<code>ArgumentResolverFactory</code>注入到Spring容器即可。</p>
<ul>
<li><code>ArgumentResolverAdapter</code>案例</li>
</ul>
<p>场景： 当参数上有<code>@AppId</code>注解时， 使用固定的AppId</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// 自定义注解
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Target</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ElementType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">PARAMETER</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Retention</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RetentionPolicy</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">RUNTIME</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Documented</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#5c35cc;font-weight:bold">@interface</span> <span style="color:#000">AppId</span> <span style="color:#ce5c00;font-weight:bold">{</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">ArgumentResolverAdapter</span> <span style="color:#000">resolver</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ArgumentResolverAdapter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// 当方法上有此注解时生效
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasParameterAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AppId</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
 
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Object</span> <span style="color:#000">resolve</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;your appid&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>controller使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@AppId</span> <span style="color:#000">String</span> <span style="color:#000">appId</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">appId</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div><p>上面的代码自定义实现了依据自定义注解获取固定appId的功能</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    自定义<code>ArgumentResolverAdapter</code>比框架自带的优先级高（如<code>@RequestHeader</code>，<code>@RequestParam</code>等）， 如果匹配上了自定义实现，框架默认的功能在当前参数上将不生效。

</div>

<ul>
<li><code>ArgumentResolverFactory</code></li>
</ul>
<p>场景： 通过自定义注解获取固定前缀x-custom的Header</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// 自定义注解
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Target</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ElementType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">PARAMETER</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Retention</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RetentionPolicy</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">RUNTIME</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Documented</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#5c35cc;font-weight:bold">@interface</span> <span style="color:#000">CustomHeader</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">String</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">ArgumentResolverFactory</span> <span style="color:#000">resolver</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ArgumentResolverFactory</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// 当方法上有此注解时生效
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasParameterAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">CustomHeader</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#000">ArgumentResolver</span> <span style="color:#000">createResolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                        <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">HttpRequestSerializer</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">serializers</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Resolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * 实际ArgumentResolver实现
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Resolver</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">ArgumentResolver</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">String</span> <span style="color:#000">headerName</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Resolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">CustomHeader</span> <span style="color:#000">anno</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getParameterAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">CustomHeader</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">anno</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">value</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">length</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">IllegalArgumentException</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Name of header must not be empty.&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#8f5902;font-style:italic">// 初始化时组装好需要的参数
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">headerName</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;x-custom&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">anno</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">value</span><span style="color:#ce5c00;font-weight:bold">();</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Object</span> <span style="color:#000">resolve</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// 运行时直接获取Header
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getHeader</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">headerName</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>controller使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@CustomHeader</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    自定义<code>ArgumentResolverFactory</code>比框架自带的优先级高（如<code>@RequestHeader</code>，<code>@RequestParam</code>等）， 如果匹配上了自定义实现，框架默认的功能在当前参数上将不生效。

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b829d4ec0f73cadb35480000a7c4610b">4.6 - ArgumentResolverAdvice</h1>
    
	<p><code>ArgumentResolverAdvice</code>允许用户在<code>ArgumentResolver</code>参数解析器解析参数的前后添加业务逻辑以及修改解析后的参数。</p>
<h2 id="接口定义">接口定义</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ArgumentResolverAdvice</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 在ArgumentResolver.resolve()之前被调用
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">beforeResolve</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 在ArgumentResolver.resolve()之后被调用， 并使用此方法的返回值作为参数绑定到对应的Controller参数上
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">Object</span> <span style="color:#000">afterResolved</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Object</span> <span style="color:#000">arg</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="自定义argumentresolveradvice">自定义<code>ArgumentResolverAdvice</code></h2>
<p>与<code>ArgumentResovler</code>相同， <code>ArgumentResolverAdvice</code>自定应时同样需要实现<code>ArgumentResolverAdviceAdapter</code>或<code>ArgumentResolverAdviceFactory</code>接口</p>
<h3 id="方式1实现-argumentresolveradviceadapter">方式1：实现 <code>ArgumentResolverAdviceAdapter</code></h3>
<p>接口定义</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ArgumentResolverAdviceAdapter</span>
        <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ArgumentResolverPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ArgumentResolverAdvice</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">beforeResolve</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">Object</span> <span style="color:#000">afterResolved</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Object</span> <span style="color:#000">arg</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">arg</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h3 id="方式2实现argumentresolveradvicefactory">方式2：实现<code>ArgumentResolverAdviceFactory</code></h3>
<p>接口定义</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ArgumentResolverAdviceFactory</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ArgumentResolverPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 生成ArgumentResolverAdvice
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">ArgumentResolverAdvice</span> <span style="color:#000">createResolverAdvice</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ArgumentResolver</span> <span style="color:#000">resolver</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>ArgumentResolverAdviceAdapter</code>接口以及<code>ArgumentResolverAdviceFactory</code>接口与<code>ArgumentResolver</code>中的<code>ArgumentResolverAdapter</code>接口以及<code>ArgumentResolverFactory</code>接口的使用方式相同， 这里不过多赘述。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <code>ArgumentResolverAdvice</code>与<code>ArgumentResolver</code>生命周期是相同的, 即应用初始化的时候便会决定每个参数的<code>ArgumentResolverAdvice</code>

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6e3e405efde7e8a1cc12b5ecf9ad744a">4.7 - 返回值解析</h1>
    <div class="lead">返回值解析指将<code>Controller</code>返回值写入到<code>AsyncResponse</code>中的过程（包含序列化）</div>
	<h2 id="返回值解析逻辑">返回值解析逻辑</h2>
<p>Restlight默认支持的返回值解析方式包括</p>
<ul>
<li><code>@ResponseBody</code></li>
<li><code>@ResponseStatus</code></li>
<li>普通类型(String, byte[], int 等)</li>
</ul>
<p>与参数解析类似， 每个功能都对应了一个返回值解析器的实现。</p>
<h2 id="接口定义"><strong>接口定义</strong></h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ReturnValueResolver</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 解析出对应返回值为byte[]
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">resolve</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Object</span> <span style="color:#000">returnValue</span><span style="color:#ce5c00;font-weight:bold">,</span>
                   <span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span>
                   <span style="color:#000">AsyncReponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>框架会在启动的初始化阶段试图为每一个Controller中的每一个参数都找到一个与之匹配的<code>ReturnValueResolver</code>用于响应的返回值解析。</p>
<h2 id="框架如何确定returnvalueresolver">框架如何确定<code>ReturnValueResolver</code></h2>
<h3 id="returnvalueresolveradapter"><code>ReturnValueResolverAdapter</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ReturnValueResolverPredicate</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 判断当前ReturnValueResolver是否支持给定InvocableMethod解析
</span><span style="color:#8f5902;font-style:italic">     * 每一个Controller都对应一个InvocableMethod实例， 
</span><span style="color:#8f5902;font-style:italic">     * 可以通过InvocableMethod获取注解, 返回值类型等各类反射相关的元数据信息
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">InvocableMethod</span> <span style="color:#000">invocableMethod</span><span style="color:#ce5c00;font-weight:bold">);</span>

<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ReturnValueResolverAdapter</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ReturnValueResolverPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ReturnValueResolver</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>初始化逻辑：</p>
<ol>
<li>按照<code>getOrder()</code>方法的返回将Srping容器中所有的<code>ReturnValueResolverAdapter</code>进行排序</li>
<li>按照排序后的顺序依次调用<code>supports(InvocableMethod invocableMethod)</code>方法， 返回<code>true</code>则将其作为该参数的<code>ReturnValueResolver</code>， 运行时每次请求都将调用<code>resolve(Object returnValue, AsyncRequest request, AsyncReponse response)</code>方法进行参数解析， 并且运行时不会改变。</li>
<li>未找到则启动报错。</li>
</ol>
<p>细心的人可能会发现该设计可能并不能覆盖到以下场景</p>
<ul>
<li>因为<code>resolve(Object returnValue, AsyncRequest request, AsyncReponse response)</code>方法参数中并没有传递<code>InvocableMethod参数</code>， 虽然初始化阶段能根据<code>supports(InvocableMethod invocableMethod)</code>方法获取Controller方法元数据信息（获取某个注解， 获取参数类型等等）判断是否支持， 但是如果运行时也需要获取Controller方法的元数据信息（某个注解的值等）的话，此接口则无法满足需求。</li>
<li>假如<code>ReturnValueResolverAdapter</code>实现中需要做序列化操作， 因此期望获取到Spring容器中的序列化器时，则该接口无法支持（例如<code>@ResponseBody</code>的场景）。</li>
</ul>
<p>针对以上问题， 答案是确实无法支持。因为<code>Restlight</code>的设计理念是</p>
<ul>
<li><code>能在初始化阶段解决的问题就在初始化阶段解决</code></li>
</ul>
<p>因此不期望用户以及<code>Restlight</code>的开发人员大量的在运行时去频繁获取一些JVM启动后就不会变动的内容(如： 注解的值)， 甚至针对某些元数据信息使用<code>ConcurrentHashMap</code>进行缓存（看似是为了提高性能的缓存， 实际上初始化就固定了的内容反而增加了并发性能的损耗）。</p>
<p>基于以上原因我们提供了另一个<code>ReturnValueResolver</code>的实现方式</p>
<h3 id="returnvalueresolverfactory"><code>ReturnValueResolverFactory</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ReturnValueResolverFactory</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ReturnValueResolverPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#000">ReturnValueResolver</span> <span style="color:#000">createResolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">InvocableMethod</span> <span style="color:#000">invocableMethod</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                    <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">HttpResponseSerializer</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">serializers</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>与上面的<code>ReturnValueResolver</code>类似</p>
<p>初始化逻辑：</p>
<ol>
<li>按照<code>getOrder()</code>方法的返回将所有的<code>ReturnValueResolverFactory</code>进行排序</li>
<li>按照排序后的顺序依次调用<code>supports(InvocableMethod invocableMethod)</code>方法， 返回<code>true</code>则将其作为该参数的<code>ReturnValueResolverFactory</code>， 同时调用<code>createResolver(InvocableMethod invocableMethod, List&lt;? extends HttpResponseSerializer&gt; serializers)</code>方法创建出对应的<code>ReturnValueResolver</code></li>
<li>未找到则启动报错。</li>
</ol>
<p>由于初始化时通过<code>createResolver(InvocableMethod invocableMethod, List&lt;? extends HttpResponseSerializer&gt; serializers)</code>方法传入了<code>InvocableMethod</code>以及序列化器， 因此能满足上面的要求。</p>
<p><strong>两种模式的定位</strong></p>
<ul>
<li><code>ReturnValueResolver</code>： 适用于解析器不依赖方法元数据信息以及序列化的场景。例如： 如果Controller方法上上使用了@XXX注解则返回某个固定的值。</li>
<li><code>ReturnValueResolverFactory</code>： 适用于解析器依赖方法元数据信息以及序列化的场景。例如： @ResponseBody， @ResponseStatus(reason = &ldquo;error&rdquo;)。</li>
</ul>
<h2 id="自定义返回值解析器">自定义返回值解析器</h2>
<p>将自定义实现的<code>ReturnValueResolverAdapter</code>或者<code>ReturnValueResolverFactory</code>注入到Spring容器即可。</p>
<ul>
<li><code>ReturnValueResolverAdapter</code>案例</li>
</ul>
<p>场景： 当Controller方法上有<code>@AppId</code>注解时， 返回固定的AppId</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// 自定义注解
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Target</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ElementType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">METHOD</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Retention</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RetentionPolicy</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">RUNTIME</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Documented</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#5c35cc;font-weight:bold">@interface</span> <span style="color:#000">AppId</span> <span style="color:#ce5c00;font-weight:bold">{</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">ReturnValueResolverAdapter</span> <span style="color:#000">resolver</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">APP_ID</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;your appid&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getBytes</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">StandardCharsets</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">UTF_8</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ReturnValueResolverAdapter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">InvocableMethod</span> <span style="color:#000">invoicableMethod</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// 当方法上有此注解时生效
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">invoicableMethod</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasMethodAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AppId</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
 
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">resolve</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Object</span> <span style="color:#000">returnValue</span><span style="color:#ce5c00;font-weight:bold">,</span>
                   <span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span>
                   <span style="color:#000">AsyncReponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">APP_ID</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>controller使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@AppId</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div><p>上面的代码自定义实现了依据自定义注解获取固定appId的功能</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    自定义<code>ReturnValueResolverAdapter</code>比框架自带的优先级高（如<code>@ResponseBody</code>）， 如果匹配上了自定义实现，框架默认的功能在当前方法上上将不生效。

</div>

<ul>
<li><code>ReturnValueResolverFactory</code></li>
</ul>
<p>场景： 通过自定义注解对所有String类型的返回值加上一个指定前缀。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// 自定义注解
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Target</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ElementType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">METHOD</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Retention</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RetentionPolicy</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">RUNTIME</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Documented</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#5c35cc;font-weight:bold">@interface</span> <span style="color:#000">Suffix</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">String</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">ReturnValueResolverFactory</span> <span style="color:#000">resolver</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ReturnValueResolverFactory</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#5c35cc;font-weight:bold">@Override</span>
            <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">InvocableMethod</span> <span style="color:#000">invocableMethod</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#8f5902;font-style:italic">// 当方法上有此注解时生效
</span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">equals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">invocableMethod</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getMethod</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">getReturnType</span><span style="color:#ce5c00;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">parameter</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasMethodAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">CustomHeader</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#ce5c00;font-weight:bold">}</span>
            
            <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">ReturnValueResolver</span> <span style="color:#000">createResolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">InvocableMethod</span> <span style="color:#000">invocableMethod</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                      <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">HttpResponseSerializer</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">serializers</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Resovler</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">invocableMethod</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#ce5c00;font-weight:bold">}</span>
            
        <span style="color:#ce5c00;font-weight:bold">};</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 实际ArgumentResolver实现
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Resolver</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">ReturnValueResolver</span> <span style="color:#ce5c00;font-weight:bold">{</span>

        <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">String</span> <span style="color:#000">suffix</span><span style="color:#ce5c00;font-weight:bold">;</span>

        <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Resolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">InvocableMethod</span> <span style="color:#000">invocableMethod</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// 获取前缀
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">Suffix</span> <span style="color:#000">anno</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">invocableMethod</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getMethodAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Suffix</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">suffix</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">anno</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">value</span><span style="color:#ce5c00;font-weight:bold">();</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">resolve</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Object</span> <span style="color:#000">returnValue</span><span style="color:#ce5c00;font-weight:bold">,</span>
                   <span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span>
                   <span style="color:#000">AsyncReponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// 拼接
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">suffix</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">valueOf</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">returnValue</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>controller使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Suffix</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    自定义<code>ReturnValueResolverFactory</code>比框架自带的优先级高（如<code>@ResponseBody</code>）， 如果匹配上了自定义实现，框架默认的功能在当前方法上上将不生效。

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-51a9f99bcae2f8ac7e16471cc1779bac">4.8 - ReturnValueResolverAdvice</h1>
    <div class="lead"><code>ReturnValueResolverAdvice</code>允许用户在<code>ReturnValueResolver</code>参数解析器解析参数的前后添加业务逻辑以及修改解析后的参数。</div>
	<h2 id="接口定义">接口定义</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ReturnValueResolverAdvice</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 使用此方法的返回值作为ReturnValueResolver.resolve()的参数调用
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">Object</span> <span style="color:#000">beforeResolve</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Object</span> <span style="color:#000">returnValue</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="自定义returnvalueresolveradvice">自定义<code>ReturnValueResolverAdvice</code></h2>
<p>与<code>ArgumentResovler</code>相同， <code>ReturnValueResolverAdvice</code>自定应时同样需要实现<code>ReturnValueResolverAdviceAdapter</code>或<code>ReturnValueResolverAdviceFactory</code>接口</p>
<h3 id="方式1-实现returnvalueresolveradviceadapter">方式1 实现<code>ReturnValueResolverAdviceAdapter</code></h3>
<p>接口定义</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ReturnValueResolverAdviceAdapter</span>
        <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ReturnValueResolverPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ReturnValueResolverAdvice</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">Object</span> <span style="color:#000">beforeResolve</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Object</span> <span style="color:#000">returnValue</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">returnValue</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h3 id="方式2实现returnvalueresolveradvicefactory">方式2：实现<code>ReturnValueResolverAdviceFactory</code></h3>
<p>接口定义</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ReturnValueResolverAdviceFactory</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ReturnValueResolverPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 生成ReturnValueResolverAdvice
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">ReturnValueResolverAdvice</span> <span style="color:#000">createResolverAdvice</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">InvocableMethod</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ReturnValueResolver</span> <span style="color:#000">resolver</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>ReturnValueResolverAdviceAdapter</code>接口以及<code>ReturnValueResolverAdviceFactory</code>接口与<code>ReturnValueResolver</code>中的<code>ReturnValueResolverAdapter</code>接口以及<code>ReturnValueResolverFactory</code>接口的使用方式相同， 这里不过多赘述。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <code>ReturnValueResolverAdvice</code>与<code>ReturnValueResolver</code>生命周期是相同的, 即应用初始化的时候便会决定每个参数的<code>ReturnValueResolverAdvice</code>

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-73e10d9bdafbed062d04a7ae327d2229">4.9 - 序列化</h1>
    
	<p>序列化支持</p>
<ul>
<li>jackson(默认)</li>
<li>fastjson</li>
<li>Gson</li>
<li>ProtoBuf</li>
<li>自定义支持</li>
</ul>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    其中Json相关的序列化方式默认配置了日期格式为<code>yyyy-MM-dd HH:mm:ss</code>

</div>

<h2 id="序列化切换">序列化切换</h2>
<p>默认使用Jackson序列化，因此Restlight也默认引入了Jackson依赖，如果想要切换成别的序列化方式，则需要引入对应的Maven依赖并进行简单的配置。</p>
<p>Example：以切换Gson为例</p>
<ol>
<li>引入Gson依赖：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
     <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>com.google.code.gson<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
     <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>gson<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
     <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>2.8.5<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><ol start="2">
<li>注入Gson序列化器</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HttpBodySerializer</span> <span style="color:#000">bodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">GsonHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>完成切换。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    如果不想继续引入默认的Jackson依赖可以使用<code>&lt;exclusions/&gt;</code>标签排除， 同时一旦注入了自定义的序列化器原来默认的Jackson序列化器将不会再生效

</div>

<h2 id="序列化器">序列化器</h2>
<p><strong>接口标准定义</strong></p>
<ul>
<li><code>HttpRequestSerializer</code>： 用于请求的反序列化。</li>
<li><code>HttpResponseSerializer</code>： 用于响应的序列化。</li>
<li><code>HttpBodySerializer</code>： 继承自<code>HttpRequestSerializer</code>以及<code>HttpResponseSerializer</code>, 可同时提供请求与响应的序列化功能。</li>
</ul>
<p><strong>内置的序列化器</strong></p>
<ul>
<li><code>FastJsonHttpBodySerializer</code></li>
<li><code>JacksonHttpBodySerializer</code></li>
<li><code>GsonHttpBodySerializer</code></li>
<li><code>ProtoBufHttpBodySerializer</code></li>
</ul>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    切换时引入Maven依赖并注入对应的序列化器即可

</div>

<h2 id="定制序列化器">定制序列化器</h2>
<p>可以选择通过继承或者自定义实现<code>HttpRequestSerializer</code>以及<code>HttpResponseSerializer</code>接口（或者<code>HttpResponseSerializer</code>同理）的方式实现定制序列化。</p>
<p>如，在上面的例子中我们切换序列化方式为jackson，此时我们想定制序列化的日期格式为<code>yyyy-MM-dd</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HttpBodySerializer</span> <span style="color:#000">bodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">ObjectMapper</span> <span style="color:#000">objectMapper</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ObjectMapper</span><span style="color:#ce5c00;font-weight:bold">();</span>
    <span style="color:#000">objectMapper</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setDateFormat</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">SimpleDateFormat</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;yyyy-MM-dd&#34;</span><span style="color:#ce5c00;font-weight:bold">));</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">HttpJsonBodySerializerAdapter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">JacksonSerializer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">objectMapper</span><span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">{};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>同样也可以定制更多的序列化选项。</p>
<h2 id="多个序列化器并存">多个序列化器并存</h2>
<p>Restlight并不像Spring MVC一样要求一个应用中只能使用一种序列化方式，Restlight允许多种序列化方式并存。</p>
<p>实际的服务中我们可能有这样的需求：我们对接服务A时使用的是ProtoBuf序列化，而其他情况都是使用的fastjson序列化。</p>
<p>配置如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HttpBodySerializer</span> <span style="color:#000">fastjsonBodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">FastJsonHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">();</span>
 
<span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HttpBodySerializer</span> <span style="color:#000">protoBufBodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ProtoBufHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>直接注入两个序列化器即可。</p>
<p>上面的配置当MediaType（请求对应<code>ContentType</code>, 响应对应<code>Accept</code>）为<code>application/json</code>时使用JSON序列化,  为<code>application/x-protobuf</code>时使用ProtoBuf序列化.</p>
<h2 id="兼容spring-boot标准">兼容Spring Boot标准</h2>
<p>使用Spring Boot时，经常在配置文件里面添加Jackson和Gson的配置，如：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">spring.jackson.date-format=yyyy-MM-dd HH:mm:ss
spring.gson.date-format=yyyy-MM-dd HH:mm:ss
</code></pre><p>Restlight同样支持该标准，其作用逻辑如下图所示：
<img src="../../../img/serialization_of_springboot.png" alt="序列化器兼容springboot逻辑图.png">
如图所示，配置文件中Jackson和Gson相关内容要想生效，需要满足如下条件：</p>
<blockquote>
<ol>
<li>用户没有手动定制HttpJsonBodySerializerAdapter</li>
<li>用户没有手动注入Jackson或者Gson序列化器(FastJsonHttpBodySerializer和GsonJsonHttpBodySerializer)</li>
<li>用户没有手动注入ObjectMapper或者Gson对象</li>
<li>配置文件有对Jackson和Gson进行配置</li>
</ol>
</blockquote>
<p>满足以上四个条件，配置文件中关于Jackson和Gson的配置，才会在对应的Jackson和Gson序列化器中生效。</p>
<h3 id="响应序列化内容协商json与protobuf序列化">响应序列化内容协商(Json与ProtoBuf序列化)</h3>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    前提： json和ProtoBuf的序列化器已经被正确的配置。

</div>

<p>当 json和ProtoBuf的序列化器同时存在时， 响应序列化方式可以通过url中的参数来指定。</p>
<ul>
<li>首先开启序列化协商功能：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-pro" data-lang="pro"><span style="color:#4e9a06">#</span> <span style="color:#4e9a06">开启请求序列化协商</span>
<span style="color:#4e9a06">restlight</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">serialize</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">negotiation</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">true</span>
<span style="color:#4e9a06">#</span> <span style="color:#4e9a06">开启响应序列化协商</span>
<span style="color:#4e9a06">restlight</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">serialize</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">negotiation</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">true</span>
</code></pre></div><p>指定使用json序列化</p>
<p><strong>eg</strong>:  <code>/foo/{bar}?format=json</code></p>
<p>指定使用protobuf序列化</p>
<p><strong>eg</strong>:  <code>/foo/{bar}?format=pb</code></p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    参数可选值：<code>json</code>, <code>pb</code>

</div>

<ul>
<li>当参数<code>format</code>与应用自身的某些接口中的参数冲突时可以通过配置修改参数名称</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-pro" data-lang="pro"><span style="color:#4e9a06">restlight</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">serialize</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">negotiation</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#4e9a06">param</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">your</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#4e9a06">param</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#4e9a06">name</span>
<span style="color:#4e9a06">restlight</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">serialize</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">negotiation</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#4e9a06">param</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">your</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#4e9a06">param</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#4e9a06">name</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    此种方式实际上相当于在请求的<code>Accept</code>字段中加入了<code>application/json</code>, <code>application/x-protobuf</code>值， 因此如果使用了自定义的序列化器，根据<code>HttpResponseSerializer.supportsWrite(MediaType mediaType, Type type)</code>方法实现不同可能与实际行为不符。 具体请参考下文<code>多个序列化器框架如何选择使用哪个序列化器实现</code>章节。

</div>

<h2 id="使用requestserializer指定请求序列化器">使用<code>@RequestSerializer</code>指定请求序列化器</h2>
<p>当配置了多个序列化器时， 可以使用<code>@RequestSerializer</code>中指定使用某个固定的序列化方式</p>
<p>下面的Controller指定使用Jackson反序列化请求数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@PostMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestBody</span> <span style="color:#5c35cc;font-weight:bold">@RequestSerializer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">JacksonHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">User</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    <code>@RequestSerializer</code>可以在Prameter, Method以及Class上使用， 优先级依次递减。

</div>

<h2 id="使用responseserializer指定响应序列化器">使用<code>@ResponseSerializer</code>指定响应序列化器</h2>
<p>当配置了多个序列化器时， 可以使用<code>@ResponseSerializer</code>中指定使用某个固定的序列化方式</p>
<p>下面的Controller指定使用Jackson序列化响应结果</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@PostMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@ResponseSerializer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">JacksonHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Foo</span> <span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Foo</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    <code>@ResponseSerializer</code>可以在Method以及Class上使用， 优先级依次递减。

</div>

<h2 id="使用serializer指定请求--响应序列化器">使用<code>@Serializer</code>指定请求 &amp; 响应序列化器</h2>
<p>当配置了多个序列化器时， 可以使用<code>@Serializer</code>中指定使用某个固定的序列化方式， 相当于同时指定<code>RequestSerializer</code>以及<code>@ResponseSerializer</code>。</p>
<p>下面的Controller指定使用Jackson序列化</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@PostMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Serializer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">JacksonHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Foo</span> <span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestBody</span> <span style="color:#000">User</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Foo</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    <code>@ResponseSerializer</code>可以在Method以及Class上使用， 优先级依次递减。

</div>

<h2 id="多个序列化器框架如何选择使用哪个序列化器实现">多个序列化器框架如何选择使用哪个序列化器实现？</h2>
<p>序列化器接口<code>HttpRequestSerializer</code>， <code>HttpResponseSerializer</code>中均定义了<code>suppot(xxx)</code>方法， 用于在多个序列化器并存的情况下判断使用哪一个序列化器。以<code>HttpRequestSerializer</code>为例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">HttpRequestSerializer</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">BaseHttpSerializer</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">RxSerializer</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    
    <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supportsRead</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MediaType</span> <span style="color:#000">mediaType</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">);</span>
    
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>HttpRequestSerializer</code>中定义了<code>supportsRead(MediaType mediaType, Type type)</code>方法用于判断当前序列化器是否支持此次请求的序列化， 其中参数<code>MediaType</code>为请求的<code>ContentType</code>， <code>Type</code>为当前反序列化的目标类型。</p>
<p>同样<code>HttpResponseSerializer</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">HttpResponseSerializer</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">BaseHttpSerializer</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">TxSerializer</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supportsWrite</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MediaType</span> <span style="color:#000">mediaType</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#000">Object</span> <span style="color:#000">customResponse</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Object</span> <span style="color:#000">returnValue</span><span style="color:#ce5c00;font-weight:bold">);</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><ul>
<li><code>supportsWrite(MediaType mediaType, Type type)</code>方法用于判断当前序列化器是否支持此次请求的序列化， 其中参数<code>MediaType</code>为请求的<code>Accept</code>字段中的值， <code>Type</code>为当序列化的原始类型。</li>
<li><code>customResponse(xxx)</code>将会在实际调用序列化之前被调用， 并使用返回值的Object作为此次序列化的原始对象（也就是说允许用户在响应的序列化之前更改响应的对象）</li>
</ul>
<p>同时， 序列化器实现本身具有优先级由<code>getOrder()</code>表示(值越低优先级越高)</p>
<p>当最终无法找到匹配的序列化器时， 会通过默认的优先级进行序列化（暂时仅响应序列化为此行为）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HttpBodySerializer</span> <span style="color:#000">fastjsonBodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">FastJsonHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
       <span style="color:#5c35cc;font-weight:bold">@Override</span>
       <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
           <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">;</span>
       <span style="color:#ce5c00;font-weight:bold">}</span>
   <span style="color:#ce5c00;font-weight:bold">};</span>
 
<span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HttpBodySerializer</span> <span style="color:#000">protoBufBodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ProtoBufHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
   
</code></pre></div><h2 id="多种序列化并存时的优先级">多种序列化并存时的优先级</h2>
<ul>
<li>请求序列化</li>
</ul>
<ol>
<li>如果指定了<code>@RequestSerializer</code>或者<code>@Serializer</code>中指定的序列化方式则使用该序列化方式</li>
<li>使用序列化协商中的参数指定的序列化器</li>
<li>根据<code>ContentType</code>查找序列化器</li>
<li>未找到则报错</li>
</ol>
<ul>
<li>响应序列化</li>
</ul>
<ol>
<li>如果指定了<code>@ResponseSerializer</code>或者<code>@Serializer</code>中指定的序列化方式则使用该序列化方式</li>
<li>使用序列化协商中的参数指定的序列化器</li>
<li>根据<code>Accept</code>查找序列化器</li>
<li>根据<code>RequestMapping</code>中produces指定的序列化器（未找到进入6）</li>
<li>未找到使用默认优先级最高的序列化器</li>
</ol>
<h2 id="protobuf序列化支持">ProtoBuf序列化支持</h2>
<p>Restlight内置了ProtoBuf序列化器的实现，对应支持的MediaType为<code>application/x-protobuf</code>(需要请求的<code>Content-Type</code>为<code>application/x-protobuf</code></p>
<p>同时使用ProtoBuf序列化器序列化后的响应结果的<code>Content-Type</code>也为<code>application/x-protobuf</code>)。</p>
<p>针对ProtoBuf序列化的特点，ProtoBuf序列化后还将增加Header， <code>X-Protobuf-Schema</code>和<code>X-Protobuf-Message</code>分别返回Message对象的<code>getDescriptorForType().getFile().getName()</code>和<code>getDescriptorForType().getFullName</code>的结果。</p>
<h2 id="特殊类型返回值的序列化">特殊类型返回值的序列化</h2>
<p>不管Controller上是否加有<code>@ResponseBody</code>注解， 在使用序列化器序列化之前都将遵守以下原则</p>
<blockquote>
<ul>
<li>值为String类型直接返回该字符串结果。</li>
<li>值为byte[]类型直接将结果写入响应。</li>
<li>值为ByteBuf类型时直接将结果写入响应</li>
<li>以上均不符合则使用序列化器进行序列化。</li>
<li>如果Controlelr上未配置<code>@ResponseBody</code>，值为基本类型或基本类型包装类将返回该类型的字符串结果（调用String.valueOf()）。</li>
<li>以上均不符合则抛异常。</li>
</ul>
</blockquote>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f98524641db12d9f69bc3a63ee6f4649">4.10 - 请求参数聚合</h1>
    <div class="lead">支持将请求的参数聚合到Bean中</div>
	<p>eg.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/test&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestBean</span> <span style="color:#000">Pojo</span> <span style="color:#000">Pojo</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Pojo</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@QueryParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@HeaderParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">String</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getId</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">//getter &amp; setter
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    由于<code>SpringMVC</code>的注解大多不支持在<code>Field</code>上使用， 因此仅支持<code>JAX-RS</code>注解以及自定义参数解析等场景。

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-15adb1f15406c89ddc0f504afb67714b">4.11 - URL参数聚合</h1>
    <div class="lead">支持将Url中的参数与Form表单中的参数（仅当<code>Content-Type</code>为<code>application/x-www-form-urlencoded</code>时有效）聚合到Bean中。</div>
	<p>eg：</p>
<p>请求 <code>/test?id=1&amp;msg=hello</code> 中的id和message的值将绑定到pojo参数中</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/test&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">handle</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@QueryBean</span> <span style="color:#000">Pojo</span> <span style="color:#000">Pojo</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Pojo</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@QueryBean.Name</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;msg&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">String</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getId</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">//getter &amp; setter
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    加了@QueryBean.Name(&ldquo;name&rdquo;)之后将使用提供的name作为参数名进行匹配， 原来的字段名字将不会使用

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8491f86999f6b7591eee11761502c1a0">4.12 - Context Path</h1>
    
	<p>Restlight支持全局Path，使用时需要做如下配置：</p>
<pre tabindex="0"><code class="language-profile" data-lang="profile">restlight.server.context-path=/global-path/
</code></pre><p>原始Controller方法为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Controller</span>
<span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/restlight/employee/&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">EmployeeController</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/list&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#5c35cc;font-weight:bold">@ResponseBody</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Employee</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">listAll</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Employee</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">employeeList</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ArrayList</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;(</span><span style="color:#000">16</span><span style="color:#ce5c00;font-weight:bold">);</span>

        <span style="color:#000">employeeList</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Employee</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;LiMing&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">25</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;1403063&#34;</span><span style="color:#ce5c00;font-weight:bold">));</span>
        <span style="color:#000">employeeList</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Employee</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;LiSi&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">36</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;1403064&#34;</span><span style="color:#ce5c00;font-weight:bold">));</span>
        <span style="color:#000">employeeList</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Employee</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;WangWu&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">31</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;1403065&#34;</span><span style="color:#ce5c00;font-weight:bold">));</span>

        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">employeeList</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>使用全局Path后的请求路径为：<strong>/global-path/restlight/employee/list</strong></p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    健康检查对应的请求路径不受全局Path影响

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2d62b7aa8e1eca9bf6a0801bc5f14074">4.13 - Aware扩展</h1>
    
	<p>在<code>Spring</code>场景，<code>Restlight</code>支持通过<code>xxxAware</code>接口获取一些内部对象。</p>
<p>其中包含</p>
<ul>
<li><code>RestlightBizExecutorAware</code>: 获取业务线程池</li>
<li><code>RestlightIoExecutorAware</code>: 获取IO线程池</li>
<li><code>RestlightServerAware</code>: 获取<code>RestlightServer</code></li>
<li><code>RestlightDeployContextAware</code>: 获取<code>DeployContext</code></li>
</ul>
<p>eg.</p>
<p>获取业务线程池</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Controller</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">HelloController</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">RestlightBizExecutorAware</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Executor</span> <span style="color:#000">bizExecutor</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">setRestlightBizExecutor</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Executor</span> <span style="color:#000">bizExecutor</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">bizExecutor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bizExecutor</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>


    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">supplyAsync</span><span style="color:#ce5c00;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#4e9a06">&#34;Hello Restlight!&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">bizExecutor</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-96c4371ff98f8a260892c1b9f27ee09b">4.14 - 路由缓存</h1>
    
	<h2 id="spring-mvc路由的痛点">Spring MVC路由的痛点</h2>
<p>传统的Spring MVC中， 当我们的<code>@RequestMapping</code>注解中包含了复杂任何的复杂匹配逻辑（这里的复杂逻辑可以理解为除了一个url对应一个controller实现，并且url中没有*, ? . {foo}等模式匹配的内容）时方能在路由阶段有相对较好的效果，反之如通常情况下一个请求的到来到路由到对应的controller实现这个过程将会是在当前应用中的<strong>所有</strong>Controller中遍历匹配，值得注意的是通常在微服务提倡RestFul设计的大环境下一个这种遍历几乎是无法避免的， 同时由于匹配的条件本身的复杂性（比如说正则本身为人诟病的就是性能），因此伴随而来的则是SpringMVC的路由的损耗非常的大。</p>
<h2 id="restlight路由缓存">Restlight路由缓存</h2>
<h3 id="设计原则">设计原则</h3>
<ul>
<li>二八原则（80%的业务由20%的接口处理）</li>
<li>算法：类LFU(Least Frequently Used)算法</li>
</ul>
<p>我们虽然不能改变路由条件匹配本身的损耗， 但是我们希望能做尽量少的匹配次数来达到优化的效果。因此采用常用的&quot;缓存&quot;来作为优化的手段。
当开启了路由缓存后，默认情况下将使用类LFU(Least Frequently Used)算法的方式缓存十分之的Controller，根据二八原则（80%的业务由20%的接口处理），大部分的请求都将在缓存中匹配成功并返回（这里框架默认的缓存十分之一，是相对比较保守的设置）</p>
<h3 id="算法逻辑">算法逻辑</h3>
<p>当每次请求匹配成功时，会进行命中纪录的加1操作，并统计命中纪录最高的20%（可配）的Controller加入缓存， 每次请求的到来都将先从缓存中查找匹配的Controller（大部分的请求都将在此阶段返回）， 失败则进入正常匹配的逻辑。</p>
<p>什么时候更新缓存？ 我们不会在每次请求命中的情况下都去更新缓存，因为这涉及到一次排序（或者m次遍历， m为需要缓存的Controller的个数，相当于挑选出命中最高的m个controller）。 取而代之的是我们会以概率的方式去重新计算并更新缓存， 根据2-8原则通常情况下我们当前缓存的内存就是我们需要的内容， 所以没必要每次有请求命中都去重新计算并更新缓存， 因此我们会在请求命中的一定概率条件下采取做此操作（默认0.1%， 称之为计算概率）， 减小了并发损耗（这段逻辑本身基于CopyOnWrite， 并且为纯无锁并发编程，本身性能损耗就很低），同时此概率可配置可以根据具体的应用实际情况调整配置达到最优的效果。</p>
<h3 id="配置建议">配置建议</h3>
<p>缓存比例：请求集中化比较高则设置更小（比如集中在1%的Controller上则可以设置为缓存1%）
计算率： 理论上设置的越高实时性越强（缓存更新频率越高）但是并发损耗也会升高，因此建议设置的相对小一些以应对激增的非常用请求即可。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    除极端情况下通常来说此缓存效果都会比原生的遍历实现要高效（这里指的是请求在Controller上的分布完全均匀）， 通常都能达到2-5倍的提升。

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4b2ddfd87c9683a4228d4a7f607fad08">4.15 - 快速失败</h1>
    
	<p>Restlight 支持根据请求任务的排队时间快速失败。具体地，从接收到首字节（TTFB）或请求任务进入线程池开始排队时开始计时，
如果请求任务真正执行时的时间与起始时间的差值大于指定值（timeout），那么直接结束当前请求（返回500）。</p>
<p>使用时，需要配置timeout与起始时间（首字节时间或者开始排队时间，默认后者），示例如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">restlight.server.scheduling.timeout.BIZ.type=QUEUED
restlight.server.scheduling.timeout.BIZ.time-millis=30

restlight.server.scheduling.timeout.IO.type=TTFB
restlight.server.scheduling.timeout.IO.time-millis=30
</code></pre><p>其中，<code>BIZ</code>和<code>IO</code>为Scheduler的名称，<code>type</code>为开始计时的方式，默认为<code>QUEUED</code>，
表示从请求任务进入线程池排队时开始计时，<code>TTFB</code>表示从接收到首字节时开始计时，<code>time-millis</code>
表示超时时间。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-00806bebd264f4ab6a8752deb8fde3f3">4.16 - Mock测试</h1>
    
	<p>同Spring MVC一样，Restlight也提供了单元测试的功能，用于构造请求并将请求映射到对应的Handler，得到Handler的执行结果并测试。如果您对Spring-Test不熟悉，请参考<a href="https://docs.spring.io/spring/docs/5.1.3.RELEASE/spring-framework-reference/testing.html#testing">Spring-Testing</a>。由于Restlight与Spring-web天生存在冲突，因此MockMvc的使用方式与Spring Mvc的略有差异，详情如下文所示。需要注意的是：</p>
<ul>
<li>使用MockMvc及MockMvcBuilders时请正确引入restlight包下的，而不是spring-web测试包下的。</li>
<li>由于Restlight暂不支持RestTemplate，因此与该功能有关的测试同样暂不支持，如@AutoConfigureWebClient、@WebMvcTest等。</li>
</ul>
<p>使用该功能需要额外引入如下依赖：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">
<span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;scope&gt;</span>test<span style="color:#204a87;font-weight:bold">&lt;/scope&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${spring.boot.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>

<span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-test-starter<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;scope&gt;</span>test<span style="color:#204a87;font-weight:bold">&lt;/scope&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><h2 id="1-通过context构造测试环境">1. 通过Context构造测试环境</h2>
<p>该方式与Spring Mvc测试方式几乎无差异，需要注意的是：正确引入restlight包下的MockMvc及MockMvcBuilders。示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RunWith</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">SpringRunner</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@SpringBootTest</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">BootstrapWithContextTest</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">ApplicationContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">MockMvc</span> <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@Before</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">setUp</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MockMvcBuilders</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">contextSetup</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Test</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testListAll</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">perform</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MockAsyncRequest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">aMockRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">withUri</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/demo1/list&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertTrue</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">result</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">()))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertEquals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">status</span><span style="color:#ce5c00;font-weight:bold">()));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Test</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testListAll2</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">perform</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MockAsyncRequest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">aMockRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">withUri</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/demo2/list&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertTrue</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">result</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">()))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertEquals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">status</span><span style="color:#ce5c00;font-weight:bold">()));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="2-通过controller列表构造测试环境">2. 通过Controller列表构造测试环境</h2>
<p>该方式与Spring Mvc测试方式几乎无差异，需要注意的是：正确引入restlight包下的MockMvc及MockMvcBuilders。示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RunWith</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">SpringRunner</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@SpringBootTest</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">BootstrapWithSingletonTest</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">DemoController1</span> <span style="color:#000">demoController1</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">DemoController2</span> <span style="color:#000">demoController2</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">MockMvc</span> <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@Before</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">setUp</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MockMvcBuilders</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">standaloneSetup</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">demoController1</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">demoController2</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">();</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Test</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testListAll</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">perform</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MockAsyncRequest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">aMockRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">withUri</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/demo1/list&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertTrue</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">result</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">()))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertEquals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">status</span><span style="color:#ce5c00;font-weight:bold">()));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Test</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testListAll2</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">perform</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MockAsyncRequest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">aMockRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">withUri</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/demo2/list&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertTrue</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">result</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">()))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertEquals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">status</span><span style="color:#ce5c00;font-weight:bold">()));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="3-自动注入mockmvc">3. 自动注入MockMvc</h2>
<p>该方式与Spring Mvc测试方式几乎无差异，需要注意的是：正确引入restlight包下的MockMvc。示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RunWith</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">SpringRunner</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@SpringBootTest</span>
<span style="color:#5c35cc;font-weight:bold">@AutoConfigureMockMvc</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">MockMvcAutowiredTest</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">MockMvc</span> <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@Test</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testListAll</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">perform</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MockAsyncRequest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">aMockRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">withUri</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/demo1/list&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertTrue</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">result</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">()))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertEquals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">getStatus</span><span style="color:#ce5c00;font-weight:bold">()));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Test</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testListAll2</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">perform</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MockAsyncRequest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">aMockRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">withUri</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/demo2/list&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertTrue</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">result</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">()))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertEquals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">getStatus</span><span style="color:#ce5c00;font-weight:bold">()));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="4-异步方法测试">4. 异步方法测试</h2>
<p>与同步方法不同，如果原始Controller为异步方法，执行完perform()方法后直接对执行结果进行判断不会得到预期结果，因为原始Controller并未执行完，响应内容也尚未写入。因此如果原始Controller方法为异步，Restlight在执行完perform()方法后会阻塞等待异步方法执行完成，而后继续执行用户自定义的判断逻辑，使用时可以通过MockAsyncRequest的asynTimeout属性设置阻塞等待的时间（默认为-1）。</p>
<p>使用示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RunWith</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">SpringRunner</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@SpringBootTest</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">classes</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RestlightDemoApplication</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@AutoConfigureMockMvc</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AsyncDemoControllerTest</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">MockMvc</span> <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@Test</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testListAll</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">perform</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MockAsyncRequest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">aMockRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">withUri</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/async/list&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertTrue</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">result</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">()))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertEquals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">status</span><span style="color:#ce5c00;font-weight:bold">()));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8bbf607bf55ab234484ca9e6f4ca15c4">4.17 - 辅助配置</h1>
    
	<p><code>SpringBoot</code>场景下大多数的配置可通过<code>application.properties</code>（或者yaml）配置文件即可完成配置，但是配置文件配置还是会有其缺陷</p>
<ul>
<li>无法动态配置（这里的动态指的是通过代码计算等方式决定配置）</li>
<li>语法表达能力有限（比如<code>ChannelOption</code>无法通过配置文件表达）</li>
<li>配置过多变得冗杂</li>
</ul>
<p>等问题。</p>
<h2 id="restlightconfigure"><code>RestlightConfigure</code></h2>
<p>用于支持<code>SpringBoot</code>场景显式配置</p>
<p>eg.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">RestlightConfigure</span> <span style="color:#000">configure</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">restlight</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">restlight</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">address</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">8081</span><span style="color:#ce5c00;font-weight:bold">)</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">childOption</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ChannelOption</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">TCP_NODELAY</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">)</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">channelHandler</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">LoggingHandler</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addFilter</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                    <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>                    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">doFilter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">);</span>
                <span style="color:#ce5c00;font-weight:bold">})</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">deployments</span><span style="color:#ce5c00;font-weight:bold">()</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addHandlerInterceptor</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">HandlerInterceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                    <span style="color:#5c35cc;font-weight:bold">@Override</span>
                    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">preHandle</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                             <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                             <span style="color:#000">Object</span> <span style="color:#000">handler</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                        <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>                        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
                    <span style="color:#ce5c00;font-weight:bold">}</span>
                <span style="color:#ce5c00;font-weight:bold">});</span>
        <span style="color:#000">restlight</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">options</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">setCoreBizThreads</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">16</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#000">restlight</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">options</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">setMaxBizThreads</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">32</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#8f5902;font-style:italic">// more...
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b2dc3803615c85a9c04d46f40ac36997">4.18 - 配置一览</h1>
    
	<h2 id="server相关配置">Server相关配置</h2>
<p>所有配置均以<code>restlight.server</code>开头, 基于properties的配置（yml以此类推）</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>默认</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>host</td>
<td>0.0.0.0</td>
<td>服务绑定的ip</td>
</tr>
<tr>
<td>port</td>
<td>8080</td>
<td>服务绑定的端口</td>
</tr>
<tr>
<td>unix-domain-socket-file</td>
<td></td>
<td>不为空则使用Unix Domain Socket绑定到此文件(优先级高于ip:port的方式）</td>
</tr>
<tr>
<td>use-native-transports</td>
<td>Linux环境下为true其余为false</td>
<td>是否使用原生epoll支持, 否则使用NIO的selector</td>
</tr>
<tr>
<td>connector-threads</td>
<td>1</td>
<td>连接线程池大小</td>
</tr>
<tr>
<td>io-threads</td>
<td>cpu*2（默认不超过64）</td>
<td>IO线程池大小</td>
</tr>
<tr>
<td>biz-termination-timeout-seconds</td>
<td>60</td>
<td>优雅停机等待超时时间</td>
</tr>
<tr>
<td>http2-enable</td>
<td>false</td>
<td>是否开启Http2</td>
</tr>
<tr>
<td>compress</td>
<td>false</td>
<td>是否启用HTTP响应压缩</td>
</tr>
<tr>
<td>decompress</td>
<td>false</td>
<td>是否启用HTTP请求解压</td>
</tr>
<tr>
<td>max-content-length</td>
<td>4 * 1024 * 1024</td>
<td>最大contentLength限制(b)</td>
</tr>
<tr>
<td>max-initial-line-length</td>
<td>4096</td>
<td>最大request line限制(b)</td>
</tr>
<tr>
<td>max-header-size</td>
<td>8192</td>
<td>最大header size限制(b)</td>
</tr>
<tr>
<td>route.use-cached-routing</td>
<td>true</td>
<td>开启路由缓存</td>
</tr>
<tr>
<td>route.compute-rate</td>
<td>1</td>
<td>路由计算率，取值范围0-1000，固定的概率之下更新路由</td>
</tr>
<tr>
<td>warm-up.enable</td>
<td>false</td>
<td>是否开启服务预热功能</td>
</tr>
<tr>
<td>warm-up.delay</td>
<td>0</td>
<td>服务延迟暴露时间（单位：毫秒）</td>
</tr>
<tr>
<td>keep-alive-enable</td>
<td>true</td>
<td>false服务器将强制只支持短链接</td>
</tr>
<tr>
<td>soBacklog</td>
<td>128</td>
<td>对应netty的ChannelOption.SO_BACKLOG</td>
</tr>
<tr>
<td>write-buffer-high-water-mark</td>
<td>-1</td>
<td>netty中channel的高水位值</td>
</tr>
<tr>
<td>write-buffer-low-water-mark</td>
<td>-1</td>
<td>netty中channel的低水位值</td>
</tr>
<tr>
<td>idle-time-seconds</td>
<td>60</td>
<td>连接超时时间</td>
</tr>
<tr>
<td>logging</td>
<td></td>
<td>设置LoggingHandler用于打印连接及读写信息</td>
</tr>
</tbody>
</table>
<h2 id="核心功能配置">核心功能配置</h2>
<p>所有配置均以<code>restlight.server</code>开头, 基于properties的配置（yml以此类推）</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>默认</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>context-path</td>
<td></td>
<td>全局path前缀</td>
</tr>
<tr>
<td>biz-threads.core</td>
<td>cpu*4（默认在64-128之间）</td>
<td>业务线程池核心线程数</td>
</tr>
<tr>
<td>biz-threads.max</td>
<td>cpu*6（默认在128-256之间）</td>
<td>业务线程池最大线程数</td>
</tr>
<tr>
<td>biz-threads.blocking-queue-length</td>
<td>512</td>
<td>业务线程池阻塞队列大小</td>
</tr>
<tr>
<td>biz-threads.keep-alive-time-seconds</td>
<td>180</td>
<td>业务线程池keepAliveTime 单位：秒</td>
</tr>
<tr>
<td>serialize.request.negotiation</td>
<td>false</td>
<td>请求序列化协商</td>
</tr>
<tr>
<td>serialize.request.negotiation-param</td>
<td>format</td>
<td>请求序列化协商参数名称</td>
</tr>
<tr>
<td>serialize.response.negotiation</td>
<td>false</td>
<td>响应序列化协商</td>
</tr>
<tr>
<td>serialize.response.negotiation-param</td>
<td>format</td>
<td>响应序列化协商参数名称</td>
</tr>
<tr>
<td>print-banner</td>
<td>true</td>
<td>是否启动打印logo</td>
</tr>
</tbody>
</table>
<h2 id="ssl配置">SSL配置</h2>
<p>所有配置均以<code>restlight.server.ssl</code>开头, 基于properties的配置（yml以此类推）</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>默认</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>enable</td>
<td>false</td>
<td>是否使用https</td>
</tr>
<tr>
<td>ciphers</td>
<td></td>
<td>支持的加密套件，不设置表示使用默认</td>
</tr>
<tr>
<td>enable-protocols</td>
<td></td>
<td>支持的加密协议，不设置表示使用默认</td>
</tr>
<tr>
<td>cert-chain-path</td>
<td></td>
<td>证书路径，https-enable为true时必须</td>
</tr>
<tr>
<td>key-path</td>
<td></td>
<td>私钥路径，https-enable为true时必须</td>
</tr>
<tr>
<td>key-password</td>
<td></td>
<td>私钥文件密钥（如果需要的话）</td>
</tr>
<tr>
<td>trust-certs-path</td>
<td></td>
<td>Trust Store</td>
</tr>
<tr>
<td>session-timeout</td>
<td></td>
<td>session过期时间, 0表示使用默认</td>
</tr>
<tr>
<td>session-cache-size</td>
<td></td>
<td>session缓存大小， 0表示使用默认</td>
</tr>
<tr>
<td>handshake-timeout-millis</td>
<td></td>
<td>SSL握手超时时间</td>
</tr>
<tr>
<td>client-auth</td>
<td></td>
<td>客户端认证类型，不设置默认无</td>
</tr>
</tbody>
</table>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    路径如果在classpath下请使用<code>classpath:conf/foo.pem</code>的形式

</div>


</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ade7eba81490dc10670fdec8495f5aa2">5 - 扩展能力</h1>
    <div class="lead"><code>Restlight</code>内置了常用的Filter（IP白名单、新建连接数限制、CPU过载保护）、Interceptor(访问日志、参数签名验证)和表单参数解析器</div>
	<p>可以一次引入所有扩展能力</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">
<span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-ext-starter<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-565e90f031add052259807c8bd2afe76">5.1 - 新建连接数限制</h1>
    
	<p>使用新建连接数限制时请先确保引入了依赖：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-ext-filter-starter<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><p>当前服务的新建连接数进行QPS限制。超过连接数限制的请求将被拒绝。</p>
<p>使用方式：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#开启新建连接数限制
restlight.server.ext.connection-creation-limit.enable=true
#设置每秒限制4000个新建连接,默认为20000
restlight.server.ext.connection-creation-limit.max-per-second=40000
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2c62ed94d1fc1376101e882daea64604">5.2 - CPU Load保护</h1>
    <div class="lead">当服务宿主机Cpu负载达到一定阈值之后开始随机丢弃连接（新建连接， 已经建立的连接不受影响）</div>
	<p>使用新建连接数限制时请先确保引入了依赖：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-ext-filter-starter<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><pre tabindex="0"><code class="language-properties" data-lang="properties">#开启Cpu Load自我保护
restlight.server.ext.cpu-load-protection.enable=true
#cpu负载阈值，默认为80.0D cpu超过此负载之后将开始随机丢弃连接
restlight.server.ext.cpu-load-protection.threshold=80.0D
#初始连接丢弃率,默认为10.0D（0代表0%， 100代表100%， 可以传小数）
restlight.server.ext.cpu-load-protection.initial-discard-rate=10.0D
#最大连接丢弃率,默认为80.0D（0代表0%， 100代表100%， 可以传小数）
restlight.server.ext.cpu-load-protection.max-discard-rate=80.0D
</code></pre><p>上面的配置将会在cpu负载到达75%时开始随机丢弃20%的新建连接， 随着cpu负载的升高达到100%则将会丢弃80%的连接。</p>
<p>说明：</p>
<p>当cpu负载到达或者超过<code>cpu-load-threshold</code>的值时开始丢弃连接，初始连接丢弃概率为<code>initial-discard-rate</code>,  随着cpu负载升高， 丢弃率将随着cpu负载的升高而成正比的升高， 当cpu负载达到100%时丢弃率将达到<code>max-discard-rate</code>.


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    平滑的连接丢弃比率计算有助于根据cpu使用率的变化来调节连接的丢弃比率。

</div>
</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7d39489b3769120a91d18d02e839cd61">5.3 - Access Log</h1>
    
	<p>使用Restlight访问日志拦截器时请确保已经引入了依赖：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-ext-filter-starter<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><h2 id="quick-start">Quick Start</h2>
<p>AccessLog拦截器在每个请求结束后记录访问日志，内容包含：客户端地址、请求协议、请求url（不包含路径参数）、请求方法、请求耗时、响应状态码、响应body大小以及访问时间。使用时需要做如下配置：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#开启AccessLog
restlight.server.ext.accesslog.enable=true
</code></pre>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    访问日志默认会打印日志到logs/access.log文件中

</div>

<h2 id="配置">配置</h2>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    所有配置均以<code>restlight.server.ext.accesslog</code> 开头

</div>

<table>
<thead>
<tr>
<th>配置项</th>
<th>默认</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>enable</td>
<td>false</td>
<td>是否启用</td>
</tr>
<tr>
<td>directory</td>
<td>logs</td>
<td>日志文件路径</td>
</tr>
<tr>
<td>fileName</td>
<td>access.log</td>
<td>日志文件名</td>
</tr>
<tr>
<td>charset</td>
<td></td>
<td>日志编码</td>
</tr>
<tr>
<td>rolling</td>
<td>true</td>
<td>是否按照时间滚动生成文件</td>
</tr>
<tr>
<td>date-pattern</td>
<td>yyyy-MM-dd</td>
<td>日期滚动格式，yyyy-MM-dd表示按天为单位滚动，生成的文件名为access.yyyy-MM-dd.log， 仅支持按天和小时为单位滚动，因此可选值：yyyy-MM-dd或者yyyy-MM-dd_HH（注意不要使用yyyy-MM-dd HH， 生成的文件名可能不符合操作系统文件命名规范）</td>
</tr>
<tr>
<td>max-history</td>
<td>10</td>
<td>最大历史文件个数</td>
</tr>
<tr>
<td>full-uri</td>
<td>false</td>
<td>是否打印uri中所有的内容（包含url参数）</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-263ce0837051e5d3ff7c6fa617a3b818">5.4 - 跨域</h1>
    
	<p>引入依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-ext-filter-starter<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><p>开启跨域功能</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">restlight.server.ext.cors.enable=true
</code></pre><p>更多跨域相关配置</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">restlight.server.ext.cors.rules[0].anyOrigin=false
restlight.server.ext.cors.rules[0].origins=www.example.com,www.demo.com
restlight.server.ext.cors.rules[0].expose-headers=foo,bar
restlight.server.ext.cors.rules[0].allow-credentials=false
restlight.server.ext.cors.rules[0].allow-methods=GET,POST
restlight.server.ext.cors.rules[0].allow-headers=foo,bar
restlight.server.ext.cors.rules[0].max-age=3600
</code></pre>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    不配置则应用默认配置

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7e5633cdbac5b3f1ddc6d0ffd2b54aef">5.5 - 文件及表单参数解析</h1>
    
	<p><code>Restlight</code>提供了表单参数解析的功能，使用时需要单独引入相应的包：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
   <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
   <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-ext-multipart-starter<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
   <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><h2 id="文件参数">文件参数</h2>
<p>使用示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Controller</span>
<span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/restlight/file/&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">FileSupportController</span>
    <span style="color:#8f5902;font-style:italic">// 上传单个文件
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/upload&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">fileUpload</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@UploadFile</span> <span style="color:#000">MultipartFile</span> <span style="color:#000">multipartFile</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">File</span> <span style="color:#000">temp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">File</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;D:\\&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">multipartFile</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">originalFilename</span><span style="color:#ce5c00;font-weight:bold">());</span>
        <span style="color:#000">multipartFile</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">transferTo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">temp</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;SUCCESS&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
	
    <span style="color:#8f5902;font-style:italic">// 上传一组文件
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/uploads&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">fileUploads</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@UploadFile</span> <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">MultipartFile</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">files</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MultipartFile</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">files</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#000">File</span> <span style="color:#000">temp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">File</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;D:\\&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">file</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">originalFilename</span><span style="color:#ce5c00;font-weight:bold">());</span>
            <span style="color:#000">file</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">transferTo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">temp</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;SUCCESS&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    对于超大文件的上传可能会导致OOM，因为Restlight底层基于Netty实现，会将整个请求body转换成byte[]数组存放在内存中，再将对应的数据转成文件格式。

</div>

<p><code>Restlight</code>默认请求body大小为4MB，当上传文件时需要根据需要调整该值的大小；默认的编码格式为：UTF-8。使用时，也可以通过配置文件改变上述参数值：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#设置请求body大小 4MB = 4 * 1024 * 1024 = 4194304
restlight.server.max-content-length=4194304

#编码方式
restlight.server.ext.multipart.charset=utf-8

#单个文件大小限制，默认-1（没有限制） 4KB = 4 * 1024 = 4096
restlight.server.ext.multipart.max-size=4096

#是否使用临时文件，为true时任何大小的文件都使用临时文件，默认为false
restlight.server.ext.multipart.use-disk=true

#临时文件目录
restlight.server.ext.multipart.temp-dir=D:\\temp

#当multipart-use-disk为false且单个文件大小超过该值时使用临时文件，默认2MB
restlight.server.ext.multipart.memory-threshold=2097152
</code></pre><h3 id="非文件参数">非文件参数</h3>
<p>在需要接收的方法参数上加上<code>@FormParam</code>注解，如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/upload&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">uploadFormParams</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@FormParam</span> <span style="color:#000">String</span> <span style="color:#000">formParam0</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#5c35cc;font-weight:bold">@FormParam</span> <span style="color:#000">String</span> <span style="color:#000">formParam1</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">formParam0</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;; &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">formParam1</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-30b8e819f78dc39f2d491e31f4e40af8">5.6 - 签名认证</h1>
    
	<p>使用Restlight参数签名验证拦截器时请先引入依赖：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-ext-interceptor-starter<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><p>参数签名验证拦截器可以验证请求参数的签名，防止请求参数被篡改。使用时请做如下配置：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#开启参数签名验证功能的必需配置
restlight.server.ext.sign.enable=true

#调用方ID参数名,默认为appId
restlight.server.ext.sign.app-id-name=appId

#签名秘钥版本参数名,默认为sv
restlight.server.ext.sign.secret-version-name=sv

#请求时间戳参数名,默认为ts
restlight.server.ext.sign.timestamp-name=ts

#请求时间戳有效期：单位秒（默认为0）
restlight.server.ext.sign.expire-seconds=0

#签名参数名称,默认为sign
restlight.server.ext.sign.signature-name=sign

#是否对所有接口进行签名验证（默认为false）
restlight.server.ext.sign.verify-all=true
</code></pre>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    配置完成后，需要自定义esa.restlight.ext.interceptor.signature.SecretProvider的实现类并注入Spring容器。该接口定义了通过appId、secretVersion、timestamp获取秘钥的方法。

</div>

<h2 id="服务端验签详细过程">服务端验签详细过程</h2>
<ul>
<li>第一步：从请求中获取签名值signature并去掉前后空格（先从url参数中获取，如果没有再从请求头中获取）；</li>
<li>第二步：从请求中获取时间戳timestamp并去掉前后空格（方式同上），如果配置了请求时间戳有效期，则判断是否在有效期内。</li>
<li>第三步：从请求中获取appId、secretVersion并去掉前后空格（方式同上）。</li>
<li>第四步：根据上述的appId、secretVersion、timestamp从自定义的SecretProvider获取secret。</li>
<li>第五步：根据请求参数构建签名data[]，具体步骤为：1.构建请求参数对应的paramData[]：获取所有的url参数（排除sign），按照参数名字典序升序排列，若一个参数对应多个值，则这多个值也按字典序升序排列（<strong>注意：所有参数名和参数值均会去掉前后空格</strong>）。如：http://api.xxx.com/getUserInfo?appId=your_appId&amp;sv=1&amp;ts=1555933697000&amp;user_id=u001&amp;sign=xxx&amp;names=LiMing&amp;names=ZhangSan对应的paramData[]=(&ldquo;api_key=your_appId&amp;names=LiMing&amp;names=ZhangSan&amp;sv=1&amp;t=1555933697000&amp;user_id=u001&rdquo;).getBytes(&ldquo;UTF-8&rdquo;)；2.构建请求body对应的bodyData[]：对于类型为POST且Content-Type不包含x-www-form-urlencoded的请求，直接通过request.getBody()获取bodyData[]。<strong>重要说明：</strong> 对于Content-Type包含x-www-form-urlencoded的POST请求，验证签名时会将body中参数合并到url的参数中一起处理，客户端加密时需要注意此种情况；3.合并paramData[]和bodyData[]作为签名data[]。</li>
<li>第六步：使用HmacSha1算法生成data[]与secret的签名（详见esa-commons项目下SecurityUtils的getHmacSHA1方法）。</li>
<li>第七步：验证signature与第六步生成的签名是否相等。</li>
</ul>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    参数签名验证失败会抛出SignatureValidationException，该异常的message中保存了验签失败的详细原因，使用时可根据需要自定义该异常的处理方法
Restlight已在内部开源，签名验证的代码实现参见：restlight-support模块下AbstractSignatureInterceptor。

</div>

<h2 id="指定或排除需要进行签名验证的接口">指定或排除需要进行签名验证的接口</h2>
<p>Restlight提供了两种不同的方式来自定义需要进行签名验证的接口：1. 在全局接口都进行签名验证的情况下，使用@IgnoreSignValidation注解忽略指定接口的签名验证功能；2. 在全局接口都不进行签名验证的前提下，使用@SignValidation注解指定对需要进行签名验证的接口。默认使用方式2。
方式1使用示例：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">restlight.server.ext.sign.verify-all=true
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/index&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@IgnoreSignValidation</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">index</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">TestService</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">list</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>如上配置表示：对index()方法之外的其他接口均开启签名验证功能。</p>
<p>方式2使用示例：</p>
<pre tabindex="0"><code>restlight.server.ext.sign.verify-all=false
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/index&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@SignValidation</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">index</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">TestService</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">list</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>如上配置表示：只对index()方法对应的接口开启签名验证功能。</p>
<h3 id="自定义参数签名验证拦截器">自定义参数签名验证拦截器</h3>
<p><code>Restlight</code>默认使用<strong>HmacSHA1</strong>作为验签时原始请求的签名生成方法，当用户使用其它算法可以注入自定义的参数签名验证拦截器，使用示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Component</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">CustomizeSignatureValidationFactory</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">SignValidationHandlerInterceptorFactory</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CustomizeSignatureValidationFactory</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">SecretDistributor</span> <span style="color:#000">distributor</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">super</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">distributor</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">protected</span> <span style="color:#000">AbstractSignatureRouteInterceptor</span> <span style="color:#000">doCreate</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">SignatureOptions</span> <span style="color:#000">options</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">SecretDistributor</span> <span style="color:#000">distributor</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbstractSignatureRouteInterceptor</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">distributor</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#5c35cc;font-weight:bold">@Override</span>
            <span style="color:#204a87;font-weight:bold">protected</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">validate</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">signature</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">sk</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#8f5902;font-style:italic">// customize validation
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#ce5c00;font-weight:bold">};</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d942ecd2ec2d2eb4b01636561f9861b7">5.7 - XSS过滤</h1>
    
	<p>引入依赖：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-ext-filter-starter<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><p>使用方式：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#开启Xss过滤
restlight.server.ext.xss.enable=true
#Xss过滤模式，默认escape（转义模式），filter为过滤模式
restlight.server.ext.xss.mode=escape
</code></pre><p>配置好后自动对所有请求进行转义或者过滤。</p>
<h2 id="xss过滤范围">XSS过滤范围</h2>
<p>支持<code>URL</code>参数过滤及<strong>不完整</strong>的<code>Header</code>过滤</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    Header相关参数仅支持<code>AsyncRequest.getHeader(CharSequence name)</code>以及<code>AsyncRequest.getHeader(String name)</code>方法。

</div>

<h2 id="escape--filter模式"><code>Escape</code> &amp; <code>Filter</code>模式</h2>
<h3 id="escape-模式"><code>Escape</code> 模式</h3>
<p>该模式会对用户请求的 <code>URL</code>参数 和 <code>Header </code>进行转义，转义的字符集如下：</p>
<table>
<thead>
<tr>
<th>转义前</th>
<th>转义后</th>
</tr>
</thead>
<tbody>
<tr>
<td>&gt;</td>
<td>&amp;gt;</td>
</tr>
<tr>
<td>&lt;</td>
<td>&amp;lt;</td>
</tr>
<tr>
<td>&quot;</td>
<td>&amp;quot;</td>
</tr>
<tr>
<td>&amp;</td>
<td>&amp;amp;</td>
</tr>
</tbody>
</table>
<h3 id="filter-模式"><code>Filter</code> 模式</h3>
<p>该模式会对用户请求的 <code>URL</code>参数 和 <code>Header </code>进行过滤，删除容易引起 Xss 的标签或者表达式，以空串代替，比如 <code>name=&lt;script&gt;...&lt;/script&gt;</code> ，过滤以后会直接将 <code>&lt;script&gt;...&lt;/script&gt;</code> 以空串替换，即 <code>name=&quot;&quot;</code>，需要以空串替换的标签和表达式如下：</p>
<table>
<thead>
<tr>
<th>标签或表达式</th>
</tr>
</thead>
<tbody>
<tr>
<td>&lt;script&gt;&hellip;&lt;/script&gt;</td>
</tr>
<tr>
<td>&lt;/script&gt;</td>
</tr>
<tr>
<td>&lt;script &hellip;&gt;</td>
</tr>
<tr>
<td>src='&hellip;'</td>
</tr>
<tr>
<td>src=&quot;&hellip;&quot;</td>
</tr>
<tr>
<td>eval(&hellip;)</td>
</tr>
<tr>
<td>e­xpression(&hellip;)</td>
</tr>
<tr>
<td>javascript:</td>
</tr>
<tr>
<td>alert</td>
</tr>
<tr>
<td>onload=</td>
</tr>
<tr>
<td>vbscript:</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5244fafd526f119d0232178cd1dbc931">5.8 - IP白名单</h1>
    
	<h1 id="ip白名单">IP白名单</h1>
<p>使用Restlight内置的IP白名单时请先确保引入了依赖：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-ext-filter-starter<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><p>IP白名单拦截器可以过滤非法IP的访问。同时支持IP地址和正则表达式两种匹配方式，需要配置的内容如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#开启IP白名单拦截器的必需配置
restlight.server.ext.whitelist.enable=true

#IP白名单列表（多值请用逗号分隔,正则表达式regex:开头）
restlight.server.ext.whitelist.ips=10.10.1.1,regex:10.12.*

#缓存最近访问的IP地址（默认1024个）
restlight.server.ext.whitelist.cache-size=1024

#缓存的失效时间（单位：ms，默认为60s）
restlight.server.ext.whitelist.expire=60000
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ef42401d76c218bc23a80a78d7b6f80a">5.9 - 数据校验</h1>
    <div class="lead">Restlight集成了Hibernate Validator，提供了开箱即用的数据校验功能，通过注解完成对JavaBean、Controller方法参数和返回值的校验， 并支持异常消息国际化。</div>
	<p>使用Restlight内置的数据校验请先确保引入了依赖：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-ext-validator-starter<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    当前版本的restlight-starter中默认引入了该依赖，使用时无需重复引入

</div>

<h2 id="普通javabean的校验">普通JavaBean的校验</h2>
<p>使用注解声明对属性的约束</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Employee</span> <span style="color:#ce5c00;font-weight:bold">{</span>
	<span style="color:#5c35cc;font-weight:bold">@NotEmpty</span>
	<span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">;</span>
	
	<span style="color:#5c35cc;font-weight:bold">@Min</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">18</span><span style="color:#ce5c00;font-weight:bold">)</span>
	<span style="color:#5c35cc;font-weight:bold">@Max</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">60</span><span style="color:#ce5c00;font-weight:bold">)</span>
	<span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">age</span><span style="color:#ce5c00;font-weight:bold">;</span>
	
	<span style="color:#5c35cc;font-weight:bold">@Email</span>
	<span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">String</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">;</span>
	
	<span style="color:#5c35cc;font-weight:bold">@Length</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">min</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">10</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">max</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">20</span><span style="color:#ce5c00;font-weight:bold">)</span>
	<span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">String</span> <span style="color:#000">address</span><span style="color:#ce5c00;font-weight:bold">;</span>

        <span style="color:#8f5902;font-style:italic">// 级联校验
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#5c35cc;font-weight:bold">@Valid</span>
	<span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Object</span> <span style="color:#000">cascadingObject</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>作为方法参数校验, 需要使用<code>@Valid</code>注解标记被校验的参数</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@PostMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/add&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@Valid</span> <span style="color:#5c35cc;font-weight:bold">@RequestBody</span> <span style="color:#000">Employee</span> <span style="color:#000">employee</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">SUCCESS</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>作为返回值， 需要使用<code>@Valid</code>注解标记方法或者参数</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Valid</span>
<span style="color:#5c35cc;font-weight:bold">@ResponseBody</span>
<span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/list&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Employee</span> <span style="color:#000">list1</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Employee</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">16</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>或者</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@ResponseBody</span>
<span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/list&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#5c35cc;font-weight:bold">@Valid</span> <span style="color:#000">Employee</span> <span style="color:#000">list2</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
   <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Employee</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">16</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    当需要校验的参数为JavaBean对象时用<code>@Valid</code>来显示声明需要对该参数进行校验。

</div>

<h2 id="普通方法参数校验">普通方法参数校验</h2>
<p>直接使用注解</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/update&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">update</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span> <span style="color:#5c35cc;font-weight:bold">@NotEmpty</span> <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#5c35cc;font-weight:bold">@RequestParam</span> <span style="color:#5c35cc;font-weight:bold">@Length</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">min</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">10</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">max</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">20</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">newAddress</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">SUCCESS</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="分组校验">分组校验</h2>
<p>使用<code>@ValidGroup</code>指定校验方法的参数、返回值校验时的分组。该注解只能标注在方法上并且value值只能为接口类(默认为<code>Default.class</code>)。</p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@ValidGroup</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Interface</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/addGroup&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">addGroup</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@Valid</span> <span style="color:#5c35cc;font-weight:bold">@RequestBody</span> <span style="color:#000">Employee</span> <span style="color:#000">employee</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">SUCCESS</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="自定义约束注解">自定义约束注解</h2>
<p>当内置的约束注解不能满足业务需求时，可以使用<code>@Constraint</code>自定义约束注解，具体实现使用hibernate-validation，使用方式与Spring MVC无差异，示例如下：</p>
<p>自定义约束注解:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Retention</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RetentionPolicy</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">RUNTIME</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Constraint</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">validatedBy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LogInSuccess</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">LogInSuccessValidator</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Target</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">ElementType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">FIELD</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ElementType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">METHOD</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ElementType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">PARAMETER</span><span style="color:#ce5c00;font-weight:bold">})</span>
<span style="color:#5c35cc;font-weight:bold">@Documented</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#5c35cc;font-weight:bold">@interface</span> <span style="color:#000">LogInSuccess</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#000">String</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#4e9a06">&#34;登录校验未通过&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#000">Class</span><span style="color:#ce5c00;font-weight:bold">&lt;?&gt;[]</span> <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#ce5c00;font-weight:bold">{};</span>

    <span style="color:#000">Class</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Payload</span><span style="color:#ce5c00;font-weight:bold">&gt;[]</span> <span style="color:#000">payload</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#ce5c00;font-weight:bold">{};</span>

    <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LogInSuccessValidator</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">ConstraintValidator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">LogInSuccess</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">initialize</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">LogInSuccess</span> <span style="color:#000">constraintAnnotation</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// Do nothing
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#ce5c00;font-weight:bold">}</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">isValid</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ConstraintValidatorContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>使用自定义约束注解：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/getId&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">getId</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span> <span style="color:#5c35cc;font-weight:bold">@LogInSuccess</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">message</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;请先登录&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">userName</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;SUCCESS&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="国际化">国际化</h2>
<p>数据校验的异常消息允许自定义并且支持国际化，自定义异常处理消息的步骤如下：</p>
<p>自定义异常消息文件，在classpath路径下加入配置文件，如validation-message.properties</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">key1=value1
key2=value2
...
</code></pre><p>配置异常消息文件名，在application中配置异常消息文件名，如：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#该文件名称对应上面定义的validation-message.properties文件
restlight.server.ext.validation.message-file=validation-message
</code></pre><p>修改约束注解的message属性值，如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@NotEmpty</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;{key1}&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#5c35cc;font-weight:bold">@Min</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">18</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;{key2}&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">age</span><span style="color:#ce5c00;font-weight:bold">;</span>
</code></pre></div><p>针对不同语言定义不同的异常消息文件，如：</p>
<ul>
<li>validation-message_zh_CN.properties</li>
<li>validation-message_en.properties</li>
<li>validation-message_cs.properties</li>
<li>validation-message_en.properties</li>
<li>&hellip;&hellip;</li>
</ul>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    更多不同语言的文件后缀可以参考jar包：hibernate-validator:5.4.1.Final下ValidationMessage中国际化文件的后缀。

</div>

<h2 id="数据校验注解一览">数据校验注解一览</h2>
<table>
<thead>
<tr>
<th>注解</th>
<th>功能</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>@AssertFalse</td>
<td>被注解元素必须为false</td>
<td></td>
</tr>
<tr>
<td>@AssertTrue</td>
<td>被注解的元素必须为true</td>
<td></td>
</tr>
<tr>
<td>@DecimalMax(value)</td>
<td>被注解的元素必须为一个数字，其值必须小于等于指定的最小值</td>
<td></td>
</tr>
<tr>
<td>@DecimalMin(Value)</td>
<td>被注解的元素必须为一个数字，其值必须大于等于指定的最小值</td>
<td></td>
</tr>
<tr>
<td>@Digits(integer=, fraction=)</td>
<td>被注解的元素必须为一个数字，其值必须在可接受的范围内</td>
<td></td>
</tr>
<tr>
<td>@Future</td>
<td>被注解的元素必须是未来的日期</td>
<td></td>
</tr>
<tr>
<td>@Max(value)</td>
<td>被注解的元素必须为一个数字，其值必须小于等于指定的最大值</td>
<td></td>
</tr>
<tr>
<td>@Min(value)</td>
<td>被注解的元素必须为一个数字，其值必须大于等于指定的最小值</td>
<td></td>
</tr>
<tr>
<td>@NotNull</td>
<td>被注解的元素必须不为null</td>
<td></td>
</tr>
<tr>
<td>@Null</td>
<td>被注解的元素必须为null</td>
<td></td>
</tr>
<tr>
<td>@Past</td>
<td>被注解的元素必须过去的日期</td>
<td></td>
</tr>
<tr>
<td>@Pattern</td>
<td>被注解的元素必须符合正则表达式</td>
<td></td>
</tr>
<tr>
<td>@Size(min=, max=)</td>
<td>被注解的元素必须在指定的范围(数据类型:String, Collection, Map and arrays)</td>
<td></td>
</tr>
<tr>
<td>@Email</td>
<td>被注解的元素被注释的元素必须是电子邮箱地址</td>
<td></td>
</tr>
<tr>
<td>@NotBlank</td>
<td>被注解的对象必须为字符串，不能为空，检查时会忽略空格</td>
<td></td>
</tr>
<tr>
<td>@NotEmpty</td>
<td>被注释的对象长度不能为0(数据:String,Collection,Map,arrays)</td>
<td></td>
</tr>
<tr>
<td>@Length(min=, max=)</td>
<td>被注解的对象必须是字符串并且长度必须在指定的范围内</td>
<td>Hibernate扩展注解</td>
</tr>
<tr>
<td>@Range(min=, max=)</td>
<td>被注释的元素必须在合适的范围内 (数据：BigDecimal, BigInteger, String, byte, short, int, long and 原始类型的包装类 )</td>
<td>Hibernate扩展注解</td>
</tr>
<tr>
<td>@URL(protocol=, host=, port=, regexp=, flags=)</td>
<td>被注解的对象必须是一个有效的URL，如果提供了protocol，host等，则该URL还需满足提供的条件</td>
<td>Hibernate扩展注解</td>
</tr>
</tbody>
</table>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    Hibernate扩展注解与javax可能存在注解名重复的情况， 请使用<code>org.hibernate.xxx</code>的注解。

</div>


</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a6ade1feee01c58451c20389bf1bcf06">6 - Spring Boot Actuator支持</h1>
    <div class="lead">Restlight适配了<a href="https://github.com/spring-projects/spring-boot/tree/master/spring-boot-project/spring-boot-actuator">Spring Boot Actuator</a>， 提供详细的健康检查以及监控等接口</div>
	<h1 id="quick-start">Quick Start</h1>
<p>引入Maven依赖：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>2.1.1.RELEASE<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-starter-actuator<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    Actuator的版本请配合对应的Spring Boot版本引入

</div>

<p>访问 <code>Get</code> <code>localhost:8080/actuator/info</code>返回<code>{}</code></p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    Spring Boot2.0之后的Atctuator默认只开启了<code>info</code>和<code>health</code>两个接口， 可以使用<code>management.endpoints.web.exposure.include=info,health,foo</code>开启。

</div>


</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-627f660f98fff1e8f313a11640ecedd7">6.1 - Restlight Endpoint扩展</h1>
    <div class="lead">在<a href="https://github.com/spring-projects/spring-boot/tree/master/spring-boot-project/spring-boot-actuator">Spring Boot Actuator</a>基础之上<code>Restlight</code>提供额外的功能扩展</div>
	<h2 id="业务线程池metrics">业务线程池Metrics</h2>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    业务线程当前采用JUC的<code>ThreadPoolExecutor</code>实现，后续版本可能会换成自定义实现，因此Metrics内容可能发生变更

</div>

<h3 id="1json-格式">1、Json 格式</h3>
<p><strong><code>Get</code> <code>actuator/bizthreadpool</code></strong></p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -X GET localhost:8080/actuator/bizthreadpool
</code></pre></div><p>返回</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;corePoolSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;maxPoolSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;queueLength&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;keepAliveTimeSeconds&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">180</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;activeCount&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;poolSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;largestPoolSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;taskCount&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;queueCount&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;completedTaskCount&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="2prometheus-格式">2、Prometheus 格式</h3>
<p><strong><code>Get</code> <code>actuator/bizthreadpool4prometheus</code></strong></p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -X GET localhost:8080/actuator/bizthreadpool4prometheus
</code></pre></div><p>返回</p>
<pre tabindex="0"><code># HELP core_pool_size  
# TYPE core_pool_size gauge
core_pool_size 1.0
# HELP active_count  
# TYPE active_count gauge
active_count 0.0
# HELP queue_count  
# TYPE queue_count gauge
queue_count 0.0
# HELP largest_pool_size  
# TYPE largest_pool_size gauge
largest_pool_size 0.0
# HELP reject_task_count  
# TYPE reject_task_count gauge
reject_task_count -1.0
# HELP max_pool_size  
# TYPE max_pool_size gauge
max_pool_size 2.0
# HELP pool_size  
# TYPE pool_size gauge
pool_size 0.0
# HELP queue_length  
# TYPE queue_length gauge
queue_length 1024.0
# HELP keep_alive_time_seconds  
# TYPE keep_alive_time_seconds gauge
keep_alive_time_seconds 60.0
# HELP task_count  
# TYPE task_count gauge
task_count 0.0
# HELP completed_task_count  
# TYPE completed_task_count gauge
completed_task_count 0.0
</code></pre><h2 id="业务线程池扩缩容">业务线程池扩缩容</h2>
<p><strong><code>Post</code> <code>actuator/bizthreadpool</code></strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -X POST -H <span style="color:#4e9a06">&#34;Content-Type:application/json&#34;</span> -d <span style="color:#4e9a06">&#34;{\&#34;corePoolSize\&#34;:\&#34;1\&#34;,\&#34;maxPoolSize\&#34;:\&#34;2\&#34;}&#34;</span> localhost:8080/actuator/bizthreadpool
</code></pre></div><h2 id="io线程池metrics">IO线程池Metrics</h2>
<h3 id="1json-格式-1">1、Json 格式</h3>
<p><strong><code>Get</code> <code>actuator/ioexecutor</code></strong></p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -X GET localhost:8080/actuator/ioexecutor
</code></pre></div><p>返回</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;childExecutors&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
        <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">&#34;pendingTasks&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;maxPendingTasks&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2147483647</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;ioRatio&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;taskQueueSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;tailTaskQueueSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;threadName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Netty-I/O-1#0&#34;</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;threadPriority&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;threadState&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;RUNNABLE&#34;</span>
        <span style="color:#000;font-weight:bold">},</span>
        <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">&#34;pendingTasks&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;maxPendingTasks&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2147483647</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;ioRatio&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;taskQueueSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;tailTaskQueueSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;threadName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Netty-I/O-1#1&#34;</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;threadPriority&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;threadState&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;RUNNABLE&#34;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">],</span>
    <span style="color:#204a87;font-weight:bold">&#34;threadCount&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;pendingTasks&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;threadStates&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">&#34;RUNNABLE&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#204a87;font-weight:bold">&#34;terminated&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;shutDown&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="2prometheus-格式-1">2、Prometheus 格式</h3>
<p><strong><code>Get</code> <code>actuator/ioexecutor4prometheus</code></strong></p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -X GET localhost:8080/actuator/ioexecutor4prometheus
</code></pre></div><p>返回</p>
<pre tabindex="0"><code># HELP pending_tasks_netty_io_1_0  
# TYPE pending_tasks_netty_io_1_0 gauge
pending_tasks_netty_io_1_0 0.0
# HELP thread_state_netty_io_1_1  
# TYPE thread_state_netty_io_1_1 gauge
thread_state_netty_io_1_1 1.0
# HELP thread_states_runnable  
# TYPE thread_states_runnable gauge
thread_states_runnable 2.0
# HELP task_queue_size_netty_io_1_1  
# TYPE task_queue_size_netty_io_1_1 gauge
task_queue_size_netty_io_1_1 0.0
# HELP thread_priority  
# TYPE thread_priority gauge
thread_priority 5.0
# HELP pending_tasks_netty_io_1_1  
# TYPE pending_tasks_netty_io_1_1 gauge
pending_tasks_netty_io_1_1 0.0
# HELP pending_tasks  
# TYPE pending_tasks gauge
pending_tasks 0.0
# HELP terminated  
# TYPE terminated gauge
terminated 0.0
# HELP max_pending_tasks  
# TYPE max_pending_tasks gauge
max_pending_tasks 2.147483647E9
# HELP thread_state_netty_io_1_0  
# TYPE thread_state_netty_io_1_0 gauge
thread_state_netty_io_1_0 1.0
# HELP io_ratio  
# TYPE io_ratio gauge
io_ratio 50.0
# HELP shutdown  
# TYPE shutdown gauge
shutdown 0.0
# HELP task_queue_size_netty_io_1_0  
# TYPE task_queue_size_netty_io_1_0 gauge
task_queue_size_netty_io_1_0 0.0
# HELP thread_count  
# TYPE thread_count gauge
thread_count 2.0
</code></pre>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">warning</h4>

    比较昂贵的操作， 不建议频繁调用

</div>

<p>当使用的Springboot版本为2.3.X及以上时，需要在pom文件中引入micrometer-registry-prometheus 1.5.1及以上版本，此处以1.5.1版本为例，直接引入即可覆盖原有版本，具体操作如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.micrometer<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>micrometer-registry-prometheus<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>1.5.1<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><h2 id="获取restlight所有配置信息">获取Restlight所有配置信息</h2>
<p><strong><code>Get</code> <code>actuator/restlightconfigs</code></strong></p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -X GET localhost:8080/actuator/restlightconfigs
</code></pre></div><p>返回：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;http2Enable&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;useNativeTransports&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;connectorThreads&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;ioThreads&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;coreBizThreads&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;maxBizThreads&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;blockingQueueLength&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;keepAliveTimeSeconds&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">180</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;executorTerminationTimeoutSeconds&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;compress&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;decompress&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;maxContentLength&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">4194304</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;maxInitialLineLength&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;maxHeaderSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;soRcvbuf&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;soSendbuf&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;soBacklog&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;writeBufferHighWaterMark&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">65536</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;idleTimeSeconds&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;keepAliveEnable&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;https&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">&#34;enable&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#204a87;font-weight:bold">&#34;handshakeTimeoutMillis&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#204a87;font-weight:bold">&#34;certificatePath&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#204a87;font-weight:bold">&#34;privateKeyPath&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#204a87;font-weight:bold">&#34;sessionTicketKeyPath&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#204a87;font-weight:bold">&#34;sessionTimeoutSeconds&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#204a87;font-weight:bold">&#34;sessionCacheEnable&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#204a87;font-weight:bold">&#34;sessionCacheSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#204a87;font-weight:bold">&#34;enabledCipherSuites&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
        <span style="color:#204a87;font-weight:bold">&#34;enabledProtocols&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#204a87;font-weight:bold">&#34;scheduling&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">&#34;defaultStrategy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;BIZ&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#204a87;font-weight:bold">&#34;bufferSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#204a87;font-weight:bold">&#34;batchingSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">50</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#204a87;font-weight:bold">&#34;route&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">&#34;useCachedRouting&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#204a87;font-weight:bold">&#34;cacheRatio&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#204a87;font-weight:bold">&#34;computeRate&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#204a87;font-weight:bold">&#34;contextPath&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;validationMessageFile&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;serialize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">&#34;request&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">&#34;negotiation&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;negotiationParam&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;format&#34;</span>
        <span style="color:#000;font-weight:bold">},</span>
        <span style="color:#204a87;font-weight:bold">&#34;response&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">&#34;negotiation&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;negotiationParam&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;format&#34;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#204a87;font-weight:bold">&#34;ext&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{},</span>
    <span style="color:#204a87;font-weight:bold">&#34;host&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;unixDomainSocketFile&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;printBanner&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;warmUp&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">&#34;enable&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#204a87;font-weight:bold">&#34;delay&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="强制full-gc">强制Full GC</h2>
<p><strong><code>Post</code> <code>actuator/forcefgc</code></strong></p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -X POST localhost:8080/actuator/forcefgc
</code></pre></div><h2 id="修改优雅停机等待时间">修改优雅停机等待时间</h2>
<p><strong><code>Post</code> <code>actuator/terminationtimeout</code></strong>。</p>
<p>Example：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -X POST -H <span style="color:#4e9a06">&#34;Content-Type:application/json&#34;</span> -d <span style="color:#4e9a06">&#34;{\&#34;timeout\&#34;: 120}&#34;</span> localhost:8080/actuator/terminationtimeout
</code></pre></div><p>返回</p>
<pre tabindex="0"><code>Success
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ace0d32cd342464828692279735398cb">6.2 - 自定义Endpoint</h1>
    <div class="lead">用户可以自己定义<code>Endpoint</code>实现定制化的健康检查接口</div>
	<p>eg</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Endpoint</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;appId&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AppIdEndpoint</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@ReadOperation</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">appId</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;esa-restlight&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>上面的代码自定义了一个<code>Endpoint</code>接口并返回appid</p>
<p>将上面接口注入Spring容器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">AppIdEndpoint</span> <span style="color:#000">endpoint</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AppIdEndpoint</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>启动之后访问<code>curl -X GET localhost:8080/actuator/appId</code></p>
<p>返回</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">esa-restlight
</code></pre><h2 id="自定义异步endpoint">自定义异步<code>EndPoint</code></h2>
<p>用户可以自己定义基于<code>Completablefture</code>的<code>Endpoint</code>实现定制化的健康检查接口</p>
<p>eg</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Endpoint</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;appId&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AppIdEndpoint</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@ReadOperation</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">appId</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">supplyAsync</span><span style="color:#ce5c00;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>

            <span style="color:#8f5902;font-style:italic">// do something...
</span><span style="color:#8f5902;font-style:italic"></span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;esa-restlight&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">});</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>上面的代码自定义了一个异步的<code>Endpoint</code>接口并返回appid</p>
<p>将上面接口注入Spring容器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">AppIdEndpoint</span> <span style="color:#000">endpoint</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AppIdEndpoint</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>启动之后访问<code>curl -X GET localhost:8080/actuator/appId</code></p>
<p>返回</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-pro" data-lang="pro"><span style="color:#4e9a06">esa</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#4e9a06">restlight</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6529bcb6d5f02db7dbd50c08714ba8fd">6.3 - 使用独立端口</h1>
    <div class="lead">默认情况下健康检查的接口都将与<code>Restight</code>使用同一个HttpServer服务， 如果需要将健康检查接口与业务接口分别使用不同的端口则需要添加自定义配置</div>
	<p>详细配置如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#配置健康检查暴露的端口
management.server.port=8081
</code></pre><p>启动后看到日志打印</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">Started Restlight(Actuator) server in 386 millis on port:8081
</code></pre>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    独立端口启动后所有的<code>Filter</code>, 序列化， <code>ArgumentResolver</code>等扩展将与<code>Restlight</code>隔离

</div>

<h2 id="辅助配置">辅助配置</h2>
<p><code>SpringBoot</code>场景下大多数的配置可通过<code>application.properties</code>（或者yaml）配置文件即可完成配置，但是配置文件配置还是会有其缺陷</p>
<ul>
<li>无法动态配置（这里的动态指的是通过代码计算等方式决定配置）</li>
<li>语法表达能力有限</li>
<li>配置过多变得冗杂</li>
</ul>
<p>等问题。</p>
<h3 id="managementconfigure"><code>ManagementConfigure</code></h3>
<p>用于支持<code>SpringBoot</code>场景显式配置</p>
<p>eg.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">ManagementConfigure</span> <span style="color:#000">configure</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">restlight</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">restlight</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">address</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">8081</span><span style="color:#ce5c00;font-weight:bold">)</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addFilter</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                    <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>                    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">doFilter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">);</span>
                <span style="color:#ce5c00;font-weight:bold">});</span>
        <span style="color:#000">restlight</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">options</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">setCoreBizThreads</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">16</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#000">restlight</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">options</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">setMaxBizThreads</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">32</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#8f5902;font-style:italic">// more...
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-059954cb572a468efbd896cacfc5535a">7 - Spring MVC 支持</h1>
    <div class="lead"><code>Restlight</code>支持了Spring MVC的使用习惯，你可以按照Spring MVC的方式使用Restlight</div>
	<p>引入依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-springmvc-provider<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b5c4403c41b916a6a8fec933ee64a2be">7.1 - Spring MVC 注解支持</h1>
    
	<h2 id="支持的注解">支持的注解</h2>
<ul>
<li><code>@Controller</code></li>
<li><code>@RestController</code></li>
<li><code>@RequestMapping</code></li>
<li><code>@GetMapping</code></li>
<li><code>@PostMapping</code></li>
<li><code>@PutMapping</code></li>
<li><code>@DeleteMapping</code></li>
<li><code>@PatchMapping</code></li>
<li><code>@ResponseStatus</code></li>
<li><code>@ControllerAdvice</code></li>
<li><code>@ExceptionHandler</code></li>
<li><code>@RequestParam</code></li>
<li><code>@RequestHeader</code></li>
<li><code>@PathVariable</code></li>
<li><code>@CookieValue</code></li>
<li><code>@MatrixVariable</code></li>
<li><code>@RequestAttribute</code></li>
</ul>
<h2 id="注解能力扩展">注解能力扩展</h2>
<p><code>@RequestParam</code>, <code>@ReqeustHeader</code>,<code>@PathVariable</code>,<code>@CookieValue</code>, <code>@MatrixVariable</code>,<code>@RequestAttribute</code></p>
<p>参数绑定相关注解除<code>SpringMVC</code>用法外，同时支持</p>
<h3 id="constructor接收一个string类型的参数"><code>Constructor</code>接收一个<code>String</code>类型的参数</h3>
<p>eg.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span> <span style="color:#000">User</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">str</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h3 id="存在静态的valueof或者fromstring方法">存在静态的<code>valueOf()</code>或者<code>fromString()</code>方法</h3>
<p>eg.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span> <span style="color:#000">User</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#5c35cc;font-weight:bold">@RequestHeader</span> <span style="color:#000">Car</span> <span style="color:#000">car</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">;</span>
    
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">User</span> <span style="color:#000">valueOf</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">str</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">User</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">();</span>
        <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Car</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">;</span>
    
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">Car</span> <span style="color:#000">fromString</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">str</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">Car</span> <span style="color:#000">car</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Car</span><span style="color:#ce5c00;font-weight:bold">();</span>
        <span style="color:#000">car</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">car</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h3 id="个别注解说明">个别注解说明</h3>
<h3 id="requestparam"><code>@RequestParam</code></h3>
<p>除普通用法外， 当未指定<code>value()</code>或者<code>name</code>且参数对象为<code>Map&lt;String, List&lt;String&gt;</code>类型时， 将整个ParameterMap（即AsyncRequest.getParameterMap）作为参数的值。</p>
<p>eg.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span> <span style="color:#000">Map</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">params</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    除url中的参数之外同时支持Post中Content-Type为application/x-www-form-urlencoded的form表单参数

</div>

<h3 id="cookievalue"><code>@CookieValue</code></h3>
<p>普通String类型</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@CookieValue</span> <span style="color:#000">String</span> <span style="color:#000">c</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>Cookie对象(io.netty.handler.codec.http.cookie.Cookie)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@CookieValue</span> <span style="color:#000">Cookie</span> <span style="color:#000">c</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>获取所有的Cookie</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@CookieValue</span> <span style="color:#000">Set</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Cookie</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">cookies</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h3 id="requestheader"><code>@RequestHeader</code></h3>
<p>除获取单个header之外， 可以如果参数类型为<code>io.netty.handler.codec.http.HttpHeaders</code>则以所有的Header作为参数的值</p>
<p>eg:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestHeader</span> <span style="color:#000">HttpHeaders</span> <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b82730f3e0626640346a00cd35e672dd">7.2 - ExceptionHandler支持</h1>
    
	<p><code>Restlight</code>支持业务自定义异常处理逻辑。对于Controller方法中抛出的异常，处理逻辑和顺序如下（<strong>注意：一个异常只会被处理一次</strong>）：</p>
<p>1.尝试在Controller内部查找异常处理方法来处理当前异常，未找到进入2
2.尝试寻找全局异常处理方法来处理当前异常，未找到则返回错误信息</p>
<h2 id="controller级异常处理">Controller级异常处理</h2>
<p>局部异常处理方法只能处理当前Controller中抛出的异常，示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RestController</span>
<span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/exception&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LocalExceptionResolver</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/willBeHandled&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">willBeHandled</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">IllegalArgumentException</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;IllegalArgumentException...&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/willNotBeHandled&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">willNotBeHandled</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RuntimeException</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RuntimeException...&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@ExceptionHandler</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">IllegalArgumentException</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">handleLocalException</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">IllegalArgumentException</span> <span style="color:#000">ex</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;HandleLocalException [&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ex</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getMessage</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;]&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>handleLocalException(XXX)</code>方法会处理当前类中所有的<code>IllegalArgumentException</code>异常。</p>
<h2 id="controlleradvice全局异常处理"><code>@ControllerAdvice</code>全局异常处理</h2>
<p>通过<code>@ControllerAdvice</code>或<code>@RestControllerAdvice</code>来标识全局异常处理类，并可通过相应的属性设置该全局异常处理类生效的范围。使用示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RestControllerAdvice</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">basePackages</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;esa.restlight.samples.starter.exceptionhandler&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;esa.restlight.samples.starter.controller&#34;</span><span style="color:#ce5c00;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">GlobalExceptionResolver</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@ExceptionHandler</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Exception</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Result</span> <span style="color:#000">handleException</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Exception</span> <span style="color:#000">ex</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Result</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">ok</span><span style="color:#ce5c00;font-weight:bold">();</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Result</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">String</span> <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">;</span>

        <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">Result</span> <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#000">Result</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Result</span><span style="color:#ce5c00;font-weight:bold">();</span>
            <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">status</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">;</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        
        <span style="color:#8f5902;font-style:italic">// getter and setter
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>如上所示， <code>handleException(XXX)</code>方法会处理<code>esa.restlight.samples.starter.exceptionhandler</code>和<code>esa.restlight.samples.starter.controller</code>包中抛出的所有<code>Exception</code>。</p>
<h2 id="高级使用">高级使用</h2>
<p>为了让用户更方便的使用异常处理， 类似的我们支持像Controller上一样的去使用一些注解的功能如 <code>@RequestParam</code>, <code>@RequestHeader</code>， <code>@CookieValue</code>等方便的进行参数绑定而不是自己手动的去Request里面取并做一次参数转换的操作。</p>
<p>eg:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@ControllerAdvice</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">GlobalExceptionResolver</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@ExceptionHandler</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Exception</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">handleException</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Exception</span> <span style="color:#000">ex</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// do something here...
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;HandleGlobalException [&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ex</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getMessage</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;]&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    由于流的特性，因此在Body中的数据如果已经被读取过后便不能进行再一次的读取。 因此这里无法满足类似<code>@RequestBody</code>的功能

</div>

<h2 id="异步异常处理器">异步异常处理器</h2>
<p>异常处理器可以类似Controller中异步处理一样完成异步的处理
<code>Restlight</code>异步支持</p>
<ul>
<li>CompletableFuture</li>
<li>ListenableFuture(Guava)</li>
<li>Future(io.netty.util.concurrent.Future)</li>
</ul>
<p>使用CompletableFuture异步方式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@ExceptionHanlder</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Exception</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">handleExcption</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Exception</span> <span style="color:#000">ex</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">supplyAsync</span><span style="color:#ce5c00;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Hello Restlight!&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">});</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>ListenableFuture(Guava)</code>与<code>Future(io.netty.util.concurrent.Future)</code>同理。</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-51578747ba64e4682c4eb004e2455bcb">8 - JAX-RS 支持</h1>
    <div class="lead"><code>Restlight</code>支持了JAX-RS的使用习惯，你可以按照JAX-RS的方式使用Restlight</div>
	<p>引入依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-jaxrs-provider<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1f76cd6f9a69602d8084fa71cdc12d89">8.1 - JAX-RS 注解支持</h1>
    
	<h2 id="支持的注解">支持的注解</h2>
<ul>
<li><code>@Path</code></li>
<li><code>@GET</code></li>
<li><code>@POST</code></li>
<li><code>@PUT</code></li>
<li><code>@DELETE</code></li>
<li><code>@HEAD</code></li>
<li><code>@PATCH</code></li>
<li><code>@OPTIONS</code></li>
<li><code>@Consumes</code></li>
<li><code>@Produces</code></li>
<li><code>@QueryParam</code></li>
<li><code>@PathParam</code></li>
<li><code>@HeaderParam</code></li>
<li><code>@MatrixParam</code></li>
<li><code>@CookieParam</code></li>
<li><code>@FormParam</code></li>
<li><code>@BeanParam</code></li>
<li><code>@DefaultValue</code></li>
</ul>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    现阶段<code>Restlight</code>仅实现了<code>JAX-RS</code>的注解， 其余功能暂未实现（<code>Provider</code>, <code>Request</code>, <code>Response</code>）等暂不支持

</div>

<h2 id="注解使用">注解使用</h2>
<p><code>@QueryParam</code>, <code>@PathParam</code>,<code>@HeaderParam</code>,<code>@MatrixParam</code>, <code>@MatrixVariable</code>,<code>@FormParam</code></p>
<p>参数绑不支持<code>javax.ws.rs.ext.ParamConverterProvier</code>扩展</p>
<h2 id="个别注解说明">个别注解说明</h2>
<h3 id="queryparam"><code>@QueryParam</code></h3>
<p>除普通用法外， 当未指定<code>value()</code>或者<code>name</code>且参数对象为<code>Map&lt;String, List&lt;String&gt;</code>类型时， 将整个ParameterMap（即AsyncRequest.getParameterMap）作为参数的值。</p>
<p>eg.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@QueryParam</span> <span style="color:#000">Map</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">params</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    除url中的参数之外同时支持Post中Content-Type为application/x-www-form-urlencoded的form表单参数

</div>

<h3 id="cookieparam"><code>@CookieParam</code></h3>
<p>普通<code>String</code>类型</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@CookieParam</span> <span style="color:#000">String</span> <span style="color:#000">c</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>Cookie</code>对象(io.netty.handler.codec.http.cookie.Cookie)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@CookieParam</span> <span style="color:#000">Cookie</span> <span style="color:#000">c</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>获取所有的<code>Cookie</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@CookieParam</span> <span style="color:#000">Set</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Cookie</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">cookies</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    不支持<code>JAX-RS</code>中的<code>jax.ws.rs.core.Cookie</code>， 仅支持<code>io.netty.handler.codec.http.cookie.Cookie</code>

</div>

<h3 id="headerparam"><code>@HeaderParam</code></h3>
<p>除获取单个header之外， 可以如果参数类型为<code>io.netty.handler.codec.http.HttpHeaders</code>则以所有的Header作为参数的值</p>
<p>eg:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@HeaderParam</span> <span style="color:#000">HttpHeaders</span> <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8974072c9131f7cb3574b326a1775aa7">9 - Restlight Server</h1>
    
	<h1 id="restlight-server">Restlight Server</h1>
<p><code>esa.restlight.server.Restlite</code>为<code>Restlight</code>架构中的<code>Restlight Server</code>模块的入口类， 在<code>ESA HttpServer</code>  基础上丰富了更多的功能</p>
<ul>
<li>引入业务线程池</li>
<li>基于<code>CompletableFuture</code>的响应式编程支持</li>
<li>线程调度</li>
<li><code>Filter</code></li>
<li>请求路由（根据url, method, header等条件将请求路由到对应的Handler）</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5c20dfad36c9a3e32cf52bbfeabc4b7c">9.1 - Quick Start</h1>
    
	<p>引入依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-server<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><p>一行代码启动一个Http Server</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">Restlite</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">forServer</span><span style="color:#ce5c00;font-weight:bold">()</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">daemon</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">deployments</span><span style="color:#ce5c00;font-weight:bold">()</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addRoute</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">route</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/hello&#34;</span><span style="color:#ce5c00;font-weight:bold">))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">handle</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span>
                        <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">sendResult</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hello Restlight!&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getBytes</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">StandardCharsets</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">UTF_8</span><span style="color:#ce5c00;font-weight:bold">))))</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">server</span><span style="color:#ce5c00;font-weight:bold">()</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">start</span><span style="color:#ce5c00;font-weight:bold">();</span>
</code></pre></div><p>运行并访问： http://localhost:8080/hello  即可看到输出：</p>
<pre tabindex="0"><code>Hello Restlight!
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-59e9b53c0526b840ef96ad105b9938d6">9.2 - 术语</h1>
    
	<h2 id="mapping"><code>Mapping</code></h2>
<p>表示一个请求匹配的条件， 用于确定一个请求是否能够路由到某个目标对对象。</p>
<p>eg.</p>
<p><code>curl -X GET http://localhost:8080/hello</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">Mapping</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/hello&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</code></pre></div><p><code>curl -X POST http://localhost:8080/foo?a=1</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">Mapping</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">post</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</code></pre></div><p><code>curl -X GET -H &quot;a:1&quot; -H &quot;Content-Type:application/json&quot; -H &quot;Accept:application/json&quot; http://localhost:8080/foo?a=1</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">Mapping</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">noneParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasHeader</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">noneHeader</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">consumes</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MediaType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">APPLICATION_JSON</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">produces</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MediaType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">APPLICATION_JSON</span><span style="color:#ce5c00;font-weight:bold">);</span>
</code></pre></div><h2 id="route"><code>Route</code></h2>
<p><code>Route</code>中包含了一个<code>Mapping</code>用于路由匹配， 一个请求都将期望路由到具体的一个<code>Route</code>， 如果找不到任何一个<code>Route</code>则响应一个<code>404</code>， 同时一个<code>Route</code>还负责请求本身的业务处理。</p>
<p>eg.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">Mapping</span> <span style="color:#000">mapping</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Mapping</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#000">Route</span> <span style="color:#000">route</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Route</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">route</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">mapping</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">handle</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">sendResult</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hello Restlight!&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getBytes</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">StandardCharsets</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">UTF_8</span><span style="color:#ce5c00;font-weight:bold">));</span>
        <span style="color:#ce5c00;font-weight:bold">})</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">onError</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">error</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// error occurred
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#ce5c00;font-weight:bold">}))</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">onComplete</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// request completed
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#ce5c00;font-weight:bold">}));</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-da94c7033d9aed7cdc97d0c04a53642a">9.3 - 请求处理</h1>
    
	<h2 id="业务处理">业务处理</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">Mapping</span> <span style="color:#000">mapping</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Mapping</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#000">Route</span> <span style="color:#000">route</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Route</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">route</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">mapping</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">handle</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// biz logic here
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">sendResult</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hello Restlight!&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getBytes</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">StandardCharsets</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">UTF_8</span><span style="color:#ce5c00;font-weight:bold">));</span>
        <span style="color:#ce5c00;font-weight:bold">});</span>
</code></pre></div><h2 id="异常处理">异常处理</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">Mapping</span> <span style="color:#000">mapping</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Mapping</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#000">Route</span> <span style="color:#000">route</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Route</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">route</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">mapping</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">handle</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// biz logic here
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">sendResult</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hello Restlight!&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getBytes</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">StandardCharsets</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">UTF_8</span><span style="color:#ce5c00;font-weight:bold">));</span>
        <span style="color:#ce5c00;font-weight:bold">})</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">onError</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">error</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// error occurred
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#ce5c00;font-weight:bold">}));</span>
</code></pre></div><h2 id="complete事件">Complete事件</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">Mapping</span> <span style="color:#000">mapping</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Mapping</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#000">Route</span> <span style="color:#000">route</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Route</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">route</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">mapping</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">handle</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// biz logic here
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">sendResult</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hello Restlight!&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getBytes</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">StandardCharsets</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">UTF_8</span><span style="color:#ce5c00;font-weight:bold">));</span>
        <span style="color:#ce5c00;font-weight:bold">})</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">onComplete</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// request completed
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#ce5c00;font-weight:bold">}));</span>
</code></pre></div><h2 id="异步">异步</h2>
<p><code>Route</code>请求处理生命周期均支持基于<code>Completablefuture</code>的异步使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">Route</span> <span style="color:#000">route</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">route</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">))</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">handleAsync</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span>
                <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">runAsync</span><span style="color:#ce5c00;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                    <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">}))</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">onErrorAsync</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">throwable</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span>
                <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">runAsync</span><span style="color:#ce5c00;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                    <span style="color:#8f5902;font-style:italic">// error
</span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">}))</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">onCompleteAsync</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span>
                <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">runAsync</span><span style="color:#ce5c00;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                    <span style="color:#8f5902;font-style:italic">// complete
</span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">}));</span>
</code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2fba84197e93865c2b955be1ea5d578d">10 - Restlight Core</h1>
    <div class="lead"><code>esa.restlight.core.Restlight</code>为<code>Restlight</code>架构中的<code>Restlight Core</code>模块的入口类， 在<code>Restlight Server</code> 基础上丰富了更多的功能</div>
	<ul>
<li><code>Controller</code></li>
<li><code>ControllerAdvice</code></li>
<li><code>HandlerInterceptor</code>: 拦截器</li>
<li><code>ExceptionHandler</code>: 全局异常处理器</li>
<li><code>BeanValidation</code>: 参数校验</li>
<li><code>ArgumentResolver</code>: 参数解析扩展</li>
<li><code>ArgumentResolverAdvice</code>: 参数解析扩展</li>
<li><code>ReturnValueResolver</code>: 返回值解析扩展</li>
<li><code>ReturnValueResolverAdvice</code>: 返回值解析扩展</li>
<li><code>RequestSerializer</code>: 请求序列化器（通常负责反序列化Body内容）</li>
<li><code>ResposneSerializer</code>: 响应序列化器（通常负责序列化响应对象到Body）</li>
<li>内置<code>Jackson</code>, <code>Fastjson</code>, <code>Gson</code>, <code>ProtoBuf</code>序列化支持</li>
<li>…</li>
</ul>
<p><code>Restlight Core</code>在<code>Restlight Server</code>中<code>Route</code>的业务处理部分做了封装， 完成拦截器，参数绑定，反序列化，返回值解析，序列化等一系列功能。</p>
<p><code>Restlight Core</code>为核心实现， 实际使用时需配合<code>Restlight SpringMVC</code>以及<code>Restlight JAX-RS</code>实现。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    <code>Restlight Core</code>拥有<code>Restlight Server</code>的所有特性， 具体功能特性请参考<code>Restlight Server</code>部分

</div>

<p>由于<code>Restlight Core</code>为标准实现， 需要配合<code>Restlight SpringMVC</code>或者<code>Restlight JAX-RS</code>一起使用</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ff50837446697282f95741f162ffbb69">10.1 - 配合 JAX-RS标准</h1>
    <div class="lead">基于<code>Restlight Core</code>为兼容<code>JAX-RS</code>注解使用习惯的扩展实现</div>
	<p>eg.</p>
<p>引入依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-core<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-jaxrs-provider<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><p>编写<code>Controller</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Path</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/hello&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">HelloController</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Path</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/restlight&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#5c35cc;font-weight:bold">@GET</span>
    <span style="color:#5c35cc;font-weight:bold">@Produces</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MediaType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">TEXT_PLAIN_VALUE</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">restlight</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Hello Restlight!&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>使用<code>Restlight</code>启动Server</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">Restlight</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">forServer</span><span style="color:#ce5c00;font-weight:bold">()</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">daemon</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">deployments</span><span style="color:#ce5c00;font-weight:bold">()</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addController</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HelloController</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">server</span><span style="color:#ce5c00;font-weight:bold">()</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">start</span><span style="color:#ce5c00;font-weight:bold">();</span>
</code></pre></div><p>启动并访问： http://localhost:8080/hello  即可看到输出：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">Hello Restlight!
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-931ecc71f9fd4e756da8447114ff66c6">10.2 - 配合 SpringMVC标准</h1>
    <div class="lead">基于<code>Restlight Core</code>为兼容<code>SpringMVC</code>注解使用习惯的扩展实现</div>
	<p>eg.</p>
<p>引入依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-core<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-springmvc-provider<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><p>编写<code>Controller</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/hello&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">HelloController</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/restlight&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">restlight</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Hello Restlight!&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>使用<code>Restlight</code>启动Server</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">Restlight</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">forServer</span><span style="color:#ce5c00;font-weight:bold">()</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">daemon</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">deployments</span><span style="color:#ce5c00;font-weight:bold">()</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addController</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HelloController</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">server</span><span style="color:#ce5c00;font-weight:bold">()</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">start</span><span style="color:#ce5c00;font-weight:bold">();</span>
</code></pre></div><p>启动并访问： http://localhost:8080/hello  即可看到输出：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">Hello Restlight!
</code></pre>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ee5784dcfab2e0323bad9468055e1922">11 - Restlight for Spring</h1>
    
	<p><code>esa.restlight.spring.Restlight4Spring</code>为<code>Restlight</code>架构中的<code>Restlight for Srping</code>模块的入口类， 在<code>Restlight Core</code> 基础上增强了自动配置功能</p>
<ul>
<li><code>Route</code>自动配置</li>
<li><code>Filter</code>自动配置</li>
<li><code>Controller</code>自动配置</li>
<li><code>ControllerAdvice</code>自动配置</li>
<li><code>HandlerInterceptor</code>自动配置</li>
<li><code>ExceptionHandler</code>自动配置</li>
<li><code>ArgumentResolver</code>自动配置</li>
<li><code>ArgumentResolverAdvice</code>自动配置</li>
<li><code>ReturnValueResolver</code>自动配置</li>
<li><code>ReturnValueResolverAdvice</code>自动配置</li>
<li><code>RequestSerializer</code>自动配置</li>
<li><code>ResposneSerializer</code>自动配置</li>
<li><code>Validator</code>自动配置</li>
<li>&hellip;</li>
</ul>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    <strong>自动配置</strong>是指<code>Restlight4Spring</code>会从<code>ApplicationContext</code>中获取对应类型的<code>bean</code>并配置到<code>Restlight</code>。

</div>


</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-799b06429c88ee149a863c616483aa23">11.1 - Quick Start</h1>
    
	<p>引入依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-spring<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>

<span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-springmvc-provider<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
	<span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><p>编写<code>Controller</code>并注入<code>Spring</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// Spring容器扫描并注入
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Controller</span>
<span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/hello&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">HelloController</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/restlight&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">restlight</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Hello Restlight!&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>使用<code>Restlight4Spring</code>启动Server</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">ApplicationContext</span> <span style="color:#000">context</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">...</span>
<span style="color:#000">Restlight4Spring</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">forServer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">daemon</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">server</span><span style="color:#ce5c00;font-weight:bold">()</span>
        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">start</span><span style="color:#ce5c00;font-weight:bold">();</span>
</code></pre></div><p>启动并访问： http://localhost:8080/hello 即可看到输出：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">Hello Restlight!
</code></pre>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    同理其他<code>Route</code>, <code>HandlerInterceptor</code>,<code>Filter</code>等也可直接注入到<code>Spring</code>并作为参数启动<code>Restlight4Spring</code>配置启动。

</div>


</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1ec1d9d90a306bd6c3db563eb4b68466">12 - 全链路异步</h1>
    <div class="lead">当前<code>Restlight</code>版本支持<code>Filter</code> ， <code>HandlerInterceptor</code>, <code>Controller</code>,  <code>ExceptionHandler</code>异步。</div>
	<p>对应处理链路</p>
<p><img src="../../img/execution.png" alt="restlightexecution.png"></p>
<p>上述对应着一个请求的完成执行链路， 并且每个链路都支持异步。</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-8286989c9c6f7a25228e264e138b0adf">12.1 - Restlight 异步保证</h1>
    <div class="lead"><code>Restlight</code>保证在框架层面对所有的<code>CompletableFuture</code>处理都不会主动的切换执行的线程</div>
	<p>这个保证使得用户无需担心不知道自己的代码将会在什么线程上执行。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    上面的保证意味着如果用字自己切换了执行的线程（通常异步可能都会做这个动作）， 那么这个节点以后的所有代码都将在切换后的线程上执行， 而不是在<code>Restlight</code>的业务线程池。

</div>

<p><strong>例</strong></p>
<p>用户在<code>HandlerInterceptor</code>中写下了如下代码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">Executor</span> <span style="color:#000">customExecutor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">...;</span>
            
<span style="color:#5c35cc;font-weight:bold">@Override</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Boolean</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">preHandle0</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                             <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                             <span style="color:#000">Object</span> <span style="color:#000">handler</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// 线程切换到 customExecutor并回调Restlight
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">supplyAsync</span><span style="color:#ce5c00;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// ....
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">},</span> <span style="color:#000">customExecutor</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>其中当执行<code>HandlerInterceptor.preHandle(xxx)</code>时用户使用了自定义的线程池作为异步实现，并在完成操作后回调<code>Restlight</code>， 后续所有<code>Controller</code>, <code>ExceptionHandler</code>等操作都将在<code>customExecutor</code>的线程上执行（除非用户主动切换）</p>
<p>下面的<code>Controller</code>将会在<code>customExecutor</code>的线程上被调用， 而不是业务线程池</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/test&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Hello Restlight!&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>如果需要回到业务线程池执行则需要用户自行通过<code>CompletableFuture</code>进行操作</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/test&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// 回到业务线程池执行Controller逻辑
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">supplyAsync</span><span style="color:#ce5c00;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span>  <span style="color:#4e9a06">&#34;Hello Restlight!&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">},</span> <span style="color:#000">bizExecutor</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-90151b09924b0376f5d61f29b762a7fb">12.2 - CompletableFuture使用注意</h1>
    
	<ul>
<li><code>CompletableFuture</code>中<strong>不带</strong><code>xxxAsync(xxx)</code>的方法默认会在当前线程执行(当前线程指的是调用<code>CompletableFuture.complete(xxx)</code>或者<code>CompletableFuture.completeExceptionally(xxx)</code>的线程)， 因此此种方式<code>CompletableFuture</code>的线程执行策略为尽量不切换线程（这里的尽量并不是完全一定， 因为如果当前future已经为完成的状态那么<code>CompletableFuture</code>会直接执行后续逻辑）</li>
<li><code>CompletableFuture</code>中<strong>带</strong><code>xxxAsync(xxx)</code>的方法要求传入一个<code>Executor</code>， 后续回掉逻辑将在这个<code>Executor</code>中执行。 默认不传的情况下会使用<code>ForkJoinPool</code>中的公共线程池。 因此应当对所有的<code>xxxAsync(xxx)</code>方法调用格外注意， 一旦使用了错误的线程池可能导致隔离性的缺失， 性能不符合预期等问题。</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5e5b9f61f0f7f7fb8ed94c8171f3d4c3">13 - 使用注意</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-613abba4559bbdeed69f0ef4359da516">13.1 - Controller 语义不能重复</h1>
    
	<p>出于性能考虑，Restlight中的所有<code>RequestMapping</code>的path属性不允许有语义上的重复（除非业务能容忍这个问题）， 如果存在语义上的重复Restlight既不会在启动时报错提示，也不保证真正调用时的<code>稳定性</code>。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    这里的<code>稳定性</code>指的是不保证任何的优先级，比如Controller A和Controller B重复，Restlight不保证真正调用的时候会调用Controller A或者Controller B。

</div>

<ul>
<li>错误示例1：</li>
</ul>
<pre tabindex="0"><code>@RequestMapping(&quot;/foo&quot;)
public void foo() {
    // ...
}

@PostMapping(&quot;/foo&quot;)
public void foo1() {
    // ...
}
</code></pre>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    Controller中的path重复

</div>

<ul>
<li>错误示例2：</li>
</ul>
<pre tabindex="0"><code>@RequestMapping(&quot;/foo/{bar}&quot;)
public void foo(@PathVariable String bar) {
    // ...
}

@PostMapping(&quot;/foo/bar&quot;)
public void foo1() {
    // ...
}
</code></pre>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    Controller中的<code>@PathVariable</code>与第二个Congroller的path重复

</div>



<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    同样的道理，如果Controller语义存在相交的语义（可能存在使用复杂的正则等方式定义的Controller接口，因此可能存在相交的情况）也适用。

</div>

<p>Restlight检测到歧义时会打印WARNING日志</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-284e4996350ddb637239358989d135ad">13.2 - 大文件上传</h1>
    <div class="lead">当前版本<code>Restlight</code>会将收到的文件存在内存之中，请勿上传超大文件。</div>
	
</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="mailto:esa.stack@oppo.com" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/esastack/esa-restlight" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="mailto:esa.stack@oppo.com" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 OPPO ESA Stack Project All Rights Reserved</small>
        
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>


















<script src="/js/main.min.7380160122c24d59789a168af05fcec445fe4e5f2069dd9f3a0c991f10269ae0.js" integrity="sha256-c4AWASLCTVl4mhaK8F/OxEX&#43;Tl8gad2fOgyZHxAmmuA=" crossorigin="anonymous"></script>






  </body>
</html>
