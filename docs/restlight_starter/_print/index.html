<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.92.2" />
<link rel="canonical" type="text/html" href="/docs/restlight_starter/">
<link rel="alternate" type="application/rss&#43;xml" href="/docs/restlight_starter/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Restlight Starter | ESA Restlight</title>
<meta name="description" content="`Restlight Starter`是在`Restlight Spring` 基础上封装的`Spring Boot Starter`，提供基于`Spring Boot`的自动配置
">
<meta property="og:title" content="Restlight Starter" />
<meta property="og:description" content="`Restlight Starter`是在`Restlight Spring` 基础上封装的`Spring Boot Starter`，提供基于`Spring Boot`的自动配置
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/restlight_starter/" /><meta property="og:site_name" content="ESA Restlight" />

<meta itemprop="name" content="Restlight Starter">
<meta itemprop="description" content="`Restlight Starter`是在`Restlight Spring` 基础上封装的`Spring Boot Starter`，提供基于`Spring Boot`的自动配置
"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Restlight Starter"/>
<meta name="twitter:description" content="`Restlight Starter`是在`Restlight Spring` 基础上封装的`Spring Boot Starter`，提供基于`Spring Boot`的自动配置
"/>




<link rel="preload" href="/scss/main.min.d6e0d5abc6f6a3c1d53dbb7d3961f4afa416f54a6cd0393408d9a241c4e351fa.css" as="style">
<link href="/scss/main.min.d6e0d5abc6f6a3c1d53dbb7d3961f4afa416f54a6cd0393408d9a241c4e351fa.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg id="layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 180 180" style="enable-background:new 0 0 180 180"><style>.st0{fill-rule:evenodd;clip-rule:evenodd;fill:#fff}.st1{opacity:.6;fill-rule:evenodd;clip-rule:evenodd;fill:#fff;enable-background:new}.st2{opacity:.3;fill-rule:evenodd;clip-rule:evenodd;fill:#fff;enable-background:new}</style><g><path class="st0" d="M127.6 95.9c-11-2.2-23.9-3.5-37.7-3.5-13.9.0-26.8 1.2-37.7 3.5 11 2.2 23.9 3.5 37.7 3.5S116.7 98 127.6 95.9zM135.8 97.8c-12.7 3.2-28.6 5.2-45.9 5.2s-33.3-2-45.9-5.2c-2.1.5-4.1 1.1-5.9 1.7-6.5 2.2-11.6 4.7-14.9 7.3-3.3 2.6-4.4 4.9-4.4 6.8s1.1 4.2 4.4 6.8 8.4 5.2 14.9 7.3c13.1 4.3 31.5 7 51.8 7s38.7-2.7 51.8-7c6.5-2.2 11.6-4.7 14.9-7.3s4.4-4.9 4.4-6.8-1.1-4.2-4.4-6.8-8.4-5.2-14.9-7.3C139.9 98.9 137.9 98.3 135.8 97.8z"/><path class="st1" d="M120.9 59.2C111.5 57.7 101 57 89.8 57c-11.1.0-21.7.9-31.1 2.2 9.4 1.5 19.9 2.2 31.1 2.2C101 61.5 111.5 60.7 120.9 59.2zm10 1.8c-11.8 2.6-25.9 4.1-41 4.1-15.2.0-29.2-1.5-41-4.1-3.9.9-7.5 1.9-10.9 3-6.5 2.2-11.6 4.7-14.9 7.3-3.3 2.6-4.4 4.9-4.4 6.8s1.1 4.2 4.4 6.8c3.3 2.6 8.4 5.2 14.9 7.3 13.1 4.3 31.5 7 51.8 7s38.7-2.7 51.8-7c6.5-2.2 11.6-4.7 14.9-7.3s4.4-4.9 4.4-6.8-1.1-4.2-4.4-6.8-8.4-5.2-14.9-7.3C138.4 63 134.8 62 130.9 61z"/><path class="st2" d="M161.1 40.3c0 1.9-1.1 4.2-4.4 6.8-3.3 2.6-8.4 5.2-14.9 7.3-13.1 4.3-31.5 7-51.8 7s-38.7-2.7-51.8-7c-6.5-2.2-11.6-4.7-14.9-7.3s-4.4-4.9-4.4-6.8 1.1-4.2 4.4-6.8 8.4-5.2 14.9-7.3c13.1-4.3 31.5-7 51.8-7s38.7 2.7 51.8 7c6.5 2.2 11.6 4.7 14.9 7.3S161.1 38.5 161.1 40.3z"/></g></svg></span><span class="font-weight-bold">ESA Restlight</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/docs/" ><i class='fas fa-book pr-2'></i><span>Docs</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/blog/" ><i class='fas fa-rss pr-2'></i><span>Blog</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://github.com/esastack/esa-restlight" target="_blank" ><i class='fab fa-github pr-2'></i><span>Github</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://www.esastack.io" target="_blank" ><span>ESA Stack</span></a>
			</li>
			





			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/restlight_starter/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Restlight Starter</h1>
<div class="lead"><code>Restlight Starter</code>是在<code>Restlight Spring</code> 基础上封装的<code>Spring Boot Starter</code>，提供基于<code>Spring Boot</code>的自动配置</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-c6aa8ed6af6ef375dd529ead4f9cca8c">Thread-Scheduling</a></li>


    
  
    
    
	
<li>2: <a href="#pg-72cde9e9f6520682a45a68478c63e442">Filter</a></li>


    
  
    
    
	
<li>3: <a href="#pg-68b4b6523c0ff76294cf7103653a3a0e">RouteFilter</a></li>


    
  
    
    
	
<li>4: <a href="#pg-abe1b969b7c2a7e5316ed26baa01b5e8">拦截器</a></li>


    
  
    
    
	
<li>5: <a href="#pg-c228fb93ca30d57dd5fa1784526870b6">异常处理</a></li>


    
  
    
    
	
<li>6: <a href="#pg-9181d5b4172837035f479b6f69e5b6b7">参数解析</a></li>


    
  
    
    
	
<li>7: <a href="#pg-66c895ce1c5192d8ed9f784eb6236616">ParamResolverAdvice</a></li>


    
  
    
    
	
<li>8: <a href="#pg-af285ddf474d6b5f80c7050980144a3a">请求实体数据解析</a></li>


    
  
    
    
	
<li>9: <a href="#pg-8698babfd01ce93769dd1caa52f66ac7">RequestResolverAdvice</a></li>


    
  
    
    
	
<li>10: <a href="#pg-6f3f9cd0374987ce6989ed293cabeacc">返回值解析</a></li>


    
  
    
    
	
<li>11: <a href="#pg-2a69ffb60454029db167ea0699e955ba">ResponseResolverAdvice</a></li>


    
  
    
    
	
<li>12: <a href="#pg-73e10d9bdafbed062d04a7ae327d2229">序列化</a></li>


    
  
    
    
	
<li>13: <a href="#pg-f98524641db12d9f69bc3a63ee6f4649">请求参数聚合</a></li>


    
  
    
    
	
<li>14: <a href="#pg-15adb1f15406c89ddc0f504afb67714b">URL参数聚合</a></li>


    
  
    
    
	
<li>15: <a href="#pg-8491f86999f6b7591eee11761502c1a0">Context Path</a></li>


    
  
    
    
	
<li>16: <a href="#pg-2d62b7aa8e1eca9bf6a0801bc5f14074">Aware扩展</a></li>


    
  
    
    
	
<li>17: <a href="#pg-96c4371ff98f8a260892c1b9f27ee09b">路由缓存</a></li>


    
  
    
    
	
<li>18: <a href="#pg-4b2ddfd87c9683a4228d4a7f607fad08">快速失败</a></li>


    
  
    
    
	
<li>19: <a href="#pg-00806bebd264f4ab6a8752deb8fde3f3">Mock测试</a></li>


    
  
    
    
	
<li>20: <a href="#pg-8bbf607bf55ab234484ca9e6f4ca15c4">辅助配置</a></li>


    
  
    
    
	
<li>21: <a href="#pg-b2dc3803615c85a9c04d46f40ac36997">配置一览</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-c6aa8ed6af6ef375dd529ead4f9cca8c">1 - Thread-Scheduling</h1>
    
	<p><img src="../../../img/threading_model.png" alt="ThreadingModel"></p>
<p>线程调度允许用户根据需要随意制定<code>Controller</code>在<code>IO</code>线程上执行还是在<code>Biz</code>线程上执行还是在自定义线程上运行。</p>
<h2 id="使用scheduled注解进行线程调度">使用<code>@Scheduled</code>注解进行线程调度</h2>
<p>eg.</p>
<p>在<code>IO</code>线程上执行</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Scheduled</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Schedulers</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">IO</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">io</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ....
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>在<code>BIz</code>线程上执行</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// 在业务线程池中执行
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Scheduled</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Schedulers</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">BIZ</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/bar&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">biz</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ....
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>不加注解默认Scheduler上执行</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/baz&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">bizBatching</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ....
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="自定义scheduler">自定义<code>Scheduler</code></h2>
<p>将<code>Scheduler</code>实现注入<code>Spring</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Scheduler</span> <span style="color:#000">scheduler</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Schedulers</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">fromExecutor</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Executors</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">newCachedThreadPool</span><span style="color:#ce5c00;font-weight:bold">());</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>在自定义<code>Scheduler</code>上执行</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// 在业务线程池中执行
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Scheduled</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ....
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    <ul>
<li>自定义<code>Scheduler</code>时请勿使用<code>IO</code>, <code>BIZ</code>, <code>Restlight</code>等作为name（作为<code>Restlight</code>中<code>Scheduler</code>的保留字)</li>
<li>定义线程池建议使用<code>RestlightThreadFactory</code>以获得更高的性能</li>
</ul>


</div>



<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    基于<code>ThreadPoolExecutor</code>类型自定义<code>Scheduler</code>时， 不管是否设置<code>RejectExecutionHandler</code>，<code>Restlight</code>都会覆盖<code>ThreadPoolExecutor</code>中的<code>RejectExecutionHandler</code>， 即不允许用户自定义实现<code>RejectExecutionHandler</code>实现拒绝策略（因为<code>Restlight</code>需要保证每个请求都能被正确的完成，否则可能会导致链接等资源无法被释放等问题）， 相反如果自定义实现<code>Scheduler</code>时请保证每个请求都被正确的完成。

</div>

<h2 id="配置">配置</h2>
<p>所有配置均以<code>restlight.server.scheduling</code>开头</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>默认</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>default-scheduler</td>
<td>BIZ</td>
<td>在不加<code>@Scheduled</code>注解时采用的Scheduler</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-72cde9e9f6520682a45a68478c63e442">2 - Filter</h1>
    <div class="lead"><code>Filter</code>在接收到完整请求之后，路由匹配开始之前执行。</div>
	<h2 id="基本使用">基本使用</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Filter</span> <span style="color:#000">addHeaderFilter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Filter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletionStage</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Void</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">doFilter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">FilterContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">FilterChain</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">request</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">headers</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">set</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">doFilter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    自定义<code>FilterFactory</code>将其注入Spring容器或者配置成可以被SPI加载的方式也可以实现<code>Filter</code>注入。

</div>

<p>上面的例子将会给所有到来的请求都加上一个固定的Header。</p>
<h2 id="异步filter">异步<code>Filter</code></h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Filter</span> <span style="color:#000">filter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Filter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletionStage</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Void</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">doFilter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">FilterContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">FilterChain</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">runAsync</span><span style="color:#ce5c00;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#8f5902;font-style:italic">// do something...
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#ce5c00;font-weight:bold">}).</span><span style="color:#c4a000">thenCompose</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#8f5902;font-style:italic">// invoke next filter
</span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">doFilter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#ce5c00;font-weight:bold">});</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>上面的例子演示了在<code>doFilter(xxx)</code>中进行异步操作，并在该操作完成后回调<code>FilterChain</code>继续执行后续操作。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    上面演示的异步只是开了一个新的线程， 实际场景中可使用<code>Netty</code>等实现更优雅的异步方式。

</div>

<h2 id="终止filter的执行">终止<code>Filter</code>的执行</h2>
<p>当不期望执行后续的<code>Filter</code>时可返回一个<code>CompletableFuture.completedFuture(null)</code>实例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Override</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Void</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">doFilter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">FilterContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">FilterChain</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">completedFuture</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    <ul>
<li><code>doFilter(xxx)</code>请勿返回<code>null</code></li>
<li>所有方法都将会在IO线程上调用，尽量不要阻塞， 否则将对性能会有较大的影响。</li>
</ul>


</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-68b4b6523c0ff76294cf7103653a3a0e">3 - RouteFilter</h1>
    <div class="lead"><code>RouteFilter</code>在路由匹配成功后执行。</div>
	<h2 id="基本使用">基本使用</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">RouteFilter</span> <span style="color:#000">addHeaderFilter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RouteFilter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletionStage</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Void</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">routed</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HandlerMapping</span> <span style="color:#000">mapping</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">RouteContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">RouteFilterChain</span> <span style="color:#000">next</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#000">String</span> <span style="color:#000">handleName</span><span style="color:#ce5c00;font-weight:bold">;</span>
            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">handleName</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mapping</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">methodInfo</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">handlerMethod</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">method</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">getName</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">equals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">request</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">headers</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">set</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;handlerName&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">handleName</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#ce5c00;font-weight:bold">}</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">next</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">doNext</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">mapping</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>上面的例子将会在路由匹配完成后，对所有<code>Handler</code>方法名称为<code>get</code>的方法的请求都加上一个固定的Header。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    自定义<code>RouteFilterFactory</code>将其注入Spring容器或者配置成可以被SPI加载的方式也可以实现<code>RouteFilter</code>注入。

</div>

<h2 id="异步routefilter">异步<code>RouteFilter</code></h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">RouteFilter</span> <span style="color:#000">routeFilter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RouteFilter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletionStage</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Void</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">routed</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HandlerMapping</span> <span style="color:#000">mapping</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">RouteContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">RouteFilterChain</span> <span style="color:#000">next</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">runAsync</span><span style="color:#ce5c00;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#8f5902;font-style:italic">// do something...
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#ce5c00;font-weight:bold">}).</span><span style="color:#c4a000">thenCompose</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#8f5902;font-style:italic">// invoke next filter
</span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">next</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">doNext</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">mapping</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#ce5c00;font-weight:bold">});</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>上面的例子演示了在<code>routed(xxx, xxx)</code>中进行异步操作，并在该操作完成后回调<code>RouteFilterChain</code>继续执行后续操作。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    上面演示的异步只是开了一个新的线程， 实际场景中可使用<code>BIZ Scheduler</code>等实现更优雅的异步方式。

</div>

<h2 id="终止routefilter的执行">终止<code>RouteFilter</code>的执行</h2>
<p>当不期望执行后续的<code>RouteFilter</code>时可返回一个<code>CompletableFuture.completedFuture(null)</code>实例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Override</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletionStage</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Void</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">routed</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HandlerMapping</span> <span style="color:#000">mapping</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">RouteContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">RouteFilterChain</span> <span style="color:#000">next</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">completedFuture</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    <ul>
<li><code>routed(xxx)</code>请勿返回<code>null</code></li>
</ul>


</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-abe1b969b7c2a7e5316ed26baa01b5e8">4 - 拦截器</h1>
    
	<p><code>Restlight</code>支持多种拦截器，适用于不同性能/功能场景</p>
<ul>
<li>RouteInterceptor</li>
<li>MappingInterceptor</li>
<li>HandlerInterceptor</li>
<li>InterceptorFactory</li>
</ul>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    实现对应的拦截器接口并注入Spring即可

</div>



<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    在<code>Interceptor#preHandle0()</code>和<code>Interceptor#postHandle0()</code>中直接通过throw抛出的异常将不会被
异常处理器处理，如果需要被正常处理，请使用<code>CompletableFuture.completeExceptionally()</code>封装异常

</div>

<h2 id="拦截器定位">拦截器定位</h2>
<p>面向<code>Controller/Route</code>， 同时支持按需匹配的拦截器</p>
<ol>
<li><strong>面向<code>Controller/Route</code></strong>: 拦截器一定能让用户根据需求选择匹配到哪个<code>Controller</code>接口</li>
<li><strong>按需匹配</strong>： 支持按照<code>RequestContext</code>条件让用户灵活决定拦截器的匹配规则</li>
</ol>
<h2 id="internalinterceptor"><code>InternalInterceptor</code></h2>
<p>核心拦截器实现， 封装了拦截器核心行为</p>
<ul>
<li>
<p><code>CompletableFuture&lt;Boolean&gt; preHandle0(RequestContext, Object)</code></p>
<p><code>Controller</code>执行前执行。返回布尔值表示是否允许当前请求继续往下执行。</p>
</li>
<li>
<p><code>CompletableFuture&lt;Void&gt; postHandle0(RequestContext, Object)</code></p>
<p><code>Controller</code>刚执行完之后执行</p>
</li>
<li>
<p><code>CompletableFuture&lt;Void&gt; afterCompletion0(RequestContext, Object, Exception)</code></p>
<p>请求行完之后执行</p>
</li>
<li>
<p><code>int getOrder()</code></p>
<p>返回当前拦截器的优先级（默认为最低优先级），我们保证<code>getOrder</code>返回值决定拦截器的执行顺序，但是不支持使用<code>@Order(int)</code>注解情况下的顺序（虽然有时候看似顺序和<code>@Order</code>一致，但那只是巧合）。</p>
</li>
</ul>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <ul>
<li>框架在真正执行拦截器调用的时候只会调用上述方法(而不是<code>preHandle(xxx)</code>, <code>postHandle(xxx)</code>, <code>afterCompletion(xxx)</code>)</li>
<li>请勿直接使用此接口，此接口仅仅是拦截器的核心实现类</li>
</ul>


</div>

<h2 id="拦截器匹配">拦截器匹配</h2>
<p><strong>初始化阶段</strong>： 初始化阶段为每一个<code>Controller</code>确定所有可能匹配到当前<code>Controller</code>的拦截器列表（包含可能匹配以及一定会匹配到当前<code>Controller</code>的拦截器）。</p>
<p><strong>运行时阶段</strong>： 一个请求到来时通过将<code>RequestContext</code>作为参数传递到拦截器做路由判定，决定是否匹配。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    通过初始化与运行时两个阶段的匹配行为扩展满足用户多样性匹配需求， 用户既可以直接将拦截器绑定到固定的<code>Controller</code>也可以让拦截器随心所欲的根据请求去选择匹配。

</div>

<h3 id="affinity亲和性"><code>Affinity</code>亲和性</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">Affinity</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Current component is always attaching with the target subject.
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ATTACHED</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Current component has a high affinity with the target subject this is the highest value.
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">HIGHEST</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Current component has no affinity with the target subject.
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">DETACHED</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Gets the affinity value.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @return affinity.
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">affinity</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>用于表达拦截器与<code>Controller/Route</code>之间的亲和性</p>
<ul>
<li><code>affinity()</code>小于0表示拦截器<strong>不可能</strong>与<code>Controller</code>匹配</li>
<li><code>affinity()</code>等于0表示拦截器<strong>一定</strong>会与<code>Controller</code>匹配</li>
<li><code>affinity()</code>大于0表示拦截器<strong>可能</strong>会与<code>Controller</code>匹配， 并且值越小匹配可能性越高（因此1为最高可能性）， 相反值越大匹配可能性越小， 同时匹配的开销越大（用于拦截器匹配性能优化）。</li>
</ul>
<h3 id="interceptorpredicate"><code>InterceptorPredicate</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">InterceptorPredicate</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">RequestPredicate</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">InterceptorPredicate</span> <span style="color:#000">ALWAYS</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">context</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">Boolean</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">TRUE</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RequestPredicate</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Predicate</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">RequestContext</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ignore this
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">mayAmbiguousWith</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestPredicate</span> <span style="color:#000">another</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>test(RequestContext)</code>方法用于对每个请求的匹配。可以满足根据<code>RequestContext</code>运行时的任意条件的匹配（而不仅仅是局限于<code>URL</code>匹配）</p>
<h2 id="interceptor"><code>Interceptor</code></h2>
<p><code>Interceptor</code>接口为同时拥有<code>Affinity</code>（<code>Controller/Route</code>匹配）以及<code>InterceptorPredicate</code>（请求<code>RequestContext</code>匹配）的接口</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">Interceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">InternalInterceptor</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Affinity</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    
    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Gets the predicate of current interceptor. determines whether current interceptor should be matched to a {@link
</span><span style="color:#8f5902;font-style:italic">     * RequestContext}.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @return predicate, or {@code null} if {@link #affinity()} return&#39;s a negative value.
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">InterceptorPredicate</span> <span style="color:#000">predicate</span><span style="color:#ce5c00;font-weight:bold">();</span>
    
    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Default to highest affinity.
</span><span style="color:#8f5902;font-style:italic">     * &lt;p&gt;
</span><span style="color:#8f5902;font-style:italic">     * Whether a {@link Interceptor} should be matched to a {@link Route} is depends on it.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @return affinity
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">affinity</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>由于<code>int affinity()</code>根据不同的<code>Controller/Route</code>可能得出不同的结果， 因此需要使用<code>InterceptorFactory</code>进行创建</p>
<p>eg.</p>
<p>实现一个拦截器， 拦截所有GET接口（仅包含GET）且Header中包含<code>X-Foo</code>请求头的请求</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">InterceptorFactory</span> <span style="color:#000">interceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">route</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">Optional</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">of</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Interceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletionStage</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Boolean</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">preHandle0</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Object</span> <span style="color:#000">handler</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">completedFuture</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">InterceptorPredicate</span> <span style="color:#000">predicate</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">context</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">request</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">headers</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">contains</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;X-Foo&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">affinity</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#000">HttpMethod</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">route</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">mapping</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">method</span><span style="color:#ce5c00;font-weight:bold">();</span>
            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">length</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">HttpMethod</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">GET</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ATTACHED</span><span style="color:#ce5c00;font-weight:bold">;</span>
            <span style="color:#ce5c00;font-weight:bold">}</span>
             <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">DETACHED</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">});</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    运行时仅在<code>context.request().headers().contains(&quot;X-Foo&quot;)</code>上做匹配， 性能损耗极低。

</div>

<h2 id="routeinterceptor"><code>RouteInterceptor</code></h2>
<p>只绑定到固定的<code>Controller/Route</code>的拦截器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RouteInterceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">InternalInterceptor</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Gets the affinity value between current interceptor and the given {@link Routing}.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param ctx   context
</span><span style="color:#8f5902;font-style:italic">     * @param route route to match
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @return affinity value.
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">match</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">DeployContext</span> <span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Routing</span> <span style="color:#000">route</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    运行时无性能损耗， 用于需要将拦截器固定的绑定到<code>Controller</code>的场景， 这里的<code>boolean match(xx)</code>方法返回的<code>true</code>和<code>false</code>实际上相当于<code>Affinity</code>接口返回<code>Affinity.ATTACHED</code>以及<code>Affinity.DETACHED</code>（即只有一定匹配和一定不匹配）

</div>

<p>eg.
实现一个拦截器， 拦截所有GET请求（仅包含GET）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">RouteInterceptor</span> <span style="color:#000">interceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RouteInterceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
  
    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">match</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">DeployContext</span> <span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Routing</span> <span style="color:#000">route</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">HttpMethod</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">route</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">mapping</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">method</span><span style="color:#ce5c00;font-weight:bold">();</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">length</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">HttpMethod</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">GET</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
    
    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletionStage</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Boolean</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">preHandle0</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Object</span> <span style="color:#000">handler</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">completedFuture</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="mappinginterceptor"><code>MappingInterceptor</code></h2>
<p>绑定到所有<code>Controller/Route</code>， 并匹配请求的拦截器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">MappingInterceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">InternalInterceptor</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">InterceptorPredicate</span> <span style="color:#ce5c00;font-weight:bold">{</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>相当于<code>affinity()</code>固定返回<code>Affinity.ATTACHED</code></p>
<p>eg.</p>
<p>实现一个拦截器， 拦截所有Header中包含<code>X-Foo</code>请求头的请求</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">MappingInterceptor</span> <span style="color:#000">interceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">MappingInterceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletionStage</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Boolean</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">preHandle0</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Object</span> <span style="color:#000">handler</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">completedFuture</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">test</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">request</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">headers</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">contains</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;X-Foo&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="handlerinterceptor"><code>HandlerInterceptor</code></h2>
<p>支持基于<code>URI</code>匹配的拦截器接口</p>
<ul>
<li><code>includes()</code>: 指定拦截器作用范围的Path， 默认作用于所有请求。</li>
<li><code>excludes()</code>: 指定拦截器排除的Path（优先级高于<code>includes</code>）默认为空。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">HandlerInterceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">InternalInterceptor</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#000">String</span> <span style="color:#000">PATTERN_FOR_ALL</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/**&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">includes</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">excludes</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    涉及到正则匹配， 会有较大性能损失， 且仅支持URI匹配。

</div>

<p>eg.</p>
<p>实现一个拦截器， 拦截除<code>/foo/bar</code>意外所有<code>/foo/</code>开头的请求</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HandlerInterceptor</span> <span style="color:#000">interceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">HandlerInterceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletionStage</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Boolean</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">preHandle0</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Object</span> <span style="color:#000">handler</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">completedFuture</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">includes</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;/foo/**&#34;</span><span style="color:#ce5c00;font-weight:bold">};</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">excludes</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;/foo/bar&#34;</span><span style="color:#ce5c00;font-weight:bold">};</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="interceptorfactory"><code>InterceptorFactory</code></h2>
<p>拦截器工厂类， 用于为每一个<code>Controller/Route</code>生成一个<code>Interceptor</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">InterceptorFactory</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Create an instance of {@link Interceptor} for given target handler before starting Restlight server..
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param ctx deploy context
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param route target route.
</span><span style="color:#8f5902;font-style:italic">     * @return interceptor
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">Optional</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Interceptor</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">create</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">DeployContext</span> <span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Routing</span> <span style="color:#000">route</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c228fb93ca30d57dd5fa1784526870b6">5 - 异常处理</h1>
    
	<h2 id="spring-mvc异常处理">Spring MVC异常处理</h2>
<p><a href="../../springmvc_support/">Restlight for Spring MVC</a>支持使用Spring MVC中的<code>@ExceptionHandler</code>, <code>@ControllerAdvice</code>等注解，并且对此能力进行了增强
参考<a href="../../springmvc_support/exception_handler">ExceptionHandler支持</a></p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    仅在项目引入了<code>restlight-springmvc-provider</code>依赖的情况下使用（默认引入）

</div>

<h2 id="exceptionresolver"><code>ExceptionResolver</code></h2>
<p>eg.</p>
<p>处理<code>RuntimeException</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Component</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">GlobalExceptionResolver</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">ExceptionResolver</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">RuntimeException</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletionStage</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Void</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">handleException</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">RuntimeException</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// handle exception here
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">completedFuture</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    处理不同异常类型实现不同的<code>ExceptionResolver&lt;T extends Throwable&gt;</code>

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9181d5b4172837035f479b6f69e5b6b7">6 - 参数解析</h1>
    <div class="lead">参数解析指从请求中解析出<code>Controller</code>参数值的过程（不包含请求实体数据的解析）</div>
	<p>典型的有</p>
<ul>
<li><code>@RequestParam</code></li>
<li><code>@RequestHeader</code></li>
<li><code>@PathVariable</code></li>
<li><code>@CookieValue</code></li>
<li><code>@MatrixVariable</code></li>
<li><code>@QueryBean</code></li>
<li><code>RequestContext</code></li>
<li><code>HttpRequest</code></li>
<li><code>HttpResponse</code></li>
</ul>
<h2 id="接口定义">接口定义</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ParamResolver</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Resolver</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Resolves method parameter into an argument value.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param context context
</span><span style="color:#8f5902;font-style:italic">     * @return value resolved
</span><span style="color:#8f5902;font-style:italic">     * @throws Exception ex
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">Object</span> <span style="color:#000">resolve</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>框架会在启动的初始化阶段试图为每一个Controller中的每一个参数都找到一个与之匹配的<code>ParamResolver</code>用于请求的参数解析。</p>
<h2 id="框架如何确定paramresolver">框架如何确定<code>ParamResolver</code></h2>
<h3 id="paramresolveradapter"><code>ParamResolverAdapter</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ParamPredicate</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Whether current {@link ParamResolver} implementation is support given parameter.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param param param
</span><span style="color:#8f5902;font-style:italic">     * @return {@code true} if it supports
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">);</span>

<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ParamResolverAdapter</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ParamPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ParamResolver</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>初始化逻辑：</p>
<ol>
<li>按照<code>getOrder()</code>方法的返回将Spring容器中所有的<code>ParamResolver</code>进行排序</li>
<li>按照排序后的顺序依次调用<code>supports(Param param)</code>方法， 返回<code>true</code>则将其作为该参数的<code>ParamResolver</code>，运行时每次请求都将调用<code>resolve(RequestContext context)</code>方法进行参数解析，并且运行时不会改变。</li>
<li>未找到则启动报错。</li>
</ol>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <ul>
<li>如果需要解析请求Body内容请参考<a href="../requestentity_resolver">请求实体数据解析</a></li>
</ul>


</div>

<p>细心的人可能会发现该设计可能并不能覆盖到以下场景</p>
<ul>
<li>因为<code>resolve(RequestContext context)</code>方法参数中并没有传递<code>Param</code>参数， 虽然初始化阶段能根据<code>supports(Param param)</code>方法获取参数元数据信息（获取某个注解，获取参数类型等等）判断是否支持，但是如果运行时也需要获取参数的元数据信息（某个注解的值等）的话，此接口则无法满足需求。</li>
<li>假如<code>ParamResolver</code>实现中需要做序列化操作， 因此期望获取到Spring容器中的序列化器时，则该接口无法支持。</li>
</ul>
<p>针对此问题，答案是确实无法支持。因为<code>Restlight</code>的设计理念是</p>
<ul>
<li><code>能在初始化阶段解决的问题就在初始化阶段解决</code></li>
</ul>
<p>因此不期望用户以及<code>Restlight</code>的开发人员大量的在运行时去频繁获取一些JVM启动后就不会变动的内容(如： 注解的值)，甚至针对某些元数据信息使用<code>ConcurrentHashMap</code>进行缓存（看似是为了提高性能的缓存，实际上初始化就固定了的内容反而增加了并发性能的损耗）。</p>
<p>基于以上原因我们提供了另一个<code>ParamResolver</code>的实现方式</p>
<h3 id="paramresolverfactory"><code>ParamResolverFactory</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ParamResolverFactory</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ParamPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#000">ParamResolver</span> <span style="color:#000">createResolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                 <span style="color:#000">StringConverterProvider</span> <span style="color:#000">converters</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                 <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">HttpRequestSerializer</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">serializers</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>与上面的<code>ParamResolver</code>类似</p>
<p>初始化逻辑：</p>
<ol>
<li>按照<code>getOrder()</code>方法的返回将所有的<code>ParamResolverFactory</code>进行排序</li>
<li>按照排序后的顺序依次调用<code>supports(Param param)</code>方法，返回<code>true</code>则将其作为该参数的<code>ParamResolverFactory</code>，同时调用<code>createResolver(Param param, StringConverterProvider converters, List&lt;? extends HttpRequestSerializer&gt; serializers)</code>方法创建出对应的<code>ParamResolver</code></li>
<li>未找到则启动报错。</li>
</ol>
<p>由于初始化时通过<code>createResolver(Param param, StringConverterProvider converters, List&lt;? extends HttpRequestSerializer&gt; serializers)</code>方法传入了<code>Param</code>以及序列化器，因此能满足上面的要求。</p>
<p><strong>两种模式的定位</strong></p>
<ul>
<li><code>ParamResolver</code>： 适用于参数解析器不依赖方法元数据信息以及序列化的场景。例如： 如果参数上使用了@XXX注解则返回某个固定的值。</li>
<li><code>ParamResolverFactory</code>： 适用于参数解析器依赖方法元数据信息以及序列化的场景。例如： <code>@RequestParameter(name = &quot;foo&quot;)</code>。</li>
</ul>
<h2 id="自定义参数解析器">自定义参数解析器</h2>
<p>将自定义实现的<code>ParamResolverAdapter</code>或者<code>ParamResolverFactory</code>注入到Spring容器即可。</p>
<ul>
<li><code>ParamResolverAdapter</code>案例</li>
</ul>
<p>场景： 当参数上有<code>@AppId</code>注解时， 使用固定的AppId</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// 自定义注解
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Target</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ElementType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">PARAMETER</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Retention</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RetentionPolicy</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">RUNTIME</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Documented</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#5c35cc;font-weight:bold">@interface</span> <span style="color:#000">AppId</span> <span style="color:#ce5c00;font-weight:bold">{</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">ParamResolver</span> <span style="color:#000">resolver</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ParamResolverAdapter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// 当方法上有此注解时生效
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AppId</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Object</span> <span style="color:#000">resolve</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;your appid&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>controller使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@AppId</span> <span style="color:#000">String</span> <span style="color:#000">appId</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">appId</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div><p>上面的代码自定义实现了依据自定义注解获取固定appId的功能</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    自定义<code>ParamResolverAdapter</code>比框架自带的优先级高（如<code>@RequestHeader</code>，<code>@RequestParam</code>等），如果匹配上了自定义实现，框架默认的功能在当前参数上将不生效。

</div>

<ul>
<li><code>ParamResolverFactory</code></li>
</ul>
<p>场景： 通过自定义注解获取固定前缀x-custom的Header</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// 自定义注解
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Target</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ElementType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">PARAMETER</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Retention</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RetentionPolicy</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">RUNTIME</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Documented</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#5c35cc;font-weight:bold">@interface</span> <span style="color:#000">CustomHeader</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">String</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">ParamResolverFactory</span> <span style="color:#000">resolver</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ParamResolverFactory</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">ParamResolver</span> <span style="color:#000">createResolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                            <span style="color:#000">StringConverterProvider</span> <span style="color:#000">converters</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                            <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">HttpRequestSerializer</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">serializers</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Resolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// 当方法上有此注解时生效
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">CustomHeader</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>


<span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * 实际ParamResolver实现
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Resolver</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">ParamResolver</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">String</span> <span style="color:#000">headerName</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Resolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">CustomHeader</span> <span style="color:#000">anno</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">CustomHeader</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">anno</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">value</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">length</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">IllegalArgumentException</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Name of header must not be empty.&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#8f5902;font-style:italic">// 初始化时组装好需要的参数
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">headerName</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;x-custom&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">anno</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">value</span><span style="color:#ce5c00;font-weight:bold">();</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Object</span> <span style="color:#000">resolve</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// 运行时直接获取Header
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">request</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">headers</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">headerName</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div><p>controller使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@CustomHeader</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    自定义<code>ParamResolverFactory</code>比框架自带的优先级高（如<code>@RequestHeader</code>，<code>@RequestParam</code>等）， 如果匹配上了自定义实现，框架默认的功能在当前参数上将不生效。

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-66c895ce1c5192d8ed9f784eb6236616">7 - ParamResolverAdvice</h1>
    
	<p><code>ParamResolverAdvice</code>允许用户在<code>ParamResolver</code>参数解析器解析参数的前后添加业务逻辑以及修改解析后的参数。</p>
<h2 id="接口定义">接口定义</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ParamResolverAdvice</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * This method is called around {@link ParamResolver#resolve(RequestContext)}.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param context context
</span><span style="color:#8f5902;font-style:italic">     * @return resolved arg value
</span><span style="color:#8f5902;font-style:italic">     * @throws Exception exception
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">Object</span> <span style="color:#000">aroundResolve</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ParamResolverContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="自定义paramresolveradvice">自定义<code>ParamResolverAdvice</code></h2>
<p>与<code>ParamResolver</code>相同，<code>ParamResolverAdvice</code>自定应时同样需要实现<code>ParamResolverAdviceAdapter</code>或<code>ParamResolverAdviceFactory</code>接口</p>
<h3 id="方式1实现-paramresolveradviceadapter">方式1：实现 <code>ParamResolverAdviceAdapter</code></h3>
<p>接口定义</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ParamResolverAdviceAdapter</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ParamPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ParamResolverAdvice</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Ordered</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h3 id="方式2实现paramresolveradvicefactory">方式2：实现<code>ParamResolverAdviceFactory</code></h3>
<p>接口定义</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ParamResolverAdviceFactory</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ParamPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Creates an instance of {@link ParamResolverAdvice} for given handler method.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param param    method
</span><span style="color:#8f5902;font-style:italic">     * @param resolver paramResolver associated with this parameter
</span><span style="color:#8f5902;font-style:italic">     * @return advice
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">ParamResolverAdvice</span> <span style="color:#000">createResolverAdvice</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ParamResolver</span> <span style="color:#000">resolver</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>ParamResolverAdviceAdapter</code>接口以及<code>ParamResolverAdviceFactory</code>接口与<code>ParamResolver</code>中的<code>ParamResolverAdapter</code>接口以及<code>ParamResolverFactory</code>接口的使用方式相同，这里不过多赘述。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <code>ParamResolverAdvice</code>与<code>ParamResolver</code>生命周期是相同的, 即应用初始化的时候便会决定每个参数的<code>ParamResolverAdvice</code>

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-af285ddf474d6b5f80c7050980144a3a">8 - 请求实体数据解析</h1>
    <div class="lead">请求实体数据解析指将请求body的内容反序列化并解析出<code>Controller</code>参数值的过程。</div>
	<p>典型的有</p>
<ul>
<li><code>@RequestBody</code></li>
</ul>
<h2 id="接口定义">接口定义</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RequestEntityResolver</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Resolver</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Deserialize the given {@code entity} to result.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param entity  entity
</span><span style="color:#8f5902;font-style:italic">     * @param context context
</span><span style="color:#8f5902;font-style:italic">     * @return resolved value, which must not be null.
</span><span style="color:#8f5902;font-style:italic">     * @throws Exception any exception
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">HandledValue</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Object</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">readFrom</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestEntity</span> <span style="color:#000">entity</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div><p>框架会在启动的初始化阶段试图为每一个Controller中的每一个参数都找到一个与之匹配的<code>RequestEntityResolver</code>用于请求的参数解析。</p>
<h2 id="框架如何确定requestentityresolver">框架如何确定<code>RequestEntityResolver</code></h2>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Note</h4>

    <p>框架在<strong>初始化阶段</strong>会预先通过<code>ParamPredicate#supports(Param param)</code>来确定一组可以用来处理给定方法参数的<code>RequestEntityResolver</code>
并进行排序，在<strong>运行过程中</strong>仍可在执行<code>RequestEntityResolver#readFrom(RequestEntity entity, RequestContext context)</code>
过程中再次进行判断，如果当前<code>RequestEntityResolver</code>不支持处理当前请求的实体内容解析，则可以直接返回<code>HandledValue.failed()</code>，框架将继续尝试下一个优先级的
<code>RequestEntityResolver</code>，直至遍历完所有跟当前方法绑定的<code>RequestEntityResolver</code>。</p>
<blockquote>
<p>需要说明地是：1.大部分场景下在初始化阶段绑定到<code>Param</code>上的<code>RequestEntityResolver</code>在运行时均不需要再次进行判断，
可以直接进行处理（这也是框架默认的行为），只有在特殊的场景下，请求执行过程中参数的改变将影响到请求实体内容解析逻辑的时候才需要在
实际处理过程中进行二次匹配，比如<code>JAX-RS</code>标准中定义的行为。2.下文所展示的均为初始化绑定的使用方式。</p>
</blockquote>


</div>

<h3 id="requestentityresolveradapter"><code>RequestEntityResolverAdapter</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ParamPredicate</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Whether current {@link ParamResolver} implementation is support given parameter.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param param param
</span><span style="color:#8f5902;font-style:italic">     * @return {@code true} if it supports
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">);</span>

<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RequestEntityResolverAdapter</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">RequestEntityResolver</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ParamPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Ordered</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>初始化逻辑：</p>
<ol>
<li>按照<code>getOrder()</code>方法的返回将Spring容器中所有的<code>RequestEntityResolver</code>进行排序</li>
<li>按照排序后的顺序依次调用<code>supports(Param param)</code>方法， 返回<code>true</code>则将其作为该参数的<code>RequestEntityResolver</code>，运行时每次请求都将按优先级顺序调用<code>readFrom(RequestEntity entity, RequestContext context)</code>方法进行参数解析，直至处理成功。</li>
<li>未找到则启动报错。</li>
</ol>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <ul>
<li>如果需要解析其他<code>Controller</code>参数请求参考<a href="../param_resolver">参数解析</a></li>
</ul>


</div>

<p>细心的人可能会发现该设计可能并不能覆盖到以下场景</p>
<ul>
<li>因为<code>readFrom(RequestEntity entity, RequestContext context)</code>方法参数中并没有传递<code>Param</code>参数， 虽然初始化阶段能根据<code>supports(Param param)</code>方法获取参数元数据信息（获取某个注解，获取参数类型等等）判断是否支持，但是如果运行时也需要获取参数的元数据信息（某个注解的值等）的话，此接口则无法满足需求。</li>
<li>假如<code>RequestEntityResolver</code>实现中需要做序列化操作， 因此期望获取到Spring容器中的序列化器时，则该接口无法支持。</li>
</ul>
<p>针对此问题，答案是确实无法支持。因为<code>Restlight</code>的设计理念是</p>
<ul>
<li><code>能在初始化阶段解决的问题就在初始化阶段解决</code></li>
</ul>
<p>因此不期望用户以及<code>Restlight</code>的开发人员大量的在运行时去频繁获取一些JVM启动后就不会变动的内容(如： 注解的值)，甚至针对某些元数据信息使用<code>ConcurrentHashMap</code>进行缓存（看似是为了提高性能的缓存，实际上初始化就固定了的内容反而增加了并发性能的损耗）。</p>
<p>基于以上原因我们提供了另一个<code>RequestEntityResolver</code>的实现方式</p>
<h3 id="paramresolverfactory"><code>ParamResolverFactory</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RequestEntityResolverFactory</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ParamPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#000">RequestEntityResolver</span> <span style="color:#000">createResolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                         <span style="color:#000">StringConverterProvider</span> <span style="color:#000">converters</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                         <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">HttpRequestSerializer</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">serializers</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>与上面的<code>RequestEntityResolver</code>类似</p>
<p>初始化逻辑：</p>
<ol>
<li>按照<code>getOrder()</code>方法的返回将所有的<code>RequestEntityResolverFactory</code>进行排序</li>
<li>按照排序后的顺序依次调用<code>supports(Param param)</code>方法，返回<code>true</code>则将其作为该参数的<code>RequestEntityResolverFactory</code>，同时调用<code>createResolver(Param param, List&lt;? extends HttpRequestSerializer&gt; serializers)</code>方法创建出对应的<code>RequestEntityResolver</code></li>
<li>未找到则启动报错。</li>
</ol>
<p>由于初始化时通过<code>createResolver(Param param, List&lt;? extends HttpRequestSerializer&gt; serializers)</code>方法传入了<code>Param</code>以及序列化器，因此能满足上面的要求。</p>
<p><strong>两种模式的定位</strong></p>
<ul>
<li><code>RequestEntityResolver</code>： 适用于参数解析器不依赖方法元数据信息以及序列化的场景。例如： 如果参数上使用了@XXX注解则返回某个固定的值。</li>
<li><code>RequestEntityResolverFactory</code>： 适用于参数解析器依赖方法元数据信息以及序列化的场景。</li>
</ul>
<h2 id="自定义参数解析器">自定义参数解析器</h2>
<p>将自定义实现的<code>RequestEntityResolverAdapter</code>或者<code>RequestEntityResolverFactory</code>注入到Spring容器即可。</p>
<ul>
<li><code>RequestEntityResolverAdapter</code>案例</li>
</ul>
<p>场景： 当参数上有<code>@Pojo</code>注解时，使用固定的pojo</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// 自定义注解
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Target</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ElementType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">PARAMETER</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Retention</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RetentionPolicy</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">RUNTIME</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Documented</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#5c35cc;font-weight:bold">@interface</span> <span style="color:#000">Pojo</span> <span style="color:#ce5c00;font-weight:bold">{</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">Pojo</span> <span style="color:#000">pojo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Pojo</span><span style="color:#ce5c00;font-weight:bold">();</span>

<span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">RequestEntityResolver</span> <span style="color:#000">resolver</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RequestEntityResolverAdapter</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HandledValue</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Object</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">readFrom</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestEntity</span> <span style="color:#000">entity</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HandledValue</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">succeed</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">pojo</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Pojo</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>controller使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Pojo</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@Pojo</span> <span style="color:#000">Pojo</span> <span style="color:#000">pojo</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pojo</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div><p>上面的代码自定义实现了依据自定义注解获取固定Pojo的功能</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    自定义<code>RequestEntityResolverAdapter</code>比框架自带的优先级高（如<code>@RequestBody</code>），如果匹配上了自定义实现，框架默认的功能在当前参数上将不生效。

</div>

<ul>
<li><code>RequestEntityResolverFactory</code></li>
</ul>
<p>场景： 通过自定义注解解析请求实体数据并将将解析后的POJO的name设置为固定值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// 自定义注解
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Target</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ElementType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">PARAMETER</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Retention</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RetentionPolicy</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">RUNTIME</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Documented</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#5c35cc;font-weight:bold">@interface</span> <span style="color:#000">CustomPojo</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">String</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">RequestEntityResolverFactory</span> <span style="color:#000">resolver</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RequestEntityResolverFactory</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">RequestEntityResolver</span> <span style="color:#000">createResolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                    <span style="color:#000">StringConverterProvider</span> <span style="color:#000">converters</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                    <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">HttpRequestSerializer</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">serializers</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Resolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// 当方法上有此注解时生效
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">CustomPojo</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * 实际RequestEntityResolver实现
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Resolver</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">RequestEntityResolver</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">HttpRequestSerializer</span> <span style="color:#000">serializer</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">String</span> <span style="color:#000">fixedName</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Resolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HttpRequestSerializer</span> <span style="color:#000">serializer</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">CustomPojo</span> <span style="color:#000">anno</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">CustomPojo</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">anno</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">value</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">length</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">IllegalArgumentException</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Name of header must not be empty.&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#8f5902;font-style:italic">// 初始化时组装好需要的参数
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">fixedName</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">anno</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">value</span><span style="color:#ce5c00;font-weight:bold">();</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">serializer</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">serializer</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HandledValue</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Object</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">readFrom</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestEntity</span> <span style="color:#000">entity</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">HandledValue</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Object</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">handled</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">serializer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">deserialize</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">entity</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">handled</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">isSuccess</span><span style="color:#ce5c00;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#000">Pojo</span> <span style="color:#000">pojo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Pojo</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">handled</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">value</span><span style="color:#ce5c00;font-weight:bold">();</span>
            <span style="color:#000">pojo</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">fixedName</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">handled</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div><p>controller使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Pojo</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@CustomPojo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">Pojo</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    自定义<code>RequestEntityResolverFactory</code>比框架自带的优先级高（如<code>@RequestBody</code>），如果匹配上了自定义实现，框架默认的功能在当前参数上将不生效。

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8698babfd01ce93769dd1caa52f66ac7">9 - RequestResolverAdvice</h1>
    <div class="lead"><code>RequestEntityResolverAdvice</code>允许用户在<code>RequestEntityResolver</code>返回值处理的前后添加业务逻辑。</div>
	<h2 id="接口定义">接口定义</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RequestEntityResolverAdvice</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * This method will be called around
</span><span style="color:#8f5902;font-style:italic">     * {@link RequestEntityResolver#readFrom(RequestEntity, RequestContext)}.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param context context
</span><span style="color:#8f5902;font-style:italic">     * @return object   resolved value
</span><span style="color:#8f5902;font-style:italic">     * @throws Exception exception
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">Object</span> <span style="color:#000">aroundRead</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestEntityResolverContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="自定义requestentityresolveradvice">自定义<code>RequestEntityResolverAdvice</code></h2>
<p>与<code>RequestEntityResolver</code>相同，<code>RequestEntityResolverAdvice</code>自定应时同样需要实现<code>RequestEntityResolverAdviceAdapter</code>或<code>RequestEntityResolverAdviceFactory</code>接口</p>
<h3 id="方式1-实现requestentityresolveradviceadapter">方式1 实现<code>RequestEntityResolverAdviceAdapter</code></h3>
<p>接口定义</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RequestEntityResolverAdviceAdapter</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">RequestEntityResolverAdvice</span><span style="color:#ce5c00;font-weight:bold">,</span>
        <span style="color:#000">ParamPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Ordered</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>


</code></pre></div><h3 id="方式2实现requestentityresolveradvicefactory">方式2：实现<code>RequestEntityResolverAdviceFactory</code></h3>
<p>接口定义</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RequestEntityResolverAdviceFactory</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ParamPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 生成RequestEntityResolverAdvice
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">RequestEntityResolverAdvice</span> <span style="color:#000">createResolverAdvice</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Param</span> <span style="color:#000">param</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>RequestEntityResolverAdviceAdapter</code>接口以及<code>RequestEntityResolverAdviceFactory</code>接口与<code>RequestEntityResolver</code>中的<code>RequestEntityResolverAdapter</code>接口以及<code>RequestEntityResolverFactory</code>接口的使用方式相同，这里不过多赘述。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6f3f9cd0374987ce6989ed293cabeacc">10 - 返回值解析</h1>
    <div class="lead">返回值解析指将<code>Controller</code>返回值序列化并写入到<code>HttpResponse</code>中的过程。</div>
	<h2 id="返回值解析逻辑">返回值解析逻辑</h2>
<p>Restlight默认支持的返回值解析方式包括</p>
<ul>
<li><code>@ResponseBody</code></li>
<li><code>@ResponseStatus</code></li>
<li>普通类型(String, byte[], int 等)</li>
</ul>
<p>与参数解析类似， 每个功能都对应了一个返回值解析器的实现。</p>
<h2 id="接口定义"><strong>接口定义</strong></h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ResponseEntityResolver</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 解析出对应返回值并通过channel写回
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">HandledValue</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Void</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">writeTo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ResponseEntity</span> <span style="color:#000">entity</span><span style="color:#ce5c00;font-weight:bold">,</span>
                               <span style="color:#000">ResponseEntityChannel</span> <span style="color:#000">channel</span><span style="color:#ce5c00;font-weight:bold">,</span>
                               <span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Tip</h4>

    <blockquote>
<p>考虑到直接实现<code>ResponseEntityResolver</code>接口实现的复杂性，在实际使用时建议直接继承<code>AbstractResponseEntityResolver</code>类并重写
其中的模版方法<code>serialize(ResponseEntity entity, List&lt;MediaType&gt; mediaTypes, RequestContext context)</code>将返回值序列化成byte[]，
其余的操作由<code>AbstractResponseEntityResolver</code>自动完成，下文示例均采用该种方式。</p>
</blockquote>


</div>

<p>框架会在启动的初始化阶段试图为每一个Controller中的每一个参数都找到一组与之匹配的<code>ResponseEntityResolver</code>用于响应的返回值解析。</p>
<h2 id="框架如何确定responseentityresolver">框架如何确定<code>ResponseEntityResolver</code></h2>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Note</h4>

    <p>框架在<strong>初始化阶段</strong>会预先通过<code>HandlerPredicate#supports(HandlerMethod method)</code>来确定一组可以用来处理给定方法返回值的<code>ResponseEntityResolver</code>
并进行排序，在<strong>运行过程中</strong>仍可在执行<code>ResponseEntityResolver#writeTo(ResponseEntity entity, ResponseEntityChannel channel, RequestContext context)</code>
过程中再次进行判断，如果当前<code>ResponseEntityResolver</code>不支持处理当前请求的返回值，则可以直接返回<code>HandledValue.failed()</code>，框架将继续尝试下一个优先级的
<code>ResponseEntityResolver</code>，直至遍历完所有跟当前方法绑定的<code>ResponseEntityResolver</code>。</p>
<blockquote>
<p>需要说明地是：1.大部分场景下在初始化阶段绑定到<code>HandlerMethod</code>上的<code>ResponseEntityResolver</code>在运行时均不需要再次进行判断，
可以直接进行处理（这也是框架默认的行为），只有在特殊的场景下，请求执行过程中参数的改变将影响到返回值解析逻辑的时候才需要在
实际处理过程中进行二次匹配，比如<code>JAX-RS</code>标准中定义的行为。2.下文所展示的均为初始化绑定的使用方式。</p>
</blockquote>


</div>

<h3 id="responseentityresolveradapter"><code>ResponseEntityResolverAdapter</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">HandlerPredicate</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 判断当前ResponseEntityResolver是否支持给定HandlerMethod解析
</span><span style="color:#8f5902;font-style:italic">     * 每一个Controller都对应一个HandlerMethod实例， 
</span><span style="color:#8f5902;font-style:italic">     * 可以通过HandlerMethod获取注解, 返回值类型等各类反射相关的元数据信息
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HandlerMethod</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">);</span>

<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ResponseEntityResolverAdapter</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ResponseEntityResolver</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">HandlerPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Ordered</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>初始化逻辑：</p>
<ol>
<li>按照<code>getOrder()</code>方法的返回将Spring容器中所有的<code>ResponseEntityResolverAdapter</code>进行排序</li>
<li>按照排序后的顺序依次调用<code>supports(HandlerMethod method)</code>方法， 返回<code>true</code>则将其作为该参数的<code>ResponseEntityResolver</code>，运行时每次请求都将按顺序调用<code>writeTo(ResponseEntity entity, ResponseEntityChannel channel, RequestContext context)</code>方法进行返回值处理，直至处理成功。</li>
<li>未找到则启动报错。</li>
</ol>
<p>细心的人可能会发现该设计可能并不能覆盖到以下场景</p>
<ul>
<li>因为<code>writeTo(ResponseEntity entity, ResponseEntityChannel channel, RequestContext context)</code>方法参数中并没有传递<code>HandlerMethod</code>参数，虽然初始化阶段能根据<code>HandlerMethod method</code>方法获取Controller方法元数据信息（获取某个注解，获取参数类型等等）判断是否支持，但是如果运行时也需要获取Controller方法的元数据信息（某个注解的值等）的话，此接口则无法满足需求。</li>
<li>假如<code>ResponseEntityResolverAdapter</code>实现中需要做序列化操作，因此期望获取到Spring容器中的序列化器时，则该接口无法支持。</li>
</ul>
<p>针对以上问题， 答案是确实无法支持。因为<code>Restlight</code>的设计理念是</p>
<ul>
<li><code>能在初始化阶段解决的问题就在初始化阶段解决</code></li>
</ul>
<p>因此不期望用户以及<code>Restlight</code>的开发人员大量的在运行时去频繁获取一些JVM启动后就不会变动的内容(如： 注解的值)， 甚至针对某些元数据信息使用<code>ConcurrentHashMap</code>进行缓存（看似是为了提高性能的缓存， 实际上初始化就固定了的内容反而增加了并发性能的损耗）。</p>
<p>基于以上原因我们提供了另一个<code>ResponseEntityResolver</code>的实现方式</p>
<h3 id="responseentityresolverfactory"><code>ResponseEntityResolverFactory</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ResponseEntityResolverFactory</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">HandlerPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#000">ResponseEntityResolver</span> <span style="color:#000">createResolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HandlerMethod</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                          <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">HttpResponseSerializer</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">serializers</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>与上面的<code>ResponseEntityResolver</code>类似</p>
<p>初始化逻辑：</p>
<ol>
<li>按照<code>getOrder()</code>方法的返回将所有的<code>ResponseEntityResolverFactory</code>进行排序</li>
<li>按照排序后的顺序依次调用<code>supports(HandlerMethod method)</code>方法，返回<code>true</code>则将其作为该参数的<code>ResponseEntityResolverFactory</code>，同时调用<code>createResolver(HandlerMethod method, List&lt;? extends HttpResponseSerializer&gt; serializers)</code>方法创建出对应的<code>ResponseEntityResolver</code></li>
<li>未找到则启动报错。</li>
</ol>
<p>由于初始化时通过<code>createResolver(HandlerMethod method, List&lt;? extends HttpResponseSerializer&gt; serializers)</code>方法传入了<code>HandlerMethod</code>以及序列化器，因此能满足上面的要求。</p>
<p><strong>两种模式的定位</strong></p>
<ul>
<li><code>ResponseEntityResolver</code>： 适用于解析器不依赖方法元数据信息以及序列化的场景。例如： 如果Controller方法上上使用了@XXX注解则返回某个固定的值。</li>
<li><code>ResponseEntityResolverFactory</code>： 适用于解析器依赖方法元数据信息以及序列化的场景。例如： @ResponseBody， @ResponseStatus(reason = &ldquo;error&rdquo;)。</li>
</ul>
<h2 id="自定义返回值解析器">自定义返回值解析器</h2>
<p>将自定义实现的<code>ResponseEntityResolverAdapter</code>或者<code>ResponseEntityResolverFactory</code>注入到Spring容器即可。</p>
<ul>
<li><code>ResponseEntityResolverAdapter</code>案例</li>
</ul>
<p>场景： 当Controller方法上有<code>@AppId</code>注解时， 返回固定的AppId</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// 自定义注解
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Target</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ElementType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">METHOD</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Retention</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RetentionPolicy</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">RUNTIME</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Documented</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#5c35cc;font-weight:bold">@interface</span> <span style="color:#000">AppId</span> <span style="color:#ce5c00;font-weight:bold">{</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">ResponseEntityResolver</span> <span style="color:#000">resolver</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">APP_ID</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;your appid&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getBytes</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">StandardCharsets</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">UTF_8</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbstractResponseEntityResolver</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">protected</span> <span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">serialize</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ResponseEntity</span> <span style="color:#000">entity</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                   <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">MediaType</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">mediaTypes</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                   <span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">APP_ID</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HandlerMethod</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// 当方法上有此注解时生效
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasMethodAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AppId</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>controller使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@AppId</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div><p>上面的代码自定义实现了依据自定义注解获取固定appId的功能</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    自定义<code>ResponseEntityResolverAdapter</code>比框架自带的优先级高（如<code>@ResponseBody</code>），如果匹配上了自定义实现，框架默认的功能在当前方法上上将不生效。

</div>

<ul>
<li><code>ResponseEntityResolverFactory</code></li>
</ul>
<p>场景： 通过自定义注解对所有String类型的返回值加上一个指定前缀。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">// 自定义注解
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@Target</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ElementType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">METHOD</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Retention</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RetentionPolicy</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">RUNTIME</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Documented</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#5c35cc;font-weight:bold">@interface</span> <span style="color:#000">Suffix</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">String</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#5c35cc;font-weight:bold">@Bean</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">ResponseEntityResolverFactory</span> <span style="color:#000">resolver</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ResponseEntityResolverFactory</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    
            <span style="color:#5c35cc;font-weight:bold">@Override</span>
            <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">ResponseEntityResolver</span> <span style="color:#000">createResolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HandlerMethod</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                         <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">HttpResponseSerializer</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">serializers</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Resovler</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#ce5c00;font-weight:bold">}</span>
            
            <span style="color:#5c35cc;font-weight:bold">@Override</span>
            <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HandlerMethod</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">equals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">method</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">getReturnType</span><span style="color:#ce5c00;font-weight:bold">())</span> 
                        <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasMethodAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">CustomHeader</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#ce5c00;font-weight:bold">};</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 实际ResponseEntityResolver实现
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Resolver</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AbstractResponseEntityResolver</span> <span style="color:#ce5c00;font-weight:bold">{</span>

        <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">String</span> <span style="color:#000">suffix</span><span style="color:#ce5c00;font-weight:bold">;</span>

        <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Resolver</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HandlerMethod</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// 获取前缀
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">Suffix</span> <span style="color:#000">anno</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getMethodAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Suffix</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">suffix</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">anno</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">value</span><span style="color:#ce5c00;font-weight:bold">();</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>

        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">protected</span> <span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">serialize</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ResponseEntity</span> <span style="color:#000">entity</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                   <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">MediaType</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">mediaTypes</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                   <span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// 拼接
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">suffix</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">entity</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">entity</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">getBytes</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">StandardCharsets</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">UTF_8</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>controller使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Suffix</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    自定义<code>ResponseEntityResolverFactory</code>比框架自带的优先级高（如<code>@ResponseBody</code>），如果匹配上了自定义实现，框架默认的功能在当前方法上上将不生效。

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2a69ffb60454029db167ea0699e955ba">11 - ResponseResolverAdvice</h1>
    <div class="lead"><code>ResponseEntityResolverAdvice</code>允许用户在<code>ResponseEntityResolver</code>返回值处理的前后添加业务逻辑。</div>
	<h2 id="接口定义">接口定义</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ResponseEntityResolverAdvice</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * This method will be called around
</span><span style="color:#8f5902;font-style:italic">     * {@link ResponseEntityResolver#writeTo(ResponseEntity, ResponseEntityChannel, RequestContext)}.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param context context
</span><span style="color:#8f5902;font-style:italic">     * @throws Exception exception
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">aroundWrite</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ResponseEntityResolverContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="自定义responseentityresolveradvice">自定义<code>ResponseEntityResolverAdvice</code></h2>
<p>与<code>ResponseEntityResolver</code>相同，<code>ResponseEntityResolverAdvice</code>自定应时同样需要实现<code>ResponseEntityResolverAdviceAdapter</code>或<code>ResponseEntityResolverAdviceFactory</code>接口</p>
<h3 id="方式1-实现responseentityresolveradviceadapter">方式1 实现<code>ResponseEntityResolverAdviceAdapter</code></h3>
<p>接口定义</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ResponseEntityResolverAdviceAdapter</span>
        <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">HandlerPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ResponseEntityResolverAdvice</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">supports</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HandlerMethod</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Ordered</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div><h3 id="方式2实现responseentityresolveradvicefactory">方式2：实现<code>ResponseEntityResolverAdviceFactory</code></h3>
<p>接口定义</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ResponseEntityResolverAdviceFactory</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ResponseEntityPredicate</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * 生成ResponseEntityResolverAdvice
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">ResponseEntityResolverAdvice</span> <span style="color:#000">createResolverAdvice</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HandlerMethod</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">HIGHEST_PRECEDENCE</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p><code>ResponseEntityResolverAdviceAdapter</code>接口以及<code>ResponseEntityResolverAdviceFactory</code>接口与<code>ResponseEntityResolver</code>中的<code>ResponseEntityResolverAdapter</code>接口以及<code>ResponseEntityResolverFactory</code>接口的使用方式相同，这里不过多赘述。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-73e10d9bdafbed062d04a7ae327d2229">12 - 序列化</h1>
    
	<p>序列化支持</p>
<ul>
<li>jackson(默认)</li>
<li>fastjson</li>
<li>Gson</li>
<li>ProtoBuf</li>
<li>自定义支持</li>
</ul>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    其中Json相关的序列化方式默认配置了日期格式为<code>yyyy-MM-dd HH:mm:ss</code>

</div>

<h2 id="序列化切换">序列化切换</h2>
<p>默认使用Jackson序列化，因此Restlight也默认引入了Jackson依赖，如果想要切换成别的序列化方式，则需要引入对应的Maven依赖并进行简单的配置。</p>
<p>Example：以切换Gson为例</p>
<ol>
<li>引入Gson依赖：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
     <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>com.google.code.gson<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
     <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>gson<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
     <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>2.8.5<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><ol start="2">
<li>注入Gson序列化器</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HttpBodySerializer</span> <span style="color:#000">bodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">GsonHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>完成切换。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    如果不想继续引入默认的Jackson依赖可以使用<code>&lt;exclusions/&gt;</code>标签排除， 同时一旦注入了自定义的序列化器原来默认的Jackson序列化器将不会再生效

</div>

<h2 id="序列化器">序列化器</h2>
<p><strong>接口标准定义</strong></p>
<ul>
<li><code>HttpRequestSerializer</code>： 用于请求的反序列化。</li>
<li><code>HttpResponseSerializer</code>： 用于响应的序列化。</li>
<li><code>HttpBodySerializer</code>： 继承自<code>HttpRequestSerializer</code>以及<code>HttpResponseSerializer</code>, 可同时提供请求与响应的序列化功能。</li>
</ul>
<p><strong>内置的序列化器</strong></p>
<ul>
<li><code>FastJsonHttpBodySerializer</code></li>
<li><code>JacksonHttpBodySerializer</code></li>
<li><code>GsonHttpBodySerializer</code></li>
<li><code>ProtoBufHttpBodySerializer</code></li>
</ul>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    切换时引入Maven依赖并注入对应的序列化器即可

</div>

<h2 id="定制序列化器">定制序列化器</h2>
<p>可以选择通过继承或者自定义实现<code>HttpRequestSerializer</code>以及<code>HttpResponseSerializer</code>接口（或者<code>HttpResponseSerializer</code>同理）的方式实现定制序列化。</p>
<p>如，在上面的例子中我们切换序列化方式为jackson，此时我们想定制序列化的日期格式为<code>yyyy-MM-dd</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HttpBodySerializer</span> <span style="color:#000">bodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">ObjectMapper</span> <span style="color:#000">objectMapper</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ObjectMapper</span><span style="color:#ce5c00;font-weight:bold">();</span>
    <span style="color:#000">objectMapper</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setDateFormat</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">SimpleDateFormat</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;yyyy-MM-dd&#34;</span><span style="color:#ce5c00;font-weight:bold">));</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">HttpJsonBodySerializerAdapter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">JacksonSerializer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">objectMapper</span><span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">{};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>同样也可以定制更多的序列化选项。</p>
<h2 id="多个序列化器并存">多个序列化器并存</h2>
<p>Restlight并不像Spring MVC一样要求一个应用中只能使用一种序列化方式，Restlight允许多种序列化方式并存。</p>
<p>实际的服务中我们可能有这样的需求：我们对接服务A时使用的是ProtoBuf序列化，而其他情况都是使用的fastjson序列化。</p>
<p>配置如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HttpBodySerializer</span> <span style="color:#000">fastjsonBodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">FastJsonHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">();</span>
 
<span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HttpBodySerializer</span> <span style="color:#000">protoBufBodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ProtoBufHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>直接注入两个序列化器即可。</p>
<p>上面的配置当MediaType（请求对应<code>ContentType</code>, 响应对应<code>Accept</code>）为<code>application/json</code>时使用JSON序列化,  为<code>application/x-protobuf</code>时使用ProtoBuf序列化.</p>
<h2 id="兼容spring-boot标准">兼容Spring Boot标准</h2>
<p>使用Spring Boot时，经常在配置文件里面添加Jackson和Gson的配置，如：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">spring.jackson.date-format=yyyy-MM-dd HH:mm:ss
spring.gson.date-format=yyyy-MM-dd HH:mm:ss
</code></pre><p>Restlight同样支持该标准，其作用逻辑如下图所示：
<img src="../../../img/serialization_of_springboot.png" alt="序列化器兼容springboot逻辑图.png">
如图所示，配置文件中Jackson和Gson相关内容要想生效，需要满足如下条件：</p>
<blockquote>
<ol>
<li>用户没有手动定制HttpJsonBodySerializerAdapter</li>
<li>用户没有手动注入Jackson或者Gson序列化器(FastJsonHttpBodySerializer和GsonJsonHttpBodySerializer)</li>
<li>用户没有手动注入ObjectMapper或者Gson对象</li>
<li>配置文件有对Jackson和Gson进行配置</li>
</ol>
</blockquote>
<p>满足以上四个条件，配置文件中关于Jackson和Gson的配置，才会在对应的Jackson和Gson序列化器中生效。</p>
<h3 id="响应序列化内容协商json与protobuf序列化">响应序列化内容协商(Json与ProtoBuf序列化)</h3>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    前提： json和ProtoBuf的序列化器已经被正确的配置。

</div>

<p>当 json和ProtoBuf的序列化器同时存在时， 响应序列化方式可以通过url中的参数来指定。</p>
<ul>
<li>首先开启序列化协商功能：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-pro" data-lang="pro"><span style="color:#4e9a06">#</span> <span style="color:#4e9a06">开启请求序列化协商</span>
<span style="color:#4e9a06">restlight</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">serialize</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">negotiation</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">true</span>
<span style="color:#4e9a06">#</span> <span style="color:#4e9a06">开启响应序列化协商</span>
<span style="color:#4e9a06">restlight</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">serialize</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">negotiation</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">true</span>
</code></pre></div><p>指定使用json序列化</p>
<p><strong>eg</strong>:  <code>/foo/{bar}?format=json</code></p>
<p>指定使用protobuf序列化</p>
<p><strong>eg</strong>:  <code>/foo/{bar}?format=pb</code></p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    参数可选值：<code>json</code>, <code>pb</code>

</div>

<ul>
<li>当参数<code>format</code>与应用自身的某些接口中的参数冲突时可以通过配置修改参数名称</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-pro" data-lang="pro"><span style="color:#4e9a06">restlight</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">serialize</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">negotiation</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#4e9a06">param</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">your</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#4e9a06">param</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#4e9a06">name</span>
<span style="color:#4e9a06">restlight</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">serialize</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#4e9a06">negotiation</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#4e9a06">param</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">your</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#4e9a06">param</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#4e9a06">name</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    此种方式实际上相当于在请求的<code>Accept</code>字段中加入了<code>application/json</code>, <code>application/x-protobuf</code>值， 因此如果使用了自定义的序列化器，根据<code>HttpResponseSerializer.supportsWrite(MediaType mediaType, Type type)</code>方法实现不同可能与实际行为不符。 具体请参考下文<code>多个序列化器框架如何选择使用哪个序列化器实现</code>章节。

</div>

<h2 id="使用requestserializer指定请求序列化器">使用<code>@RequestSerializer</code>指定请求序列化器</h2>
<p>当配置了多个序列化器时， 可以使用<code>@RequestSerializer</code>中指定使用某个固定的序列化方式</p>
<p>下面的Controller指定使用Jackson反序列化请求数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@PostMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestBody</span> <span style="color:#5c35cc;font-weight:bold">@RequestSerializer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">JacksonHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">User</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    <code>@RequestSerializer</code>可以在Prameter, Method以及Class上使用， 优先级依次递减。

</div>

<h2 id="使用responseserializer指定响应序列化器">使用<code>@ResponseSerializer</code>指定响应序列化器</h2>
<p>当配置了多个序列化器时， 可以使用<code>@ResponseSerializer</code>中指定使用某个固定的序列化方式</p>
<p>下面的Controller指定使用Jackson序列化响应结果</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@PostMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@ResponseSerializer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">JacksonHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Foo</span> <span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Foo</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    <code>@ResponseSerializer</code>可以在Method以及Class上使用， 优先级依次递减。

</div>

<h2 id="使用serializer指定请求--响应序列化器">使用<code>@Serializer</code>指定请求 &amp; 响应序列化器</h2>
<p>当配置了多个序列化器时， 可以使用<code>@Serializer</code>中指定使用某个固定的序列化方式， 相当于同时指定<code>RequestSerializer</code>以及<code>@ResponseSerializer</code>。</p>
<p>下面的Controller指定使用Jackson序列化</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@PostMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Serializer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">JacksonHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Foo</span> <span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestBody</span> <span style="color:#000">User</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Foo</span><span style="color:#ce5c00;font-weight:bold">();</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    <code>@ResponseSerializer</code>可以在Method以及Class上使用， 优先级依次递减。

</div>

<h2 id="多个序列化器框架如何选择使用哪个序列化器实现">多个序列化器框架如何选择使用哪个序列化器实现？</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">HttpRequestSerializer</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Deserialize the data from byte array to the object.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param entity entity
</span><span style="color:#8f5902;font-style:italic">     * @param &lt;T&gt;    generic type
</span><span style="color:#8f5902;font-style:italic">     * @return handled value
</span><span style="color:#8f5902;font-style:italic">     * @throws Exception any exception
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">HandledValue</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">deserialize</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestEntity</span> <span style="color:#000">entity</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>如上，在进行序列化之前首先判断当前序列化器是否支持给定的<code>RequestEntity</code>，如果为<code>false</code>则直接返回<code>HandledValue.failed()</code>，否则返回反序列化后的结果。</p>
<p>同样<code>HttpResponseSerializer</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">HttpResponseSerializer</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Ordered</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Serialize the object to byte array.
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param entity response entity
</span><span style="color:#8f5902;font-style:italic">     * @return handled value
</span><span style="color:#8f5902;font-style:italic">     * @throws Exception any exception
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#000">HandledValue</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]&gt;</span> <span style="color:#000">serialize</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ResponseEntity</span> <span style="color:#000">entity</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>序列化器实现本身具有优先级由<code>getOrder()</code>表示(值越低优先级越高)</p>
</blockquote>
<p>当最终无法找到匹配的序列化器时， 会通过默认的优先级进行序列化（暂时仅响应序列化为此行为）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HttpBodySerializer</span> <span style="color:#000">fastjsonBodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">FastJsonHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
       <span style="color:#5c35cc;font-weight:bold">@Override</span>
       <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
           <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">;</span>
       <span style="color:#ce5c00;font-weight:bold">}</span>
   <span style="color:#ce5c00;font-weight:bold">};</span>
 
<span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">HttpBodySerializer</span> <span style="color:#000">protoBufBodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ProtoBufHttpBodySerializer</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#5c35cc;font-weight:bold">@Override</span>
        <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getOrder</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
   
</code></pre></div><h2 id="多种序列化并存时的优先级">多种序列化并存时的优先级</h2>
<ul>
<li>请求序列化</li>
</ul>
<ol>
<li>如果指定了<code>@RequestSerializer</code>或者<code>@Serializer</code>中指定的序列化方式则使用该序列化方式</li>
<li>使用序列化协商中的参数指定的序列化器</li>
<li>根据<code>ContentType</code>查找序列化器</li>
<li>未找到则报错</li>
</ol>
<ul>
<li>响应序列化</li>
</ul>
<ol>
<li>如果指定了<code>@ResponseSerializer</code>或者<code>@Serializer</code>中指定的序列化方式则使用该序列化方式</li>
<li>使用序列化协商中的参数指定的序列化器</li>
<li>根据<code>Accept</code>查找序列化器</li>
<li>根据<code>RequestMapping</code>中produces指定的序列化器（未找到进入6）</li>
<li>未找到使用默认优先级最高的序列化器</li>
</ol>
<h2 id="protobuf序列化支持">ProtoBuf序列化支持</h2>
<p>Restlight内置了ProtoBuf序列化器的实现，对应支持的MediaType为<code>application/x-protobuf</code>(需要请求的<code>Content-Type</code>为<code>application/x-protobuf</code></p>
<p>同时使用ProtoBuf序列化器序列化后的响应结果的<code>Content-Type</code>也为<code>application/x-protobuf</code>)。</p>
<p>针对ProtoBuf序列化的特点，ProtoBuf序列化后还将增加Header， <code>X-Protobuf-Schema</code>和<code>X-Protobuf-Message</code>分别返回Message对象的<code>getDescriptorForType().getFile().getName()</code>和<code>getDescriptorForType().getFullName</code>的结果。</p>
<h2 id="特殊类型返回值的序列化">特殊类型返回值的序列化</h2>
<p>不管Controller上是否加有<code>@ResponseBody</code>注解， 在使用序列化器序列化之前都将遵守以下原则</p>
<blockquote>
<ul>
<li>值为String类型直接返回该字符串结果。</li>
<li>值为byte[]类型直接将结果写入响应。</li>
<li>值为ByteBuf类型时直接将结果写入响应</li>
<li>以上均不符合则使用序列化器进行序列化。</li>
<li>如果Controlelr上未配置<code>@ResponseBody</code>，值为基本类型或基本类型包装类将返回该类型的字符串结果（调用String.valueOf()）。</li>
<li>以上均不符合则抛异常。</li>
</ul>
</blockquote>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f98524641db12d9f69bc3a63ee6f4649">13 - 请求参数聚合</h1>
    <div class="lead">支持将请求的参数聚合到Bean中</div>
	<p>eg.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/test&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestBean</span> <span style="color:#000">Pojo</span> <span style="color:#000">Pojo</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Pojo</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@QueryParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@HeaderParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">String</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">AsyncRequest</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">AsyncResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getId</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">//getter &amp; setter
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    由于<code>SpringMVC</code>的注解大多不支持在<code>Field</code>上使用， 因此仅支持<code>JAX-RS</code>注解以及自定义参数解析等场景。

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-15adb1f15406c89ddc0f504afb67714b">14 - URL参数聚合</h1>
    <div class="lead">支持将Url中的参数与Form表单中的参数（仅当<code>Content-Type</code>为<code>application/x-www-form-urlencoded</code>时有效）聚合到Bean中。</div>
	<p>eg：</p>
<p>请求 <code>/test?id=1&amp;msg=hello</code> 中的id和message的值将绑定到pojo参数中</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/test&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">handle</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@QueryBean</span> <span style="color:#000">Pojo</span> <span style="color:#000">Pojo</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Pojo</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@QueryBean.Name</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;msg&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">String</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">getId</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">//getter &amp; setter
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    加了@QueryBean.Name(&ldquo;name&rdquo;)之后将使用提供的name作为参数名进行匹配， 原来的字段名字将不会使用

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8491f86999f6b7591eee11761502c1a0">15 - Context Path</h1>
    
	<p>Restlight支持全局Path，使用时需要做如下配置：</p>
<pre tabindex="0"><code class="language-profile" data-lang="profile">restlight.server.context-path=/global-path/
</code></pre><p>原始Controller方法为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Controller</span>
<span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/restlight/employee/&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">EmployeeController</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/list&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#5c35cc;font-weight:bold">@ResponseBody</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Employee</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">listAll</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Employee</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">employeeList</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ArrayList</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;(</span><span style="color:#000">16</span><span style="color:#ce5c00;font-weight:bold">);</span>

        <span style="color:#000">employeeList</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Employee</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;LiMing&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">25</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;1403063&#34;</span><span style="color:#ce5c00;font-weight:bold">));</span>
        <span style="color:#000">employeeList</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Employee</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;LiSi&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">36</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;1403064&#34;</span><span style="color:#ce5c00;font-weight:bold">));</span>
        <span style="color:#000">employeeList</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Employee</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;WangWu&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">31</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;1403065&#34;</span><span style="color:#ce5c00;font-weight:bold">));</span>

        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">employeeList</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>使用全局Path后的请求路径为：<strong>/global-path/restlight/employee/list</strong></p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    健康检查对应的请求路径不受全局Path影响

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2d62b7aa8e1eca9bf6a0801bc5f14074">16 - Aware扩展</h1>
    
	<p>在<code>Spring</code>场景，<code>Restlight</code>支持通过<code>xxxAware</code>接口获取一些内部对象。</p>
<p>其中包含</p>
<ul>
<li><code>RestlightBizExecutorAware</code>: 获取业务线程池</li>
<li><code>RestlightIoExecutorAware</code>: 获取IO线程池</li>
<li><code>RestlightServerAware</code>: 获取<code>RestlightServer</code></li>
<li><code>RestlightDeployContextAware</code>: 获取<code>DeployContext</code></li>
</ul>
<p>eg.</p>
<p>获取业务线程池</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Controller</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">HelloController</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">RestlightBizExecutorAware</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Executor</span> <span style="color:#000">bizExecutor</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">setRestlightBizExecutor</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Executor</span> <span style="color:#000">bizExecutor</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">bizExecutor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bizExecutor</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>


    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">CompletionStage</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">CompletableFuture</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">supplyAsync</span><span style="color:#ce5c00;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#4e9a06">&#34;Hello Restlight!&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">bizExecutor</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-96c4371ff98f8a260892c1b9f27ee09b">17 - 路由缓存</h1>
    
	<h2 id="spring-mvc路由的痛点">Spring MVC路由的痛点</h2>
<p>传统的Spring MVC中， 当我们的<code>@RequestMapping</code>注解中包含了复杂任何的复杂匹配逻辑（这里的复杂逻辑可以理解为除了一个url对应一个controller实现，并且url中没有*, ? . {foo}等模式匹配的内容）时方能在路由阶段有相对较好的效果，反之如通常情况下一个请求的到来到路由到对应的controller实现这个过程将会是在当前应用中的<strong>所有</strong>Controller中遍历匹配，值得注意的是通常在微服务提倡RestFul设计的大环境下一个这种遍历几乎是无法避免的， 同时由于匹配的条件本身的复杂性（比如说正则本身为人诟病的就是性能），因此伴随而来的则是SpringMVC的路由的损耗非常的大。</p>
<h2 id="restlight路由缓存">Restlight路由缓存</h2>
<h3 id="设计原则">设计原则</h3>
<ul>
<li>二八原则（80%的业务由20%的接口处理）</li>
<li>算法：类LFU(Least Frequently Used)算法</li>
</ul>
<p>我们虽然不能改变路由条件匹配本身的损耗， 但是我们希望能做尽量少的匹配次数来达到优化的效果。因此采用常用的&quot;缓存&quot;来作为优化的手段。
当开启了路由缓存后，默认情况下将使用类LFU(Least Frequently Used)算法的方式缓存十分之的Controller，根据二八原则（80%的业务由20%的接口处理），大部分的请求都将在缓存中匹配成功并返回（这里框架默认的缓存十分之一，是相对比较保守的设置）</p>
<h3 id="算法逻辑">算法逻辑</h3>
<p>当每次请求匹配成功时，会进行命中纪录的加1操作，并统计命中纪录最高的20%（可配）的Controller加入缓存， 每次请求的到来都将先从缓存中查找匹配的Controller（大部分的请求都将在此阶段返回）， 失败则进入正常匹配的逻辑。</p>
<p>什么时候更新缓存？ 我们不会在每次请求命中的情况下都去更新缓存，因为这涉及到一次排序（或者m次遍历， m为需要缓存的Controller的个数，相当于挑选出命中最高的m个controller）。 取而代之的是我们会以概率的方式去重新计算并更新缓存， 根据2-8原则通常情况下我们当前缓存的内存就是我们需要的内容， 所以没必要每次有请求命中都去重新计算并更新缓存， 因此我们会在请求命中的一定概率条件下采取做此操作（默认0.1%， 称之为计算概率）， 减小了并发损耗（这段逻辑本身基于CopyOnWrite， 并且为纯无锁并发编程，本身性能损耗就很低），同时此概率可配置可以根据具体的应用实际情况调整配置达到最优的效果。</p>
<h3 id="配置建议">配置建议</h3>
<p>缓存比例：请求集中化比较高则设置更小（比如集中在1%的Controller上则可以设置为缓存1%）
计算率： 理论上设置的越高实时性越强（缓存更新频率越高）但是并发损耗也会升高，因此建议设置的相对小一些以应对激增的非常用请求即可。</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    除极端情况下通常来说此缓存效果都会比原生的遍历实现要高效（这里指的是请求在Controller上的分布完全均匀）， 通常都能达到2-5倍的提升。

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4b2ddfd87c9683a4228d4a7f607fad08">18 - 快速失败</h1>
    
	<p>Restlight 支持根据请求任务的排队时间快速失败。具体地，从接收到首字节（TTFB）或请求任务进入线程池开始排队时开始计时，
如果请求任务真正执行时的时间与起始时间的差值大于指定值（timeout），那么直接结束当前请求（返回500）。</p>
<p>使用时，需要配置timeout与起始时间（首字节时间或者开始排队时间，默认后者），示例如下：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">restlight.server.scheduling.timeout.BIZ.type=QUEUED
restlight.server.scheduling.timeout.BIZ.time-millis=30

restlight.server.scheduling.timeout.IO.type=TTFB
restlight.server.scheduling.timeout.IO.time-millis=30
</code></pre><p>其中，<code>BIZ</code>和<code>IO</code>为Scheduler的名称，<code>type</code>为开始计时的方式，默认为<code>QUEUED</code>，
表示从请求任务进入线程池排队时开始计时，<code>TTFB</code>表示从接收到首字节时开始计时，<code>time-millis</code>
表示超时时间。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-00806bebd264f4ab6a8752deb8fde3f3">19 - Mock测试</h1>
    
	<p>同Spring MVC一样，Restlight也提供了单元测试的功能，用于构造请求并将请求映射到对应的Handler，得到Handler的执行结果并测试。如果您对Spring-Test不熟悉，请参考<a href="https://docs.spring.io/spring/docs/5.1.3.RELEASE/spring-framework-reference/testing.html#testing">Spring-Testing</a>。由于Restlight与Spring-web天生存在冲突，因此MockMvc的使用方式与Spring Mvc的略有差异，详情如下文所示。需要注意的是：</p>
<ul>
<li>使用MockMvc及MockMvcBuilders时请正确引入restlight包下的，而不是spring-web测试包下的。</li>
<li>由于Restlight暂不支持RestTemplate，因此与该功能有关的测试同样暂不支持，如@AutoConfigureWebClient、@WebMvcTest等。</li>
</ul>
<p>使用该功能需要额外引入如下依赖：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">
<span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;scope&gt;</span>test<span style="color:#204a87;font-weight:bold">&lt;/scope&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${spring.boot.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>

<span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>io.esastack<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>restlight-test-starter<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;scope&gt;</span>test<span style="color:#204a87;font-weight:bold">&lt;/scope&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>${restlight.version}<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><h2 id="1-通过context构造测试环境">1. 通过Context构造测试环境</h2>
<p>该方式与Spring Mvc测试方式几乎无差异，需要注意的是：正确引入restlight包下的MockMvc及MockMvcBuilders。示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RunWith</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">SpringRunner</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@SpringBootTest</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">BootstrapWithContextTest</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">ApplicationContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">MockMvc</span> <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@Before</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">setUp</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MockMvcBuilders</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">contextSetup</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Test</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testListAll</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">perform</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MockHttpRequest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">aMockRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">withUri</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/demo1/list&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertTrue</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">entity</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">()))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertEquals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">status</span><span style="color:#ce5c00;font-weight:bold">()));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Test</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testListAll2</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">perform</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MockHttpRequest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">aMockRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">withUri</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/demo2/list&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertTrue</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">entity</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">()))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertEquals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">status</span><span style="color:#ce5c00;font-weight:bold">()));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="2-通过controller列表构造测试环境">2. 通过Controller列表构造测试环境</h2>
<p>该方式与Spring Mvc测试方式几乎无差异，需要注意的是：正确引入restlight包下的MockMvc及MockMvcBuilders。示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RunWith</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">SpringRunner</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@SpringBootTest</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">BootstrapWithSingletonTest</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">DemoController1</span> <span style="color:#000">demoController1</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">DemoController2</span> <span style="color:#000">demoController2</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">MockMvc</span> <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@Before</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">setUp</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MockMvcBuilders</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">standaloneSetup</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">demoController1</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">demoController2</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">();</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Test</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testListAll</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">perform</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MockHttpRequest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">aMockRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">withUri</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/demo1/list&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertTrue</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">entity</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">()))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertEquals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">status</span><span style="color:#ce5c00;font-weight:bold">()));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Test</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testListAll2</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">perform</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MockHttpRequest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">aMockRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">withUri</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/demo2/list&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertTrue</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">entity</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">()))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertEquals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">status</span><span style="color:#ce5c00;font-weight:bold">()));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="3-自动注入mockmvc">3. 自动注入MockMvc</h2>
<p>该方式与Spring Mvc测试方式几乎无差异，需要注意的是：正确引入restlight包下的MockMvc。示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RunWith</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">SpringRunner</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@SpringBootTest</span>
<span style="color:#5c35cc;font-weight:bold">@AutoConfigureMockMvc</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">MockMvcAutowiredTest</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">MockMvc</span> <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@Test</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testListAll</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">perform</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MockHttpRequest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">aMockRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">withUri</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/demo1/list&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertTrue</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">entity</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">()))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertEquals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">status</span><span style="color:#ce5c00;font-weight:bold">()));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#5c35cc;font-weight:bold">@Test</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testListAll2</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">perform</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MockHttpRequest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">aMockRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">withUri</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/demo2/list&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertTrue</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">entity</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">()))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertEquals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">status</span><span style="color:#ce5c00;font-weight:bold">()));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

</code></pre></div><h2 id="4-异步方法测试">4. 异步方法测试</h2>
<p>与同步方法不同，如果原始Controller为异步方法，执行完perform()方法后直接对执行结果进行判断不会得到预期结果，因为原始Controller并未执行完，响应内容也尚未写入。因此如果原始Controller方法为异步，Restlight在执行完perform()方法后会阻塞等待异步方法执行完成，而后继续执行用户自定义的判断逻辑，使用时可以通过MockAsyncRequest的asynTimeout属性设置阻塞等待的时间（默认为-1）。</p>
<p>使用示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RunWith</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">SpringRunner</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@SpringBootTest</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">classes</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RestlightDemoApplication</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@AutoConfigureMockMvc</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AsyncDemoControllerTest</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">MockMvc</span> <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#5c35cc;font-weight:bold">@Test</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testListAll</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">mockMvc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">perform</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MockHttpRequest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">aMockRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">withUri</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/async/list&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">())</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertTrue</span><span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">entity</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">()))</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addExpect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">assertEquals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">200</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">response</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">status</span><span style="color:#ce5c00;font-weight:bold">()));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8bbf607bf55ab234484ca9e6f4ca15c4">20 - 辅助配置</h1>
    
	<p><code>SpringBoot</code>场景下大多数的配置可通过<code>application.properties</code>（或者yaml）配置文件即可完成配置，但是配置文件配置还是会有其缺陷</p>
<ul>
<li>无法动态配置（这里的动态指的是通过代码计算等方式决定配置）</li>
<li>语法表达能力有限（比如<code>ChannelOption</code>无法通过配置文件表达）</li>
<li>配置过多变得冗杂</li>
</ul>
<p>等问题。</p>
<h2 id="restlightconfigure"><code>RestlightConfigure</code></h2>
<p>用于支持<code>SpringBoot</code>场景显式配置</p>
<p>eg.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Bean</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">RestlightConfigure</span> <span style="color:#000">configure</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">restlight</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">restlight</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">address</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">8081</span><span style="color:#ce5c00;font-weight:bold">)</span>
            <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">childOption</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ChannelOption</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">TCP_NODELAY</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">)</span>
            <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">channelHandler</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">LoggingHandler</span><span style="color:#ce5c00;font-weight:bold">())</span>
            <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">deployments</span><span style="color:#ce5c00;font-weight:bold">()</span>
            <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addFilter</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">chain</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">doFilter</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#ce5c00;font-weight:bold">})</span>
            <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addHandlerInterceptor</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">HandlerInterceptor</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#5c35cc;font-weight:bold">@Override</span>
                <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">preHandle</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RequestContext</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Object</span> <span style="color:#000">handler</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                    <span style="color:#8f5902;font-style:italic">// biz logic
</span><span style="color:#8f5902;font-style:italic"></span>                    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
                <span style="color:#ce5c00;font-weight:bold">}</span>
            <span style="color:#ce5c00;font-weight:bold">});</span>
            <span style="color:#000">restlight</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">options</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">setBizThreads</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">BizThreadsOptionsConfigure</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">newOpts</span><span style="color:#ce5c00;font-weight:bold">()</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">core</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">16</span><span style="color:#ce5c00;font-weight:bold">)</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">max</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">32</span><span style="color:#ce5c00;font-weight:bold">)</span>
                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">configured</span><span style="color:#ce5c00;font-weight:bold">());</span>
                    <span style="color:#8f5902;font-style:italic">// more...
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#ce5c00;font-weight:bold">};</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b2dc3803615c85a9c04d46f40ac36997">21 - 配置一览</h1>
    
	<h2 id="server相关配置">Server相关配置</h2>
<p>所有配置均以<code>restlight.server</code>开头, 基于properties的配置（yml以此类推）</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>默认</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>host</td>
<td>0.0.0.0</td>
<td>服务绑定的ip</td>
</tr>
<tr>
<td>port</td>
<td>8080</td>
<td>服务绑定的端口</td>
</tr>
<tr>
<td>unix-domain-socket-file</td>
<td></td>
<td>不为空则使用Unix Domain Socket绑定到此文件(优先级高于ip:port的方式）</td>
</tr>
<tr>
<td>use-native-transports</td>
<td>Linux环境下为true其余为false</td>
<td>是否使用原生epoll支持, 否则使用NIO的selector</td>
</tr>
<tr>
<td>connector-threads</td>
<td>1</td>
<td>连接线程池大小</td>
</tr>
<tr>
<td>io-threads</td>
<td>cpu*2（默认不超过64）</td>
<td>IO线程池大小</td>
</tr>
<tr>
<td>biz-termination-timeout-seconds</td>
<td>60</td>
<td>优雅停机等待超时时间</td>
</tr>
<tr>
<td>http2-enable</td>
<td>false</td>
<td>是否开启Http2</td>
</tr>
<tr>
<td>compress</td>
<td>false</td>
<td>是否启用HTTP响应压缩</td>
</tr>
<tr>
<td>decompress</td>
<td>false</td>
<td>是否启用HTTP请求解压</td>
</tr>
<tr>
<td>max-content-length</td>
<td>4 * 1024 * 1024</td>
<td>最大contentLength限制(b)</td>
</tr>
<tr>
<td>max-initial-line-length</td>
<td>4096</td>
<td>最大request line限制(b)</td>
</tr>
<tr>
<td>max-header-size</td>
<td>8192</td>
<td>最大header size限制(b)</td>
</tr>
<tr>
<td>route.use-cached-routing</td>
<td>true</td>
<td>开启路由缓存</td>
</tr>
<tr>
<td>route.compute-rate</td>
<td>1</td>
<td>路由计算率，取值范围0-1000，固定的概率之下更新路由</td>
</tr>
<tr>
<td>warm-up.enable</td>
<td>false</td>
<td>是否开启服务预热功能</td>
</tr>
<tr>
<td>warm-up.delay</td>
<td>0</td>
<td>服务延迟暴露时间（单位：毫秒）</td>
</tr>
<tr>
<td>keep-alive-enable</td>
<td>true</td>
<td>false服务器将强制只支持短链接</td>
</tr>
<tr>
<td>soBacklog</td>
<td>128</td>
<td>对应netty的ChannelOption.SO_BACKLOG</td>
</tr>
<tr>
<td>write-buffer-high-water-mark</td>
<td>-1</td>
<td>netty中channel的高水位值</td>
</tr>
<tr>
<td>write-buffer-low-water-mark</td>
<td>-1</td>
<td>netty中channel的低水位值</td>
</tr>
<tr>
<td>idle-time-seconds</td>
<td>60</td>
<td>连接超时时间</td>
</tr>
<tr>
<td>logging</td>
<td></td>
<td>设置LoggingHandler用于打印连接及读写信息</td>
</tr>
</tbody>
</table>
<h2 id="核心功能配置">核心功能配置</h2>
<p>所有配置均以<code>restlight.server</code>开头, 基于properties的配置（yml以此类推）</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>默认</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>context-path</td>
<td></td>
<td>全局path前缀</td>
</tr>
<tr>
<td>biz-threads.core</td>
<td>cpu*4（默认在64-128之间）</td>
<td>业务线程池核心线程数</td>
</tr>
<tr>
<td>biz-threads.max</td>
<td>cpu*6（默认在128-256之间）</td>
<td>业务线程池最大线程数</td>
</tr>
<tr>
<td>biz-threads.blocking-queue-length</td>
<td>512</td>
<td>业务线程池阻塞队列大小</td>
</tr>
<tr>
<td>biz-threads.keep-alive-time-seconds</td>
<td>180</td>
<td>业务线程池keepAliveTime 单位：秒</td>
</tr>
<tr>
<td>serialize.request.negotiation</td>
<td>false</td>
<td>请求序列化协商</td>
</tr>
<tr>
<td>serialize.request.negotiation-param</td>
<td>format</td>
<td>请求序列化协商参数名称</td>
</tr>
<tr>
<td>serialize.response.negotiation</td>
<td>false</td>
<td>响应序列化协商</td>
</tr>
<tr>
<td>serialize.response.negotiation-param</td>
<td>format</td>
<td>响应序列化协商参数名称</td>
</tr>
<tr>
<td>print-banner</td>
<td>true</td>
<td>是否启动打印logo</td>
</tr>
</tbody>
</table>
<h2 id="ssl配置">SSL配置</h2>
<p>所有配置均以<code>restlight.server.ssl</code>开头, 基于properties的配置（yml以此类推）</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>默认</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>enable</td>
<td>false</td>
<td>是否使用https</td>
</tr>
<tr>
<td>ciphers</td>
<td></td>
<td>支持的加密套件，不设置表示使用默认</td>
</tr>
<tr>
<td>enable-protocols</td>
<td></td>
<td>支持的加密协议，不设置表示使用默认</td>
</tr>
<tr>
<td>cert-chain-path</td>
<td></td>
<td>证书路径，https-enable为true时必须</td>
</tr>
<tr>
<td>key-path</td>
<td></td>
<td>私钥路径，https-enable为true时必须</td>
</tr>
<tr>
<td>key-password</td>
<td></td>
<td>私钥文件密钥（如果需要的话）</td>
</tr>
<tr>
<td>trust-certs-path</td>
<td></td>
<td>Trust Store</td>
</tr>
<tr>
<td>session-timeout</td>
<td></td>
<td>session过期时间, 0表示使用默认</td>
</tr>
<tr>
<td>session-cache-size</td>
<td></td>
<td>session缓存大小， 0表示使用默认</td>
</tr>
<tr>
<td>handshake-timeout-millis</td>
<td></td>
<td>SSL握手超时时间</td>
</tr>
<tr>
<td>client-auth</td>
<td></td>
<td>客户端认证类型，不设置默认无</td>
</tr>
</tbody>
</table>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Tip</h4>

    路径如果在classpath下请使用<code>classpath:conf/foo.pem</code>的形式

</div>


</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="mailto:esa.stack@oppo.com" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/esastack/esa-restlight" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="mailto:esa.stack@oppo.com" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 OPPO ESA Stack Project All Rights Reserved</small>
        
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>


















<script src="/js/main.min.7380160122c24d59789a168af05fcec445fe4e5f2069dd9f3a0c991f10269ae0.js" integrity="sha256-c4AWASLCTVl4mhaK8F/OxEX&#43;Tl8gad2fOgyZHxAmmuA=" crossorigin="anonymous"></script>






  </body>
</html>
